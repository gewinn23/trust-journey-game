<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é­”ç‹ã‚’å€’ã™å‰ã«ã€ã¾ãšãŠå‰ã‚’è¿½æ”¾ã™ã‚‹</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap');
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-anim { animation: fadeIn 0.3s ease-out forwards; }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .scan-line { 
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.05) 50%, rgba(255,255,255,0));
            background-size: 100% 4px;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 9999;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-screen overflow-hidden"></div>
    <div class="scan-line"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ ---
        const GAME_TEXTS = {
            TITLE: "é­”ç‹ã‚’å€’ã™å‰ã«ã€ã¾ãšãŠå‰ã‚’è¿½æ”¾ã™ã‚‹",
            STORY: [
                "é¥ã‹æ˜”ã€å¹³å’Œã ã£ãŸç‹å›½ã«é­”ç‹ã®å½±ãŒå¿ã³å¯„ã£ãŸã€‚",
                "å›½ç‹ã¯å„åœ°ã‹ã‚‰å‹‡çŒ›ãªæˆ¦å£«ãŸã¡ã‚’æ‹›é›†ã—ã€é­”ç‹è¨ä¼éšŠã‚’çµæˆã™ã‚‹ã€‚",
                "ã—ã‹ã—ã€ãã®ä¸­ã«ã¯é­”ç‹ã«é­‚ã‚’å£²ã£ãŸã€Œè£åˆ‡ã‚Šè€…ã€ãŒç´›ã‚Œè¾¼ã‚“ã§ã„ã‚‹ã¨ã®ã†ã‚ã•ãŒ....",
                "è£åˆ‡è€…ã‚’è¿½æ”¾ã—ã€ã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’é­”ç‹ã‚’è¨ä¼ã—ã‚ˆã†ï¼"
            ],
            NOTE: "â€»è·æ¥­ã”ã¨ã«ã‚¹ã‚­ãƒ«ãŒå­˜åœ¨ã—ã€è£åˆ‡è€…ã‚’ç™ºè¦‹ã™ã‚‹ã‚¹ã‚­ãƒ«ã‚„é­”ç‹è¨ä¼ã®éš›ã«æœ‰åŠ¹ãªã‚¹ã‚­ãƒ«ãªã©æ§˜ã€…ãªã‚‚ã®ãŒå­˜åœ¨ã¾ã™ã€‚"
        };

        // --- ç”»åƒã‚¢ã‚»ãƒƒãƒˆ ---
        const IMAGES = {
            BOSS: 'é­”ç‹.png',
            BOSS_NORMAL: 'é­”ç‹-é€šå¸¸æ”»æ’ƒ.jpg',
            BOSS_MAGIC: 'é­”ç‹-é­”æ³•æ”»æ’ƒ.jpg',
            BOSS_HELLFIRE: 'é­”ç‹-é—‡ã®ç„ç‚.jpg',
            BOSS_ROAR: 'é­”ç‹-é­”ç‹ã®å’†å“®.jpg',
            HEADER: 'ãƒ˜ãƒƒãƒ€ãƒ¼.png' 
        };

        // --- ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ ---
        const MONSTERS = {
            C: ['ã‚¹ãƒ©ã‚¤ãƒ ', 'ã‚´ãƒ–ãƒªãƒ³', 'ã‚³ãƒœãƒ«ãƒˆ', 'ã‚ªãƒ¼ã‚¯', 'ã‚´ãƒ¼ã‚¹ãƒˆ', 'ã¡ã³ãƒ‰ãƒ©ã‚´ãƒ³', 'ã‚¦ãƒ«ãƒ•', 'ãƒ¬ãƒƒãƒ‰ãƒ©ãƒ“ãƒƒãƒˆ', 'ãƒ›ãƒ¼ãƒãƒƒãƒˆ', 'ã‚¹ã‚±ãƒ«ãƒˆãƒ³', 'ã‚­ãƒ©ãƒ¼ã‚¢ãƒ³ãƒˆ'],
            B: ['ã‚ªãƒ¼ã‚¬', 'ãƒ¯ã‚¤ãƒˆ', 'ãƒªã‚¶ãƒ¼ãƒ‰', 'ã‚´ãƒ–ãƒªãƒ³ã‚½ãƒ«ã‚¸ãƒ£ãƒ¼', 'ã‚¢ãƒ³ãƒ‡ãƒƒãƒˆãƒ›ãƒ¼ã‚¹', 'ãƒˆãƒ­ãƒ¼ãƒ«', 'ã‚´ãƒ¼ãƒ¬ãƒ '],
            A: ['ãƒ¯ã‚¤ãƒãƒ¼ãƒ³', 'ã‚´ãƒ–ãƒªãƒ³ã‚­ãƒ³ã‚°', 'ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢', 'ãƒ–ãƒ©ãƒƒã‚¯ã‚¹ã‚³ãƒ¼ãƒ”ã‚ªãƒ³'],
            S: ['æ­»ç«œç‹ãƒãƒ«ãƒ€ã‚°', 'ä¸æ­»é³¥ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹']
        };

        // --- è·æ¥­ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
        const ROLES = {
            HERO: { 
                name: 'å‹‡è€…', atk: 3, hp: 4, def: 3, img: 'å‹‡è€….png',
                desc: 'æ”»å®ˆã¨ã‚‚ã«ç©´ã®ãªã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒç‰¹å¾´',
                uniqueSkill: { name: 'å‹‡è€…ã®è©¦ç·´', type: 'QUEST_ACTIVE', desc: 'ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ã€‘æ¬¡ã«é¸æŠã™ã‚‹ä»»æ„ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å¿…è¦äººæ•°ã«é–¢ä¿‚ãªãä¸€äººã§ã‚¯ãƒªã‚¢ã§ãã‚‹' },
                ultimateSkill: { name: 'è–ãªã‚‹æ–¬æ’ƒ', type: 'BOSS_ACTIVE', desc: 'ç”Ÿãæ®‹ã£ã¦ã„ã‚‹å‘³æ–¹é™£å–¶ã®äººæ•°Ã—10+è‡ªèº«ã®ATKã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹' }
            },
            WARRIOR: { 
                name: 'æˆ¦å£«', atk: 4, hp: 3, def: 2, img: 'æˆ¦å£«.png',
                desc: 'ãƒãƒ©ãƒ³ã‚¹ã®ã„ã„ã‚¢ã‚¿ãƒƒã‚«ãƒ¼',
                uniqueSkill: { name: 'æˆ¦å£«ã®è¨¼', type: 'PASSIVE', desc: 'ã€ãƒ‘ãƒƒã‚·ãƒ–ã€‘ã‚¯ã‚¨ã‚¹ãƒˆã‚’æˆåŠŸã™ã‚‹ãŸã³ã«ATKãŒ+1ã•ã‚Œã‚‹' },
                ultimateSkill: { name: 'æ¸¾èº«æ–¬ã‚Š', type: 'BOSS_ACTIVE', desc: 'é­”ç‹ã‚‚ã—ãã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ç¾åœ¨ã®ATKÃ—2ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹' }
            },
            MAGE: { 
                name: 'é­”æ³•ä½¿ã„', atk: 4, hp: 3, def: 1, img: 'é­”æ³•ä½¿ã„.png',
                desc: 'ç«åŠ›ãŒé«˜ã„é­”æ³•ã‚¢ã‚¿ãƒƒã‚«ãƒ¼',
                uniqueSkill: { name: 'é­”æ³•æ„ŸçŸ¥', type: 'QUEST_ACTIVE', desc: 'ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ã€‘é¸æŠã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è·æ¥­ã¨é™£å–¶ã‚’ç›—ã¿è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹' },
                ultimateSkill: { name: 'å¼·åŒ–é­”æ³•', type: 'BOSS_ACTIVE', desc: 'é¸æŠã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ATK+7 DEF+7 ã™ã‚‹' }
            },
            CLERIC: { 
                name: 'åƒ§ä¾¶', atk: 1, hp: 5, def: 2, img: 'åƒ§ä¾¶.png',
                desc: 'å›å¾©ãŒå¾—æ„ãªã‚µãƒãƒ¼ã‚¿ãƒ¼',
                uniqueSkill: { name: 'æ…ˆæ„›ã®æ‚Ÿã‚Š', type: 'QUEST_ACTIVE', desc: 'ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ã€‘é¸æŠã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¼·åˆ¶çš„ã«å‹‡è€…é™£å–¶ã¸ã¨å¤‰æ›´ã•ã›ã‚‹' },
                ultimateSkill: { name: 'å›å¾©é­”æ³•', type: 'BOSS_ACTIVE', desc: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨å“¡ã®HPã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°Ã—4å›å¾©ã•ã›ã‚‹' }
            },
            KNIGHT: { 
                name: 'é¨å£«', atk: 2, hp: 4, def: 4, img: 'é¨å£«.png',
                desc: 'è€ä¹…åŠ›ãŒé­…åŠ›ã®ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ãƒ€ãƒ¼',
                uniqueSkill: { name: 'å±ˆå¼·ãªè‚‰ä½“', type: 'PASSIVE', desc: 'ã€ãƒ‘ãƒƒã‚·ãƒ–ã€‘ã‚¯ã‚¨ã‚¹ãƒˆã«å‚åŠ æ™‚è‡ªèº«ãŒå—ã‘ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’1è»½æ¸›ã•ã›ã‚‹' },
                ultimateSkill: { name: 'ã‹ã°ã†', type: 'BOSS_ACTIVE', desc: 'ã“ã®ã‚¿ãƒ¼ãƒ³ä¸­ã€é­”ç‹ã‚‚ã—ãã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1åã‹ã‚‰ã®æ”»æ’ƒã‚’è‡ªåˆ†ã«é›†ä¸­ã•ã›ã‚‹' }
            },
            MONK: { 
                name: 'æ ¼é—˜å®¶', atk: 5, hp: 3, def: 0, img: 'æ­¦é—˜å®¶.png',
                desc: 'é«˜ç«åŠ›ã‚¢ã‚¿ãƒƒã‚«ãƒ¼ã€‚è€ä¹…åŠ›ãŒèª²é¡Œ',
                uniqueSkill: { name: 'å­¤ç‹¬ã®ä¿®è¡Œ', type: 'PASSIVE', desc: 'ã€ãƒ‘ãƒƒã‚·ãƒ–ã€‘ã‚¯ã‚¨ã‚¹ãƒˆã‚’è‡ªåˆ†ä¸€äººã§ã‚¯ãƒªã‚¢ã—ãŸã¨ãã€ä¸ŠãŒã‚‹ãƒ¬ãƒ™ãƒ«ã«+1ã•ã‚Œã‚‹' },
                ultimateSkill: { name: 'æ­£æ‹³çªã', type: 'BOSS_ACTIVE', desc: '1ã‚¿ãƒ¼ãƒ³ã®ãŸã‚ãŒå¿…è¦ã ãŒæ¬¡ã®ã‚¿ãƒ¼ãƒ³é­”ç‹ã‚‚ã—ãã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ç¾åœ¨ã®ATKÃ—4ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹æ”»æ’ƒã‚’è¡Œã†' }
            },
            THIEF: { 
                name: 'ç›—è³Š', atk: 3, hp: 3, def: 2, img: 'ç›—è³Š.png', 
                desc: 'ãƒˆãƒªãƒƒã‚­ãƒ¼ãªå‹•ãã§å ´ã‚’æ”ªä¹±ã™ã‚‹',
                uniqueSkill: { name: 'ç›—è³Šã®æ¥µæ„', type: 'QUEST_ACTIVE', desc: 'ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ã€‘æŒ‡å®šã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨é™£å–¶ã‚’å…¥ã‚Œæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã‚‹' },
                ultimateSkill: { name: 'æ€¥æ‰€ä¸€é–ƒ', type: 'BOSS_ACTIVE', desc: 'é­”ç‹ã®æœ€å¤§HPã®1/5ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ãŸå ´åˆã¯ATKÃ—5ãƒ€ãƒ¡ãƒ¼ã‚¸' }
            },
            SPIRIT: {
                name: 'ç²¾éœŠä½¿ã„', atk: 2, hp: 5, def: 2, img: 'ç²¾éœŠä½¿ã„.png',
                desc: 'å¹³å‡çš„ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€‚ã‚¹ã‚­ãƒ«ã§å ´ã‚’åˆ¶å¾¡',
                uniqueSkill: { name: 'ç²¾éœŠã®èª“ã„', type: 'QUEST_ACTIVE', desc: 'ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ã€‘ã©ã®è·æ¥­ãŒä»Šå›ã®ã‚²ãƒ¼ãƒ ã§å‚åŠ ã—ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã‚‹(èª°ãŒã©ã®è·æ¥­ã‹ã¯ä¸æ˜)' },
                ultimateSkill: { name: 'ç²¾éœŠã®åŠ è­·', type: 'BOSS_ACTIVE', desc: 'ã“ã®ã‚¿ãƒ¼ãƒ³ã®é­”ç‹ã®æ”»æ’ƒã‚’é€šå¸¸æ”»æ’ƒã¸ã¨å¼·åˆ¶çš„ã«å¤‰æ›´ã•ã›ã‚‹' }
            },
            BARRIER_MASTER: {
                name: 'çµç•Œå¸«', atk: 2, hp: 3, def: 3, img: 'çµç•Œå¸«.png',
                desc: 'é‰„å£ã®å®ˆã‚Šã‚’æŒã¤ãŒæ”»æ’ƒã¯è‹¦æ‰‹',
                uniqueSkill: { name: 'çµç•Œå±•é–‹', type: 'QUEST_ACTIVE', desc: 'ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ã€‘é­”ç‹é™£å–¶ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®äººæ•°ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã‚‹' },
                ultimateSkill: { name: 'çµç•Œè¡“', type: 'BOSS_ACTIVE', desc: 'é­”ç‹ã‚‚ã—ãã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1åã®è¡Œå‹•ã‚’1ã‚¿ãƒ¼ãƒ³å°ã˜ã‚‹' }
            },
            PLAYBOY: {
                name: 'éŠã³äºº', atk: 2, hp: 3, def: 1, img: 'éŠã³äºº.png',
                desc: 'äºˆæ¸¬ä¸èƒ½ãªå‹•ãã§å ´ã‚’ã‹ãä¹±ã™',
                uniqueSkill: { name: 'ç§˜ã‚ãŸã‚‹ã¡ã‹ã‚‰', type: 'PASSIVE', desc: 'ã€ãƒ‘ãƒƒã‚·ãƒ–ã€‘ç‰¹å®šã®ãƒ¬ãƒ™ãƒ«ã‚’è¶…ãˆãŸå ´åˆè·æ¥­ãŒã€Œè³¢è€…ã€ã«é€²åŒ–(ãƒ—ãƒ¬ã‚¤äººæ•°Ã—2+2ãƒ¬ãƒ™ãƒ«ã§é€²åŒ–)' },
                ultimateSkill: { name: 'ã‚ãã¶', type: 'BOSS_ACTIVE', desc: 'ãªã«ã‚‚èµ·ã“ã‚‰ãªã„ã€‚' }
            },
            SAGE: {
                name: 'è³¢è€…', atk: 4, hp: 4, def: 2, img: 'è³¢è€….png',
                desc: 'åœ§å€’çš„ãªçŸ¥è­˜ã¨é­”åŠ›ã‚’æŒã¤ä¸Šç´šè·',
                uniqueSkill: { name: 'å¡æ™ºã®å®šå¼', type: 'PASSIVE', desc: 'ã€ãƒ‘ãƒƒã‚·ãƒ–ã€‘ã‚¯ã‚¨ã‚¹ãƒˆã‚’æˆåŠŸã™ã‚‹ãŸã³ã«HPã¨ATKãŒ+1ã•ã‚Œã‚‹' },
                ultimateSkill: { name: 'æ˜Ÿè¾°ã®å¯©åˆ¤', type: 'BOSS_ACTIVE', desc: 'é­”ç‹ã‚‚ã—ãã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å›ºå®š100ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆè‡ªèº«ã®HPã‚’20å›å¾©' }
            }
        };

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        const formatSkillDesc = (text) => {
            if (!text) return "";
            if (text.length <= 30) return text;
            const regex = new RegExp(`.{1,30}`, 'g');
            return text.match(regex).join('\n');
        };

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
        const RoleListModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-2" onClick={onClose}>
                    <div className="bg-slate-800 rounded-xl p-4 w-full max-w-5xl max-h-[95vh] overflow-y-auto border border-slate-600 modal-anim flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-2 flex-none">
                            <h2 className="text-xl font-bold text-yellow-400">è·æ¥­ä¸€è¦§</h2>
                            <button onClick={onClose} className="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-white font-bold">é–‰ã˜ã‚‹</button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2 overflow-y-auto flex-grow">
                            {Object.values(ROLES).map((role, idx) => (
                                <div key={idx} className="bg-slate-700 p-3 rounded flex gap-3 border border-slate-600 items-start">
                                    <div className="w-20 h-20 flex-none bg-slate-800 rounded overflow-hidden border border-slate-500">
                                        <img src={role.img} alt={role.name} className="w-full h-full object-cover pixel-art" onError={(e) => e.target.style.display = 'none'} />
                                    </div>
                                    <div className="flex-grow">
                                        <div className="flex justify-between font-bold text-white border-b border-slate-500 pb-1 mb-1">
                                            <span className="text-lg">{role.name}</span>
                                            <span className="text-sm text-blue-300 self-end">å‹‡è€…é™£å–¶</span>
                                        </div>
                                        <div className="grid grid-cols-3 text-center text-base mb-1">
                                            <div><span className="text-xs text-slate-400 block">HP</span>LvÃ—{role.hp}</div>
                                            <div><span className="text-xs text-slate-400 block">ATK</span>LvÃ—{role.atk}</div>
                                            <div><span className="text-xs text-slate-400 block">DEF</span>LvÃ—{role.def}</div>
                                        </div>
                                        <div className="text-sm text-slate-300 mb-2">{role.desc}</div>
                                        <div className="grid grid-cols-1 gap-1">
                                            <div className="bg-slate-800 p-2 rounded text-xs">
                                                <span className="text-yellow-400 font-bold block">å›ºæœ‰: {role.uniqueSkill.name}</span>
                                                <span className="block whitespace-pre-wrap break-words">{role.uniqueSkill.desc}</span>
                                            </div>
                                            <div className="bg-slate-800 p-2 rounded text-xs">
                                                <span className="text-red-400 font-bold block">å¿…æ®º: {role.ultimateSkill.name}</span>
                                                <span className="block whitespace-pre-wrap break-words">{role.ultimateSkill.desc}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const Popup = ({ title, message, type = 'info', onClose }) => (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                <div className={`bg-slate-800 border-2 rounded-xl p-6 max-w-md w-full text-center shadow-2xl modal-anim ${
                    type === 'danger' ? 'border-red-500' : type === 'success' ? 'border-green-500' : 'border-blue-500'
                }`}>
                    <h2 className={`text-2xl font-bold mb-4 ${
                        type === 'danger' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-300'
                    }`}>{title}</h2>
                    <p className="text-lg mb-6 whitespace-pre-wrap leading-relaxed">{message}</p>
                    <button onClick={onClose} className="bg-slate-600 hover:bg-slate-500 text-white px-8 py-3 rounded font-bold text-lg">
                        ç¢ºèª
                    </button>
                </div>
            </div>
        );

        const ChoicePopup = ({ title, message, choices, onClose }) => (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 border-2 border-yellow-500 rounded-xl p-6 max-w-md w-full text-center shadow-2xl modal-anim">
                    <h2 className="text-2xl font-bold mb-4 text-yellow-400">{title}</h2>
                    <p className="text-lg mb-6 whitespace-pre-wrap text-slate-200">{formatSkillDesc(message)}</p>
                    <div className="flex flex-col gap-3">
                        {choices.map((choice, idx) => (
                            <button 
                                key={idx} 
                                onClick={() => onClose(choice.value)}
                                className={`py-3 rounded-xl font-bold text-lg shadow-lg ${choice.className || 'bg-slate-600 text-white'}`}
                            >
                                {choice.label}
                            </button>
                        ))}
                        <button onClick={() => onClose(null)} className="mt-2 text-slate-400 hover:text-white underline text-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
            </div>
        );

        const HandoverScreen = ({ nextPlayerName, message = "ç”»é¢ã‚’æ¸¡ã—ã¦ãã ã•ã„", onOpen }) => (
            <div className="fixed inset-0 bg-slate-950 flex flex-col items-center justify-center z-40 text-center p-8">
                <div className="text-6xl mb-8 animate-bounce">ğŸ›‘</div>
                <h2 className="text-4xl font-bold text-yellow-500 mb-6">{message}</h2>
                <p className="text-2xl text-slate-300 mb-10">æ¬¡ã¯ <span className="font-bold text-white text-3xl">{nextPlayerName}</span> ã•ã‚“ã®ç•ªã§ã™</p>
                <button onClick={onOpen} className="bg-blue-600 hover:bg-blue-500 text-white px-16 py-6 rounded-full text-2xl font-bold shadow-lg border-2 border-blue-400">
                    æœ¬äººãŒç¢ºèªã—ãŸã‚‰æŠ¼ã™
                </button>
            </div>
        );

        const HPBar = ({ current, max, label = "HP", color = "green" }) => {
            const percentage = Math.max(0, Math.min(100, (current / max) * 100));
            const barColor = color === "red" ? "from-red-700 to-red-500" : "from-green-600 to-green-400";
            return (
                <div className="w-full">
                    {label && <div className="text-[10px] text-slate-400 mb-0.5">{label}</div>}
                    <div className="w-full bg-slate-900/50 rounded-full h-2 md:h-3 overflow-hidden border border-slate-600 relative">
                        <div 
                            className={`h-full bg-gradient-to-r ${barColor} transition-all duration-500 ease-out`}
                            style={{ width: `${percentage}%` }}
                        ></div>
                    </div>
                </div>
            );
        };

        const GameStatusHUD = ({ bossHP, bossMaxHP, players, turnOrder, turn, maxTurn, phase, activePlayerName, bossTurnCount, onOpenRoleList, onBackToTitle }) => {
            const orderedPlayers = turnOrder.length > 0 ? turnOrder.map(id => players.find(p => p.id === id)).filter(Boolean) : players;

            return (
                <div className="fixed top-0 left-0 w-full bg-slate-900/95 border-b border-slate-700 z-30 shadow-lg backdrop-blur-sm transition-all pb-1">
                    <div className="max-w-7xl mx-auto px-2 pt-1">
                        <div className="flex justify-between items-center mb-1 gap-2 h-8">
                            <div className="flex items-center gap-2 flex-grow max-w-md">
                                <span className="text-red-500 font-black text-xs whitespace-nowrap">é­”ç‹</span>
                                <div className="flex-grow h-3 bg-slate-800 rounded-full overflow-hidden border border-slate-600 relative">
                                    <div 
                                        className="h-full bg-gradient-to-r from-red-700 to-red-500 transition-all duration-500 ease-out" 
                                        style={{ width: `${bossMaxHP > 0 ? Math.max(0, Math.min(100, (bossHP / bossMaxHP) * 100)) : 0}%` }}
                                    ></div>
                                    <div className="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white drop-shadow leading-none">
                                        {bossHP}/{bossMaxHP}
                                    </div>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-1 text-[10px] text-slate-300">
                                <span className="bg-slate-800 px-1.5 py-0.5 rounded border border-slate-600">
                                    T {turn}/{maxTurn}
                                </span>
                                <span className="bg-slate-800 px-1.5 py-0.5 rounded border border-slate-600 font-bold text-blue-300">
                                    {phase.includes('BOSS') ? `é­”ç‹æˆ¦ R${bossTurnCount}` : phase === 'ACTION_SELECT' ? 'è¡Œå‹•é¸æŠ' : phase.replace('_', ' ')}
                                </span>
                                <span className="font-bold text-white bg-blue-900/80 px-2 py-0.5 rounded border border-blue-500 truncate max-w-[80px] text-center">
                                    {activePlayerName}
                                </span>
                            </div>
                        </div>
                        
                        <div className="flex items-stretch gap-1 overflow-x-auto pb-1 scrollbar-hide h-12">
                            {orderedPlayers.map((p) => (
                                <div key={p.id} className={`flex-none w-20 bg-slate-800 rounded border ${p.isDead ? 'border-red-900 opacity-60' : 'border-slate-600'} p-1 flex flex-col justify-center gap-0.5 relative`}>
                                    <div className="flex justify-between items-center leading-none px-0.5 relative z-10">
                                        <span className={`font-bold text-xs truncate flex-grow ${p.isDead ? 'text-red-500' : 'text-white'}`}>{p.name}</span>
                                        {p.isDead && <span className="text-[9px] text-red-500 font-black ml-0.5">â€ </span>}
                                    </div>
                                    <div className="relative z-10">
                                        <HPBar current={p.currentHp} max={p.maxHp} showText={false} label={null} />
                                    </div>
                                </div>
                            ))}
                            
                            <div className="ml-auto flex gap-1">
                                <button onClick={onOpenRoleList} className="bg-slate-700 hover:bg-slate-600 text-yellow-400 px-2 py-1 rounded text-[10px] font-bold border border-yellow-600 shadow-md h-full flex flex-col items-center justify-center w-10 leading-tight">
                                    <span className="text-sm">ğŸ“–</span>
                                    <span>è·</span>
                                </button>
                                <button onClick={onBackToTitle} className="bg-slate-800 hover:bg-red-900 text-slate-400 hover:text-white px-2 py-1 rounded text-[10px] font-bold border border-slate-600 shadow-md h-full flex flex-col items-center justify-center w-10 transition leading-tight">
                                    <span className="text-sm">ğŸ </span>
                                    <span>TOP</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª ---
        const App = () => {
            const [phase, setPhase] = useState('INTRO'); 
            const [turn, setTurn] = useState(1);
            const [maxTurn, setMaxTurn] = useState(8);
            const [playerCount, setPlayerCount] = useState(4);
            const [playerNames, setPlayerNames] = useState([]);
            const [players, setPlayers] = useState([]);
            const [turnOrder, setTurnOrder] = useState([]); 
            
            const [quests, setQuests] = useState([]);
            const [questResults, setQuestResults] = useState([]); 
            const [actionQueue, setActionQueue] = useState([]); 
            const [activePlayerId, setActivePlayerId] = useState(0);
            const [isHandover, setIsHandover] = useState(false);
            
            const [playerActions, setPlayerActions] = useState({});
            const [votes, setVotes] = useState({});
            const [exileResult, setExileResult] = useState(null);
            
            const [bossBattleActions, setBossBattleActions] = useState({});
            const [bossBattleLog, setBossBattleLog] = useState([]);
            const [bossInitialPlayerCount, setBossInitialPlayerCount] = useState(0);
            const [bossHP, setBossHP] = useState(0);
            const [bossMaxHP, setBossMaxHP] = useState(0);
            const [winner, setWinner] = useState(null);
            const [bossTurnCount, setBossTurnCount] = useState(1);
            const [bossNextAction, setBossNextAction] = useState(null); 
            const [roundDamageReport, setRoundDamageReport] = useState({});
            
            const [battleState, setBattleState] = useState({}); 

            const [popup, setPopup] = useState(null);
            const [choicePopup, setChoicePopup] = useState(null);
            const [timeLeft, setTimeLeft] = useState(180); 
            const [showRoleList, setShowRoleList] = useState(false);
            
            useEffect(() => {
                let timer;
                if ((phase === 'STRATEGY' || phase === 'VOTE_DISCUSS') && timeLeft > 0) {
                    timer = setInterval(() => setTimeLeft(t => t - 1), 1000);
                }
                return () => clearInterval(timer);
            }, [phase, timeLeft]);

            const selectPlayerCount = (count) => {
                setPlayerCount(count);
                setPlayerNames(prev => {
                    const newNames = Array(count).fill('');
                    for (let i = 0; i < count; i++) {
                        newNames[i] = prev[i] || `Player ${i + 1}`;
                    }
                    return newNames;
                });
                setPhase('NAME_ENTRY');
            };

            const handleBackToTitle = () => {
                setChoicePopup({
                    title: 'ç¢ºèª',
                    message: 'ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™ã€‚',
                    choices: [
                        { label: 'æˆ»ã‚‹', value: 'yes', className: 'bg-red-600 text-white' }
                    ],
                    onClose: (val) => {
                        setChoicePopup(null);
                        if(val === 'yes') {
                            setPhase('SETUP');
                            setTurn(1);
                            setBossHP(0);
                            setBossMaxHP(0);
                            setWinner(null);
                            setBossBattleLog([]);
                            setTurnOrder([]);
                            setPlayers([]);
                        }
                    }
                });
            };
            
            const handleBackToTitleForce = () => {
                setPhase('SETUP');
                setTurn(1);
                setBossHP(0);
                setBossMaxHP(0);
                setWinner(null);
                setBossBattleLog([]);
                setTurnOrder([]);
                setPlayers([]);
            };

            const startGame = () => {
                // åˆæœŸè·æ¥­ãƒªã‚¹ãƒˆã‹ã‚‰è³¢è€…ã‚’é™¤å¤–
                const availableRoles = Object.keys(ROLES).filter(key => key !== 'SAGE');
                let roleKeys = [...availableRoles];
                
                // äººæ•°åˆ†åŸ‹ã‚ã‚‹ã¾ã§è£œå……
                while(roleKeys.length < playerCount) roleKeys = roleKeys.concat(availableRoles);
                
                // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦äººæ•°åˆ†å–å¾—
                roleKeys = roleKeys.sort(() => Math.random() - 0.5).slice(0, playerCount);

                let demonCount = 0;
                if (playerCount === 3) demonCount = Math.random() < 0.5 ? 0 : 1;
                else if (playerCount === 4) demonCount = Math.random() < 0.2 ? 0 : 1;
                else if (playerCount === 5) demonCount = Math.random() < 0.7 ? 1 : 2;
                else if (playerCount === 6) demonCount = 2;

                let teamAssignment = Array(playerCount).fill('HERO');
                for(let i=0; i<demonCount; i++) teamAssignment[i] = 'DEMON';
                teamAssignment.sort(() => Math.random() - 0.5);

                const newPlayers = roleKeys.map((roleKey, index) => ({
                    id: index,
                    name: playerNames[index] || `Player ${index + 1}`,
                    roleKey: roleKey,
                    roleName: ROLES[roleKey].name,
                    realTeam: teamAssignment[index],
                    level: 1,
                    maxHp: ROLES[roleKey].hp, 
                    currentHp: ROLES[roleKey].hp, 
                    isDead: false,
                    uniqueSkillUsed: false,
                    ultimateSkillUsed: false,
                    trainingBonus: false,
                    totalDamageDealt: 0,
                    atkBonus: 0, // æˆ¦å£«ãªã©ã®ãƒãƒ•ç”¨
                    defBonus: 0, // ç²¾éœŠä½¿ã„ãƒãƒ•ç”¨
                    charge: false, // æ ¼é—˜å®¶ãƒãƒ£ãƒ¼ã‚¸
                    counterStance: false, // ç›—è³Šã®é¨™ã—è¨ã¡æ§‹ãˆ
                    shield: false, // çµç•Œå¸«ã®çµ¶å¯¾é˜²å¾¡ãƒãƒªã‚¢
                    hpBonus: 0 // è³¢è€…ãƒ‘ãƒƒã‚·ãƒ–ç”¨
                }));

                const order = newPlayers.map(p => p.id).sort(() => Math.random() - 0.5);
                setTurnOrder(order);
                setPlayers(newPlayers);
                setMaxTurn(playerCount); 
                
                let hp = 350;
                if (playerCount === 3) hp = 200;
                else if (playerCount === 5) hp = 500;
                else if (playerCount === 6) hp = 700;

                setBossMaxHP(hp); 
                setBossHP(hp);
                
                setTurn(1);
                generateQuests([], 4, newPlayers); 
                
                setPhase('ORDER_ANNOUNCE');
            };

            const startRoleConfirm = () => {
                const queue = [...turnOrder]; 
                setActionQueue(queue.slice(1));
                setActivePlayerId(queue[0]);
                setPhase('ROLE_CONFIRM');
                setIsHandover(true);
            };

            const generateQuests = (existingQuests = [], targetCount = 4, currentPlayers = players) => {
                const currentCount = existingQuests.length;
                const needed = targetCount - currentCount;
                if (needed <= 0) { setQuests(existingQuests); return; }

                const ranks = [
                    { id: 'S', label: 'S: å¥³ç‹ã®ä¾é ¼', reqDiff: 0, rewardVal: 4, damageVal: 6, color: 'text-red-600', borderColor: 'border-red-600' },
                    { id: 'A', label: 'A: ç‹å›½é˜²è¡›', reqDiff: -1, rewardVal: 3, damageVal: 4, color: 'text-red-400', borderColor: 'border-red-400' },
                    { id: 'B', label: 'B: ç ¦å¥ªé‚„', reqDiff: -2, rewardVal: 2, damageVal: 2, color: 'text-orange-400', borderColor: 'border-orange-400' },
                    { id: 'C', label: 'C: ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼è¨ä¼', reqDiff: -3, rewardVal: 1, damageVal: 1, color: 'text-yellow-300', borderColor: 'border-yellow-300' }
                ];

                const newQuests = [...existingQuests];
                const usedMonsters = new Set(existingQuests.map(q => q.monsterName));

                const aliveCount = currentPlayers.length > 0 ? currentPlayers.filter(p => !p.isDead).length : 4;

                for (let i = 0; i < needed; i++) {
                    const r = Math.random();
                    let rank = r > 0.9 ? ranks[0] : r > 0.7 ? ranks[1] : r > 0.4 ? ranks[2] : ranks[3];
                    
                    const monsterList = MONSTERS[rank.id];
                    let monsterName = "";
                    let attempts = 0;
                    do {
                        monsterName = monsterList[Math.floor(Math.random() * monsterList.length)];
                        attempts++;
                    } while (usedMonsters.has(monsterName) && attempts < 20);
                    usedMonsters.add(monsterName);
                    
                    let req = Math.max(1, aliveCount + rank.reqDiff); 
                    
                    newQuests.push({
                        id: Date.now() + i + Math.random(), 
                        title: rank.label,
                        req: req,
                        rewardVal: rank.rewardVal,
                        damageVal: rank.damageVal,
                        color: rank.color,
                        borderColor: rank.borderColor,
                        rank: rank.id,
                        monsterName: monsterName,
                    });
                }
                setQuests(newQuests);
            };

            const startNewTurn = (clearedQuestIds = []) => {
                if (turn >= maxTurn) {
                    startBossPhase();
                    return;
                }
                const remainingQuests = quests.filter(q => !clearedQuestIds.includes(q.id));
                generateQuests(remainingQuests, 4);
                setTurn(t => t + 1);
                setTimeLeft(180);
                setPhase('STRATEGY');
                setPlayerActions({});
                setVotes({});
            };

            const nextPlayer = (nextPhaseIfDone) => {
                if (actionQueue.length === 0) {
                    setPhase(nextPhaseIfDone);
                    return;
                }
                const nextId = actionQueue[0];
                setActionQueue(prev => prev.slice(1));
                setActivePlayerId(nextId);
                setIsHandover(true);
            };

            const finishRoleConfirm = () => nextPlayer('STRATEGY');
            
            const startActionPhase = () => {
                const living = turnOrder.filter(id => {
                    const p = players.find(pl => pl.id === id);
                    return !p.isDead;
                });
                setActionQueue(living.slice(1));
                setActivePlayerId(living[0]);
                setPlayerActions({});
                setPhase('ACTION_SELECT');
                setIsHandover(true);
            };

            // --- å›ºæœ‰ã‚¹ã‚­ãƒ«ç™ºå‹•ãƒ­ã‚¸ãƒƒã‚¯ ---
            const handleUniqueSkill = () => {
                const activePlayer = players.find(p => p.id === activePlayerId);
                const role = ROLES[activePlayer.roleKey];

                if (role.uniqueSkill.type === 'QUEST_ACTIVE') {
                    if (activePlayer.roleKey === 'MAGE') handleMageSkill();
                    else if (activePlayer.roleKey === 'THIEF') handleThiefSkill();
                    else if (activePlayer.roleKey === 'SPIRIT') handleSpiritSkill();
                    else if (activePlayer.roleKey === 'CLERIC') handleClericUniqueSkill();
                    else if (activePlayer.roleKey === 'SAGE') handleSageUniqueSkill();
                    else if (activePlayer.roleKey === 'BARRIER_MASTER') handleBarrierMasterUniqueSkill();
                }
            };

            const handleMageSkill = () => {
                const targets = players.filter(p => p.id !== activePlayerId);
                setChoicePopup({
                    title: 'é­”æ³•æ„ŸçŸ¥',
                    message: 'èª°ã®æ­£ä½“ã‚’å ã„ã¾ã™ã‹ï¼Ÿ',
                    choices: targets.map(p => ({ label: p.name, value: p.id, className: 'bg-purple-600 text-white' })),
                    onClose: (targetId) => {
                        setChoicePopup(null);
                        if (targetId !== null) {
                            const target = players.find(p => p.id === targetId);
                            setPlayers(prev => prev.map(p => p.id === activePlayerId ? {...p, uniqueSkillUsed: true} : p));
                            setPopup({
                                title: 'å ã„ã®çµæœ',
                                message: `${target.name} ã¯... \n\nã€${target.roleName}ã€‘\né™£å–¶ï¼š${target.realTeam === 'HERO' ? 'å‹‡è€…é™£å–¶' : 'é­”ç‹é™£å–¶'}`,
                                type: 'success',
                                onClose: () => setPopup(null)
                            });
                        }
                    }
                });
            };

            const handleThiefSkill = () => {
                const targets = players.filter(p => p.id !== activePlayerId);
                setChoicePopup({
                    title: 'ç›—è³Šã®æ¥µæ„',
                    message: 'èª°ã¨é™£å–¶ã‚’å…¥ã‚Œæ›¿ãˆã¾ã™ã‹ï¼Ÿ\n(è‡ªåˆ†ã¨å¯¾è±¡ã®é™£å–¶ãŒäº¤æ›ã•ã‚Œã¾ã™)',
                    choices: targets.map(p => ({ label: p.name, value: p.id, className: 'bg-slate-600 text-white' })),
                    onClose: (targetId) => {
                        setChoicePopup(null);
                        if (targetId !== null) {
                            const target = players.find(p => p.id === targetId);
                            const me = players.find(p => p.id === activePlayerId);
                            const myTeam = me.realTeam;
                            const targetTeam = target.realTeam;
                            setPlayers(prev => prev.map(p => {
                                if (p.id === activePlayerId) return { ...p, realTeam: targetTeam, uniqueSkillUsed: true };
                                if (p.id === targetId) return { ...p, realTeam: myTeam };
                                return p;
                            }));
                            setPopup({
                                title: 'å…¥æ›¿å®Œäº†',
                                message: `${target.name} ã¨é™£å–¶ã‚’å…¥ã‚Œæ›¿ãˆã¾ã—ãŸã€‚\n\nã‚ãªãŸã¯ä»Šã€${targetTeam === 'HERO' ? 'å‹‡è€…é™£å–¶' : 'é­”ç‹é™£å–¶'}ã€‘ã§ã™ã€‚\n(â€»ç›¸æ‰‹ã«ã¯é€šçŸ¥ã•ã‚Œã¾ã›ã‚“)`,
                                type: 'success',
                                onClose: () => setPopup(null)
                            });
                        }
                    }
                });
            };

            const handleSpiritSkill = () => {
                const roleNames = players.map(p => p.roleName).sort(() => Math.random() - 0.5);
                const roleCounts = {};
                roleNames.forEach(name => roleCounts[name] = (roleCounts[name] || 0) + 1);
                const displayList = Object.entries(roleCounts).map(([name, count]) => `${name}${count > 1 ? ' x'+count : ''}`).join('\n');
                setPlayers(prev => prev.map(p => p.id === activePlayerId ? {...p, uniqueSkillUsed: true} : p));
                setPopup({
                    title: 'ç²¾éœŠã®èª“ã„',
                    message: `ä»Šå›ã®ã‚²ãƒ¼ãƒ ã«å‚åŠ ã—ã¦ã„ã‚‹è·æ¥­:\n\n${displayList}\n\n(â€»èª°ãŒã©ã®è·æ¥­ã‹ã¯ä¸æ˜)`,
                    type: 'info',
                    onClose: () => setPopup(null)
                });
            };

            const handleClericUniqueSkill = () => {
                 const targets = players.filter(p => p.id !== activePlayerId);
                 setChoicePopup({
                    title: 'æ…ˆæ„›ã®æ‚Ÿã‚Š',
                    message: 'èª°ã‚’å¼·åˆ¶çš„ã«å‹‡è€…é™£å–¶ã«ã—ã¾ã™ã‹ï¼Ÿ',
                    choices: targets.map(p => ({ label: p.name, value: p.id, className: 'bg-green-600 text-white' })),
                    onClose: (targetId) => {
                        setChoicePopup(null);
                        if (targetId !== null) {
                            setPlayers(prev => prev.map(p => {
                                if (p.id === activePlayerId) return { ...p, uniqueSkillUsed: true };
                                if (p.id === targetId) return { ...p, realTeam: 'HERO' }; // å¼·åˆ¶å¤‰æ›´
                                return p;
                            }));
                            setPopup({
                                title: 'æµ„åŒ–å®Œäº†',
                                message: `å¯¾è±¡ã‚’å‹‡è€…é™£å–¶ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚(å¯¾è±¡ã«ã¯é€šçŸ¥ã•ã‚Œã¾ã›ã‚“)`,
                                type: 'success',
                                onClose: () => setPopup(null)
                            });
                        }
                    }
                });
            };

            const handleSageUniqueSkill = () => {
                const targets = players.filter(p => p.id !== activePlayerId);
                setChoicePopup({
                    title: 'å¡æ™ºã®å…‰',
                    message: 'èª°ã®æ­£ä½“ã‚’çœ‹ç ´ã—ã€å›å¾©ã•ã›ã¾ã™ã‹ï¼Ÿ',
                    choices: targets.map(p => ({ label: p.name, value: p.id, className: 'bg-purple-600 text-white' })),
                    onClose: (targetId) => {
                        setChoicePopup(null);
                        if (targetId !== null) {
                            const target = players.find(p => p.id === targetId);
                            setPlayers(prev => prev.map(p => {
                                if (p.id === activePlayerId) return { ...p, uniqueSkillUsed: true };
                                if (p.id === targetId) return { ...p, currentHp: p.maxHp }; // å…¨å›å¾©
                                return p;
                            }));
                            setPopup({
                                title: 'çœ‹ç ´çµæœ',
                                message: `${target.name} ã¯... \nã€${target.roleName}ã€‘\né™£å–¶ï¼š${target.realTeam === 'HERO' ? 'å‹‡è€…é™£å–¶' : 'é­”ç‹é™£å–¶'}\n\nå¯¾è±¡ã®HPã‚’å…¨å›å¾©ã—ã¾ã—ãŸã€‚`,
                                type: 'success',
                                onClose: () => setPopup(null)
                            });
                        }
                    }
                });
            };

            const handleBarrierMasterUniqueSkill = () => {
                const demonCount = players.filter(p => p.realTeam === 'DEMON').length;
                setPlayers(prev => prev.map(p => p.id === activePlayerId ? { ...p, uniqueSkillUsed: true } : p));
                setPopup({
                    title: 'çµç•Œå±•é–‹',
                    message: `ã“ã®ã‚²ãƒ¼ãƒ ã«å‚åŠ ã—ã¦ã„ã‚‹é­”ç‹é™£å–¶ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ã¯... \n\nã€ ${demonCount} äºº ã€‘\n\nã§ã™ã€‚`,
                    type: 'info',
                    onClose: () => setPopup(null)
                });
            };

            // --- ã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ ---

            const handleQuestClick = (quest) => {
                const activePlayer = players.find(p => p.id === activePlayerId);
                // å‹‡è€…ã®è©¦ç·´ (å›ºæœ‰ã‚¹ã‚­ãƒ«)
                if (activePlayer.roleKey === 'HERO' && !activePlayer.uniqueSkillUsed) {
                    setChoicePopup({
                        title: 'è¡Œå‹•é¸æŠ',
                        message: `ã€Œ${quest.title}ã€ã«å¯¾ã—ã¦ã©ã†è¡Œå‹•ã—ã¾ã™ã‹ï¼Ÿ`,
                        choices: [
                            { label: 'æ™®é€šã«å‚åŠ ã™ã‚‹', value: 'join', className: 'bg-blue-600 text-white' },
                            { label: 'å›ºæœ‰ã‚¹ã‚­ãƒ«: å‹‡è€…ã®è©¦ç·´ (å¿…å‹)', value: 'skill', className: 'bg-yellow-600 text-white font-bold' }
                        ],
                        onClose: (val) => {
                            setChoicePopup(null);
                            if (val === 'join') handleActionSelect({ type: 'QUEST', targetId: quest.id, sabotage: false });
                            else if (val === 'skill') {
                                setPlayers(prev => prev.map(p => p.id === activePlayerId ? {...p, uniqueSkillUsed: true} : p));
                                handleActionSelect({ type: 'QUEST', targetId: quest.id, sabotage: false, useSkill: true });
                            }
                        }
                    });
                    return;
                }
                setChoicePopup({
                    title: 'ã‚¯ã‚¨ã‚¹ãƒˆå‚åŠ ç¢ºèª',
                    message: `ã€Œ${quest.title}ã€ã«å‚åŠ ã—ã¾ã™ã‹ï¼Ÿ\n(å¿…è¦äººæ•°: ${quest.req}äºº)\n\nâ€»å‚åŠ ã™ã‚‹ã¨ ${quest.damageVal} ãƒ€ãƒ¡ãƒ¼ã‚¸å—ã‘ã¾ã™`,
                    choices: [{ label: 'å‚åŠ ã™ã‚‹', value: 'join', className: 'bg-blue-600 text-white' }],
                    onClose: (value) => {
                        setChoicePopup(null);
                        if (value === 'join') handleActionSelect({ type: 'QUEST', targetId: quest.id, sabotage: false });
                    }
                });
            };

            const handleTrainingClick = () => {
                setChoicePopup({
                    title: 'å€‹äººä¿®è¡Œã®ç¢ºèª',
                    message: `ã‚¯ã‚¨ã‚¹ãƒˆã«ã¯å‚åŠ ã›ãšã€ä¿®è¡Œã‚’ã—ã¦\nè‡ªåˆ†ã ã‘ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ`,
                    choices: [{ label: 'ä¿®è¡Œã™ã‚‹ (ä¸å‚åŠ )', value: 'train', className: 'bg-yellow-600 text-white' }],
                    onClose: (value) => {
                        setChoicePopup(null);
                        if (value === 'train') handleActionSelect({ type: 'TRAIN' });
                    }
                });
            };

            const handleRestClick = () => {
                setChoicePopup({
                    title: 'ä¼‘æ¯ã®ç¢ºèª',
                    message: `ã‚¯ã‚¨ã‚¹ãƒˆã«ã¯å‚åŠ ã›ãšã€ä¼‘æ¯ã‚’å–ã‚Šã¾ã™ã‹ï¼Ÿ\nHPãŒå…¨å›å¾©ã—ã¾ã™ã€‚`,
                    choices: [{ label: 'ä¼‘æ¯ã™ã‚‹ (ä¸å‚åŠ )', value: 'rest', className: 'bg-green-600 text-white' }],
                    onClose: (value) => {
                        setChoicePopup(null);
                        if (value === 'rest') handleActionSelect({ type: 'REST' });
                    }
                });
            };

            const handleActionSelect = (action) => {
                setPlayerActions(prev => ({ ...prev, [activePlayerId]: action }));
                if (actionQueue.length === 0) calculateQuestResults({ ...playerActions, [activePlayerId]: action });
                else nextPlayer('QUEST_RESULT');
            };

            const calculateQuestResults = (actions) => {
                const clearedIds = [];
                let evolvedPlayers = [];

                const results = quests.map(q => {
                    const participantsActs = Object.entries(actions).filter(([pid, act]) => act.type === 'QUEST' && act.targetId === q.id);
                    const participantIds = participantsActs.map(([pid]) => parseInt(pid));
                    const heroSkillUsed = participantsActs.some(([pid, act]) => act.useSkill); // å‹‡è€…ã‚¹ã‚­ãƒ«
                    const effectivePower = participantIds.length; 
                    const isSuccess = heroSkillUsed || (effectivePower >= q.req);
                    
                    setPlayers(prev => prev.map(p => {
                        // å‹‡è€…ã‚¹ã‚­ãƒ«ã®ä½¿ç”¨ãƒ•ãƒ©ã‚°ã‚’ç¢ºå®Ÿã«æ›´æ–° (æœ€å¾Œã®äººãŒå‹‡è€…ã®å ´åˆã«ä¸Šæ›¸ãã•ã‚Œãªã„ã‚ˆã†ã«)
                        if (p.roleKey === 'HERO' && heroSkillUsed && participantIds.includes(p.id)) {
                            const myAction = actions[p.id];
                            if(myAction && myAction.useSkill) return { ...p, uniqueSkillUsed: true };
                        }

                        if (participantIds.includes(p.id)) {
                            // ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—
                            let dmg = q.damageVal;
                            // é¨å£«ãƒ‘ãƒƒã‚·ãƒ–: å±ˆå¼·ãªè‚‰ä½“
                            if (p.roleKey === 'KNIGHT') dmg = Math.max(0, dmg - 1);
                            // çµç•Œå¸«ã¯ãƒ‘ãƒƒã‚·ãƒ–ã§ã¯ãªã„ã®ã§å‰Šé™¤ (æŒ‡ç¤ºæ›¸ã«ãƒ‘ãƒƒã‚·ãƒ–ã®è¨˜è¿°ãªã—)
                            
                            let newHp = p.currentHp - dmg;
                            let isDead = p.isDead;
                            if (newHp <= 0) { newHp = 0; isDead = true; }

                            if (isSuccess) {
                                let rise = q.rewardVal;
                                if (p.trainingBonus) rise += 3;

                                // ä¿®æ­£ï¼šéŠã³äººã®çµŒé¨“å€¤2å€ãƒ‘ãƒƒã‚·ãƒ–ã‚’å‰Šé™¤
                                // (ä»¥å‰ã®ã‚³ãƒ¼ãƒ‰ã«ã‚ã£ãŸã€Œif (p.roleKey === 'PLAYBOY' && Math.random() < 0.5) rise *= 2;ã€ã‚’å‰Šé™¤)

                                // æ ¼é—˜å®¶ãƒ‘ãƒƒã‚·ãƒ–: å­¤ç‹¬ã®ä¿®è¡Œ (1äººã§ã‚¯ãƒªã‚¢æ™‚Lv+1)
                                if (p.roleKey === 'MONK' && participantIds.length === 1) {
                                    rise += 1;
                                }

                                const newLevel = p.level + rise;
                                const hpGrowth = ROLES[p.roleKey].hp * rise;

                                // æˆ¦å£«ãƒ‘ãƒƒã‚·ãƒ–: æˆ¦å£«ã®è¨¼
                                let addedAtk = 0;
                                if (p.roleKey === 'WARRIOR') addedAtk = 1;

                                // è³¢è€…ãƒ‘ãƒƒã‚·ãƒ–: å¡æ™ºã®å®šå¼ (HP+1, ATK+1)
                                let addedHpBonus = 0;
                                if (p.roleKey === 'SAGE') {
                                    addedHpBonus = 1;
                                    addedAtk += 1;
                                }

                                let roleKey = p.roleKey;
                                let roleName = p.roleName;
                                let currentHp = newHp + hpGrowth + addedHpBonus;
                                let maxHp = p.maxHp + hpGrowth + addedHpBonus;

                                // éŠã³äººé€²åŒ–ãƒ­ã‚¸ãƒƒã‚¯
                                if (p.roleKey === 'PLAYBOY' && newLevel >= (playerCount * 2 + 2)) {
                                    roleKey = 'SAGE';
                                    roleName = ROLES['SAGE'].name;
                                    evolvedPlayers.push(p.name);
                                }

                                return { ...p, roleKey, roleName, level: newLevel, maxHp: maxHp, currentHp: currentHp, atkBonus: (p.atkBonus||0) + addedAtk, hpBonus: (p.hpBonus||0) + addedHpBonus, trainingBonus: false, isDead };
                            } else {
                                return { ...p, currentHp: newHp, isDead };
                            }
                        }
                        return p;
                    }));

                    if (isSuccess) clearedIds.push(q.id);
                    return { quest: q, participantsCount: participantIds.length, isSuccess, heroSkill: heroSkillUsed };
                });

                Object.entries(actions).forEach(([pid, act]) => {
                    if (act.type === 'TRAIN') {
                        setPlayers(prev => prev.map(p => {
                            if (p.id === parseInt(pid)) {
                                return { ...p, level: p.level + 1, maxHp: p.maxHp + ROLES[p.roleKey].hp, currentHp: p.currentHp + ROLES[p.roleKey].hp };
                            }
                            return p;
                        }));
                    } else if (act.type === 'REST') {
                        setPlayers(prev => prev.map(p => {
                            if (p.id === parseInt(pid)) {
                                return { ...p, currentHp: p.maxHp };
                            }
                            return p;
                        }));
                    }
                });
                
                if (evolvedPlayers.length > 0) {
                    setPopup({
                        title: 'é€²åŒ–ç™ºç”Ÿï¼',
                        message: evolvedPlayers.map(name => `${name} ã¯ã€ŒéŠã³äººã€ã‹ã‚‰ã€Œè³¢è€…ã€ã«é€²åŒ–ã—ãŸï¼`).join('\n'),
                        type: 'success',
                        onClose: () => setPopup(null)
                    });
                }

                setQuestResults(results);
                setPhase('QUEST_RESULT');
                window.tempClearedIds = clearedIds; 
            };

            const startVoteDiscussion = () => {
                setTimeLeft(180);
                setPhase('VOTE_DISCUSS');
            };

            const startVoteSelect = () => {
                const living = turnOrder.filter(id => {
                    const p = players.find(pl => pl.id === id);
                    return !p.isDead;
                });
                setActionQueue(living.slice(1));
                setActivePlayerId(living[0]);
                setVotes({});
                setPhase('VOTE_SELECT');
                setIsHandover(true);
            };

            const handleVote = (targetId) => {
                setVotes(prev => ({ ...prev, [activePlayerId]: targetId }));
                if (actionQueue.length === 0) calculateExile({ ...votes, [activePlayerId]: targetId });
                else nextPlayer('EXILE_PRE_RESULT');
            };

            const calculateExile = (allVotes) => {
                const counts = {};
                let skipCount = 0;
                Object.values(allVotes).forEach(tid => {
                    if (tid === null) skipCount++;
                    else counts[tid] = (counts[tid] || 0) + 1;
                });
                let maxVotes = 0;
                let banishedId = -1;
                Object.entries(counts).forEach(([id, c]) => {
                    if (c > maxVotes) {
                        maxVotes = c;
                        banishedId = parseInt(id);
                    } else if (c === maxVotes) banishedId = -1;
                });
                if (skipCount >= maxVotes) banishedId = -1;
                
                let result = { banished: null, message: 'ç¥¨ãŒå‰²ã‚ŒãŸã€ã¾ãŸã¯ã‚¹ã‚­ãƒƒãƒ—ãŒå¤šæ•°ã ã£ãŸãŸã‚ã€èª°ã‚‚è¿½æ”¾ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚' };

                if (banishedId !== -1) {
                    const banishedPlayer = players.find(p => p.id === banishedId);
                    setPlayers(prev => prev.map(p => p.id === banishedId ? { ...p, isDead: true } : p));
                    result = { banished: banishedPlayer, message: 'æŠ•ç¥¨ã®çµæœã€è¿½æ”¾è€…ãŒæ±ºå®šã—ã¾ã—ãŸã€‚' };
                }
                
                setExileResult(result);
                setPhase('EXILE_READY');
            };

            // --- é­”ç‹æˆ¦ ---
            
            const decideBossAction = () => {
                const r = Math.random() * 100;
                if (r < 5) return { type: 'ROAR', name: 'é­”ç‹ã®å’†å“®', desc: 'ç”Ÿå­˜è€…ã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§1åã‚’å³æ­»ã•ã›ã‚‹', imgKey: 'BOSS_ROAR' };
                if (r < 20) return { type: 'HELLFIRE', name: 'é—‡ã®ç„ç‚', desc: 'å…¨å“¡ã«ç‰¹å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸', imgKey: 'BOSS_HELLFIRE' };
                if (r < 40) return { type: 'MAGIC', name: 'é­”æ³•æ”»æ’ƒ', desc: 'é˜²å¾¡ç„¡è¦–ã®å…¨ä½“æ”»æ’ƒ', imgKey: 'BOSS_MAGIC' };
                return { type: 'NORMAL', name: 'é€šå¸¸æ”»æ’ƒ', desc: 'ãƒ©ãƒ³ãƒ€ãƒ ãªå¯¾è±¡ã«å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸', imgKey: 'BOSS_NORMAL' };
            };
            
            const getBossActionDetail = (action, playerCount) => {
                if (!action) return "";
                const baseDmg = playerCount * 3;
                if (action.type === 'ROAR') return `ç”Ÿå­˜è€…ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ 1å å³æ­»`;
                if (action.type === 'HELLFIRE') return `å…¨å“¡ã« ${baseDmg * 1.5} ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸`;
                if (action.type === 'MAGIC') return `å…¨å“¡ã« ${baseDmg * 1} é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸ (é˜²å¾¡ç„¡è¦–)`;
                const targetCount = Math.max(1, playerCount - 2); 
                return `ãƒ©ãƒ³ãƒ€ãƒ ${targetCount}åã« ${baseDmg * 2} ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸`;
            };

            const startBossPhase = () => {
                const aliveCount = players.filter(p => !p.isDead).length;
                setBossInitialPlayerCount(aliveCount); 
                // ä¿®æ­£: uniqueSkillUsedã®ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤
                setPlayers(prev => prev.map(p => ({ ...p, ultimateSkillUsed: false, charge: false, counterStance: false, shield: false, stunned: false })));

                setBossTurnCount(1);
                setBossBattleLog([]);
                setBattleState({}); 
                setPhase('BOSS_INTRO');
            };

            const startBossBattleRound = () => {
                setBossBattleActions({});
                setBattleState(prev => ({ ...prev, knightTarget: null, forceBossNormal: false, bossStunned: false, knightGuard: null })); // ä¿®æ­£: knightGuardè¿½åŠ 
                setRoundDamageReport({}); // ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ¬ãƒãƒ¼ãƒˆãƒªã‚»ãƒƒãƒˆ
                
                // ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«ä¸€æ™‚çš„ãªåŠ¹æœã‚’ãƒªã‚»ãƒƒãƒˆ
                setPlayers(prev => prev.map(p => ({ ...p, counterStance: false, shield: false, stunned: false })));

                const nextAction = decideBossAction();
                setBossNextAction(nextAction);

                setPhase('BOSS_ACTION_ANNOUNCE');
            };

            const proceedToBossPlayerSelect = () => {
                const living = turnOrder.filter(id => {
                    const p = players.find(pl => pl.id === id);
                    return !p.isDead;
                });
                if (living.length === 0) { setWinner('DEMON'); setPhase('RESULT'); return; }
                setActionQueue(living.slice(1));
                setActivePlayerId(living[0]);
                setPhase('BOSS_SELECT');
                setIsHandover(true);
            };

            const handleBossTurnStart = () => {
                const activePlayer = players.find(p => p.id === activePlayerId);
                const role = ROLES[activePlayer.roleKey];

                if (activePlayer.charge) {
                     setChoicePopup({
                        title: 'æ­£æ‹³çªã',
                        message: 'åŠ›ã‚’æºœã‚ãŸä¸€æ’ƒã‚’æ”¾ã¡ã¾ã™ï¼',
                        choices: [{ label: 'æ”»æ’ƒå¯¾è±¡ã‚’é¸æŠ', value: 'attack', className: 'bg-red-600 text-white font-bold' }],
                        onClose: (val) => {
                            setChoicePopup(null);
                            if (val === 'attack') showAttackTargetSelect();
                        }
                    });
                    return;
                }

                if (!activePlayer.ultimateSkillUsed && role.ultimateSkill.type !== 'NONE') {
                    setChoicePopup({
                        title: 'è¡Œå‹•é¸æŠ',
                        message: `è¡Œå‹•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\nå¿…æ®ºã‚¹ã‚­ãƒ«: ${role.ultimateSkill.name}\n(${role.ultimateSkill.desc})`,
                        choices: [
                            { label: 'é€šå¸¸è¡Œå‹• (æ”»æ’ƒ)', value: 'attack', className: 'bg-red-600 text-white' },
                            { label: `å¿…æ®ºã‚¹ã‚­ãƒ«ç™ºå‹•`, value: 'skill', className: 'bg-yellow-500 text-white font-bold' }
                        ],
                        onClose: (val) => {
                            setChoicePopup(null);
                            if (val === 'attack') showAttackTargetSelect();
                            else if (val === 'skill') {
                                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸æŠä¸è¦ãªã‚¹ã‚­ãƒ« (ä¿®æ­£: SAGEã¨THIEFã‚’å‰Šé™¤)
                                if (['CLERIC', 'MONK', 'SPIRIT', 'PLAYBOY'].includes(activePlayer.roleKey)) {
                                    // SAGEã‚‚æ”»æ’ƒå¯¾è±¡å›ºå®šã¾ãŸã¯è‡ªåˆ†å›å¾©ã®ã¿ãªã‚‰é¸æŠä¸è¦ã ãŒã€é­”ç‹orãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠãŒã‚ã‚‹å ´åˆã¯å¿…è¦
                                    // ä»Šå›SAGEã¯é­”ç‹orãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠãªã®ã§ã€SAGEã¯é¸æŠå¿…è¦ãƒªã‚¹ãƒˆã¸
                                    handleBossAction({ type: 'SKILL' });
                                } else if (activePlayer.roleKey === 'SAGE') {
                                    // SAGEã¯å¯¾è±¡é¸æŠãŒå¿…è¦
                                    showAttackTargetSelect(true);
                                } else if (activePlayer.roleKey === 'THIEF') {
                                     // THIEFã¯å¯¾è±¡é¸æŠãŒå¿…è¦
                                    showAttackTargetSelect(true);
                                } else if (activePlayer.roleKey === 'MAGE') {
                                    // MAGEã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é™å®šé¸æŠ
                                    showAttackTargetSelect(true, 'PLAYER_ONLY');
                                } else if (activePlayer.roleKey === 'KNIGHT') {
                                    // é¨å£«ã®å ´åˆã€ç‰¹æ®Šãªé¸æŠè‚¢ã‚’è¡¨ç¤º
                                    showAttackTargetSelect(true, 'KNIGHT_GUARD');
                                } else {
                                    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸æŠãŒå¿…è¦ãªã‚¹ã‚­ãƒ« (HERO, WARRIOR, BARRIER_MASTER)
                                    showAttackTargetSelect(true); 
                                }
                            }
                        }
                    });
                } else {
                    showAttackTargetSelect();
                }
            };

            const showAttackTargetSelect = (isSkill = false, filterType = 'ALL') => {
                const activePlayer = players.find(p => p.id === activePlayerId);
                
                let choices = [];
                let message = 'èª°ã‚’å¯¾è±¡ã«ã—ã¾ã™ã‹ï¼Ÿ';
                
                // é­”æ³•ä½¿ã„ã®å¼·åŒ–é­”æ³•ãªã©ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é™å®š
                if (filterType === 'PLAYER_ONLY') {
                    // ä¿®æ­£: è‡ªåˆ†ã‚‚å«ã‚ã‚‹ (p.id !== activePlayerIdã‚’å‰Šé™¤)
                    choices = players.filter(p => !p.isDead).map(p => ({ 
                        label: `${p.name} (å¼·åŒ–)`, 
                        value: p.id, 
                        className: 'bg-green-600 text-white' 
                    }));
                } else if (filterType === 'KNIGHT_GUARD') {
                    // é¨å£«ã®ã‹ã°ã†é¸æŠ
                    message = 'èª°ã‹ã‚‰ã®æ”»æ’ƒã‚’ã‹ã°ã„ã¾ã™ã‹ï¼Ÿ';
                    choices = [
                        { label: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‹ã°ã†', value: 'GUARD_PLAYERS', className: 'bg-blue-600 text-white' },
                        { label: 'é­”ç‹ã‚’ã‹ã°ã†', value: 'GUARD_BOSS', className: 'bg-red-600 text-white' }
                    ];
                } else {
                    // é€šå¸¸ã¯é­”ç‹ + ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
                    choices = [
                        { label: 'é­”ç‹', value: 'BOSS', className: 'bg-purple-600 text-white font-bold text-xl' },
                        ...players.filter(p => !p.isDead && p.id !== activePlayerId).map(p => ({ label: `${p.name} (è£åˆ‡ã‚Š)`, value: p.id, className: 'bg-slate-600 text-white' }))
                    ];
                }

                setChoicePopup({
                    title: isSkill ? 'ã‚¹ã‚­ãƒ«å¯¾è±¡é¸æŠ' : 'æ”»æ’ƒå¯¾è±¡é¸æŠ',
                    message: message,
                    choices: choices,
                    onClose: (val) => {
                        setChoicePopup(null);
                        // ä¿®æ­£: valãŒnullã‚„undefinedã§ãªã„ã“ã¨ã‚’å³å¯†ã«ãƒã‚§ãƒƒã‚¯ (0ã®å ´åˆã‚‚è€ƒæ…®)
                        if (val !== null && val !== undefined) handleBossAction({ type: isSkill ? 'SKILL' : 'ATTACK', targetId: val });
                    }
                });
            };

            const handleBossAction = (action) => {
                setBossBattleActions(prev => ({ ...prev, [activePlayerId]: action }));
                if (action.type === 'SKILL') setPlayers(prev => prev.map(p => p.id === activePlayerId ? {...p, ultimateSkillUsed: true} : p));
                if (actionQueue.length === 0) calculateBossBattleResult({ ...bossBattleActions, [activePlayerId]: action });
                else nextPlayer('BOSS_RESULT');
            };

            const calculateBossBattleResult = (actions) => {
                let newLog = []; 
                newLog.push({ text: `--- Round ${bossTurnCount} ---`, type: 'info' });
                let currentBossHP = bossHP;
                let nextPlayers = [...players];
                let currentState = { ...battleState };
                let currentRoundDamage = {}; // ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ€ãƒ¡ãƒ¼ã‚¸é›†è¨ˆ

                // 0. ã‚¹ã‚­ãƒ«ä½¿ç”¨æ¸ˆã¿ãƒ•ãƒ©ã‚°ã®ç¢ºå®Ÿãªæ›´æ–°
                Object.entries(actions).forEach(([pid, act]) => {
                    const index = nextPlayers.findIndex(p => p.id === parseInt(pid));
                    if (index !== -1 && act.type === 'SKILL') {
                        nextPlayers[index] = { ...nextPlayers[index], ultimateSkillUsed: true };
                    }
                });

                // 1. ã‚¹ã‚­ãƒ«ç™ºå‹•å‡¦ç† (çŠ¶æ…‹å¤‰åŒ–ç³»)
                Object.entries(actions).forEach(([attId, action]) => {
                    if (action.type !== 'SKILL') return;
                    const actor = nextPlayers.find(p => p.id === parseInt(attId));
                    const role = ROLES[actor.roleKey];
                    newLog.push({ text: `${actor.name} ã®å¿…æ®ºã‚¹ã‚­ãƒ«ï¼ã€Œ${role.ultimateSkill.name}ã€`, type: 'info' });

                    if (actor.roleKey === 'KNIGHT') { 
                        // é¨å£«ã®ã‚¬ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰è¨­å®š
                        if (action.targetId === 'GUARD_PLAYERS') {
                            currentState.knightGuard = { mode: 'GUARD_PLAYERS', knightId: actor.id };
                            newLog.push({ text: `>> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®æ”»æ’ƒã‚’ã‹ã°ã†æ§‹ãˆï¼`, type: 'info' });
                        } else if (action.targetId === 'GUARD_BOSS') {
                            currentState.knightGuard = { mode: 'GUARD_BOSS', knightId: actor.id };
                            newLog.push({ text: `>> é­”ç‹ã¸ã®æ”»æ’ƒã‚’ã‹ã°ã†æ§‹ãˆï¼`, type: 'info' });
                        }
                    }
                    else if (actor.roleKey === 'MONK') { 
                        const pIdx = nextPlayers.findIndex(p => p.id === actor.id);
                        nextPlayers[pIdx] = { ...nextPlayers[pIdx], charge: true };
                        newLog.push({ text: `>> åŠ›ã‚’æºœã‚ã¦ã„ã‚‹...`, type: 'info' }); 
                    }
                    else if (actor.roleKey === 'THIEF') {
                         const pIdx = nextPlayers.findIndex(p => p.id === actor.id);
                         nextPlayers[pIdx] = { ...nextPlayers[pIdx], counterStance: true };
                         newLog.push({ text: `>> åæ’ƒã®æ§‹ãˆã‚’ã¨ã£ãŸï¼`, type: 'info' });
                    }
                    else if (actor.roleKey === 'SPIRIT') {
                        currentState.forceBossNormal = true;
                        newLog.push({ text: `>> é­”ç‹ã®æ”»æ’ƒã‚’é€šå¸¸æ”»æ’ƒã«å¼·åˆ¶å¤‰æ›´ï¼`, type: 'success' });
                    }
                    else if (actor.roleKey === 'BARRIER_MASTER') {
                        if (action.targetId === 'BOSS') {
                            currentState.bossStunned = true;
                            newLog.push({ text: `>> çµç•Œè¡“ï¼ é­”ç‹ã®è¡Œå‹•ã‚’å°ã˜ãŸï¼`, type: 'success' });
                        } else {
                            const tIdx = nextPlayers.findIndex(p => p.id === parseInt(action.targetId));
                            if (tIdx !== -1) {
                                nextPlayers[tIdx] = { ...nextPlayers[tIdx], stunned: true };
                                newLog.push({ text: `>> çµç•Œè¡“ï¼ ${nextPlayers[tIdx].name} ã®è¡Œå‹•ã‚’å°ã˜ãŸï¼`, type: 'success' });
                            }
                        }
                    }
                    else if (actor.roleKey === 'CLERIC') {
                        const healAmount = nextPlayers.length * 4;
                        nextPlayers = nextPlayers.map(p => !p.isDead ? { ...p, currentHp: Math.min(p.maxHp, p.currentHp + healAmount) } : p);
                         newLog.push({ text: `>> å…¨å“¡ã®HPãŒ ${healAmount} å›å¾©ï¼`, type: 'success' });
                    }
                    else if (actor.roleKey === 'MAGE') {
                         const target = nextPlayers.find(p => p.id === parseInt(action.targetId));
                         if(target) {
                             const pIdx = nextPlayers.findIndex(p => p.id === target.id);
                             // ãƒãƒ•ã¯æ°¸ç¶š (nextPlayersã‚’æ›´æ–°ã—ã¦stateã«ä¿å­˜ã™ã‚‹ãŸã‚)
                             // å¤‰æ›´: HPå›å¾©ãªã—ã€ATK+7, DEF+7
                             nextPlayers[pIdx] = { ...target, atkBonus: (target.atkBonus||0) + 7, defBonus: (target.defBonus||0) + 7 };
                             newLog.push({ text: `>> ${target.name} ã‚’å¼·åŒ–ï¼(ATK+7, DEF+7)`, type: 'success' });
                         }
                    }
                     else if (actor.roleKey === 'PLAYBOY') {
                        newLog.push({ text: `>> ã—ã‹ã— ãªã«ã‚‚ãŠã“ã‚‰ãªã‹ã£ãŸï¼`, type: 'info' });
                    }
                });

                // 2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ”»æ’ƒãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸ç³»ã‚¹ã‚­ãƒ«
                Object.entries(actions).forEach(([attId, action]) => {
                    const actor = nextPlayers.find(p => p.id === parseInt(attId));
                    if (actor.isDead) return; 
                    if (actor.stunned) {
                        newLog.push({ text: `${actor.name} ã¯è¡Œå‹•ã‚’å°ã˜ã‚‰ã‚Œã¦ã„ã¦å‹•ã‘ãªã„ï¼`, type: 'info' });
                        return;
                    }

                    let currentDmg = 0;
                    let isSkillAttack = (action.type === 'SKILL');
                    let skillName = "";

                    // ãƒ€ãƒ¡ãƒ¼ã‚¸ç®—å‡º
                    if (actor.charge && action.type === 'ATTACK') {
                        // æ­£æ‹³çªãç™ºå‹•
                        currentDmg = (actor.level * ROLES[actor.roleKey].atk + (actor.atkBonus||0)) * 4; 
                        actor.charge = false;
                        skillName = "æ­£æ‹³çªã(è§£æ”¾)";
                    } else if (isSkillAttack) {
                        if (actor.roleKey === 'WARRIOR') {
                            currentDmg = (actor.level * ROLES[actor.roleKey].atk + (actor.atkBonus||0)) * 2;
                            skillName = "æ¸¾èº«æ–¬ã‚Š";
                        } else if (actor.roleKey === 'HERO') {
                            const aliveCount = nextPlayers.filter(p => !p.isDead && p.realTeam === 'HERO').length; 
                            currentDmg = (aliveCount * 10) + (actor.level * ROLES[actor.roleKey].atk + (actor.atkBonus||0));
                             skillName = "è–ãªã‚‹æ–¬æ’ƒ";
                        } else if (actor.roleKey === 'SAGE') {
                             if(action.targetId === 'BOSS') {
                                 currentDmg = 100; 
                             } else {
                                 currentDmg = 100;
                             }
                             // è‡ªå·±å›å¾©ã®ã¿è¡Œã† (ä¸Šé™ãƒã‚§ãƒƒã‚¯æ¸ˆã¿)
                             const pIdx = nextPlayers.findIndex(p => p.id === actor.id);
                             if (pIdx !== -1) {
                                nextPlayers[pIdx] = { 
                                    ...nextPlayers[pIdx], 
                                    currentHp: Math.min(nextPlayers[pIdx].maxHp, nextPlayers[pIdx].currentHp + 20)
                                };
                                newLog.push({ text: `>> è‡ªèº«ã®HPã‚’20å›å¾©ï¼`, type: 'success' });
                             }
                             skillName = "æ˜Ÿè¾°ã®å¯©åˆ¤";
                        } else if (actor.roleKey === 'THIEF') {
                            if (action.targetId === 'BOSS') {
                                currentDmg = Math.floor(bossMaxHP / 5);
                            } else {
                                currentDmg = (actor.level * ROLES[actor.roleKey].atk + (actor.atkBonus||0)) * 5;
                            }
                            skillName = "æ€¥æ‰€ä¸€é–ƒ";
                        }
                    } else {
                        // é€šå¸¸æ”»æ’ƒ
                        currentDmg = actor.level * ROLES[actor.roleKey].atk + (actor.atkBonus||0);
                    }

                    if (currentDmg > 0) {
                        // å¤‰æ›´: è¡Œå‹•ãƒ­ã‚°ã‚’çµ±ä¸€çš„ã«å‡ºã™
                        if (skillName) {
                             newLog.push({ text: `${actor.name} ã® ${skillName}ï¼`, type: 'info' });
                        } else {
                             newLog.push({ text: `${actor.name} ã® é€šå¸¸æ”»æ’ƒ`, type: 'info' });
                        }

                        if (action.targetId === 'BOSS') {
                            // é¨å£«ã®é­”ç‹ã‹ã°ã†ãƒã‚§ãƒƒã‚¯
                            if (currentState.knightGuard && currentState.knightGuard.mode === 'GUARD_BOSS') {
                                const knight = nextPlayers.find(p => p.id === currentState.knightGuard.knightId);
                                if (knight && !knight.isDead) {
                                    newLog.push({ text: `${knight.name} ãŒé­”ç‹ã¸ã®æ”»æ’ƒã‚’ã‹ã°ã£ãŸï¼`, type: 'info' });
                                    // DEFè¨ˆç®—ãªã—ã§ãƒ€ãƒ¡ãƒ¼ã‚¸
                                    knight.currentHp -= currentDmg;
                                    newLog.push({ text: `${knight.name} ã« ${currentDmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼(ã‹ã°ã†)`, type: 'damage' });
                                    if (knight.currentHp <= 0) {
                                         knight.currentHp = 0;
                                         knight.isDead = true;
                                         newLog.push({ text: `${knight.name} ã¯ã‹ã°ã£ã¦åŠ›å°½ããŸ...`, type: 'death' });
                                    }
                                    return; // ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†çµ‚äº†
                                }
                            }

                            currentBossHP -= currentDmg;
                            newLog.push({ text: `é­”ç‹ã« ${currentDmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, type: 'damage' });
                            
                            // ãƒ€ãƒ¡ãƒ¼ã‚¸é›†è¨ˆ
                            currentRoundDamage[actor.id] = (currentRoundDamage[actor.id] || 0) + currentDmg;
                            
                            // ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸è¨˜éŒ²
                            const pIdx = nextPlayers.findIndex(p => p.id === actor.id);
                            nextPlayers[pIdx].totalDamageDealt += currentDmg;
                        } else {
                            // å¯¾ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
                            const tIdx = nextPlayers.findIndex(p => p.id === parseInt(action.targetId));
                            if (tIdx !== -1 && !nextPlayers[tIdx].isDead) {
                                let target = nextPlayers[tIdx];
                                const def = (target.level * ROLES[target.roleKey].def) + (target.defBonus||0);
                                const realDmg = Math.max(1, currentDmg - def);
                                target.currentHp -= realDmg;
                                newLog.push({ text: `${target.name} ã« ${realDmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, type: 'damage' });
                            }
                        }
                    }
                });

                // 3. é­”ç‹ã®åæ’ƒ
                if (currentBossHP > 0) {
                    if (currentState.bossStunned) {
                        newLog.push({ text: `é­”ç‹ã¯çµç•Œã«æ•ã‚‰ã‚ã‚Œã¦å‹•ã‘ãªã„ï¼`, type: 'success' });
                    } else {
                        const livingHeroes = nextPlayers.filter(p => !p.isDead);
                        if (livingHeroes.length > 0) {
                            const baseDmgVal = bossInitialPlayerCount * 3;
                            let action = bossNextAction;
                            
                            // ç²¾éœŠä½¿ã„ã‚¹ã‚­ãƒ«ã«ã‚ˆã‚‹å¼·åˆ¶å¤‰æ›´
                            if (currentState.forceBossNormal) {
                                action = { type: 'NORMAL', name: 'é€šå¸¸æ”»æ’ƒ (å¼·åˆ¶)', desc: 'ãƒ©ãƒ³ãƒ€ãƒ ãªå¯¾è±¡ã«å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸' };
                            }

                            const applyDamage = (target, rawDmg, ignoreDef = false) => {
                                if (target.isDead) return;
                                
                                // é¨å£«ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã°ã†ãƒã‚§ãƒƒã‚¯
                                if (currentState.knightGuard && currentState.knightGuard.mode === 'GUARD_PLAYERS' && currentState.knightGuard.knightId !== target.id) {
                                     const knight = nextPlayers.find(p => p.id === currentState.knightGuard.knightId);
                                     if (knight && !knight.isDead) {
                                         // ã‹ã°ã†ç™ºå‹•ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆå¤‰æ›´ï¼‰
                                         // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å…¨ä½“æ”»æ’ƒãªã©ã§ä½•åº¦ã‚‚å‡ºã‚‹ã®ã‚’é˜²ããŸã‚ã€ãƒ­ã‚°ã«ã¯ä¸€åº¦ã ã‘å‡ºã™ã®ãŒç†æƒ³ã ãŒ
                                         // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ç½®æ›ã®ã¿è¡Œã†ï¼ˆå…¨ä½“æ”»æ’ƒã®å ´åˆã¯é¨å£«ãŒè¤‡æ•°å›å—ã‘ã‚‹ï¼‰
                                         target = knight; 
                                     }
                                }

                                const def = ignoreDef ? 0 : (target.level * ROLES[target.roleKey].def + (target.defBonus||0));
                                const realDmg = Math.max(1, rawDmg - def);
                                target.currentHp -= realDmg;
                                
                                // ã‹ã°ã£ãŸå ´åˆã®ãƒ­ã‚°èª¿æ•´ç­‰ã¯è¤‡é›‘ã«ãªã‚‹ãŸã‚ã€ã‚·ãƒ³ãƒ—ãƒ«ã«èª°ãŒå—ã‘ãŸã‹ã‚’è¡¨ç¤º
                                if (currentState.knightGuard && currentState.knightGuard.mode === 'GUARD_PLAYERS' && target.id === currentState.knightGuard.knightId) {
                                     newLog.push({ text: `${target.name} ãŒã‹ã°ã£ã¦ ${realDmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼`, type: 'damage' });
                                } else {
                                     newLog.push({ text: `${target.name} ã« ${realDmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, type: 'damage' });
                                }
                            };

                            if (action.type === 'ROAR') {
                                const targetIdx = Math.floor(Math.random() * livingHeroes.length);
                                let target = livingHeroes[targetIdx];
                                newLog.push({ text: `é­”ç‹ã®å’†å“®ï¼ï¼`, type: 'death' });
                                target.currentHp = 0;
                                target.isDead = true;
                                newLog.push({ text: `${target.name} ã¯é­‚ã‚’æŠœã‹ã‚Œã¦å³æ­»ã—ãŸï¼`, type: 'death' });
                                
                            } else if (action.type === 'HELLFIRE') {
                                const rawDmg = baseDmgVal * 1.5;
                                newLog.push({ text: `é—‡ã®ç„ç‚ï¼ å…¨å“¡ã« ${rawDmg} ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, type: 'damage' });
                                livingHeroes.forEach(h => applyDamage(h, rawDmg, false));
                            } else if (action.type === 'MAGIC') {
                                const dmg = baseDmgVal * 1;
                                newLog.push({ text: `é­”æ³•æ”»æ’ƒï¼ å…¨å“¡ã« ${dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼(é˜²å¾¡ç„¡è¦–)`, type: 'damage' });
                                livingHeroes.forEach(h => applyDamage(h, dmg, true));
                            } else {
                                const rawDmg = baseDmgVal * 2;
                                const targetCount = Math.max(1, bossInitialPlayerCount - 2);
                                newLog.push({ text: `é­”ç‹ã®é€šå¸¸æ”»æ’ƒï¼ ãƒ©ãƒ³ãƒ€ãƒ ${targetCount}åã« ${rawDmg} ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, type: 'damage' });
                                
                                let targets = [];
                                const candidates = [...livingHeroes];
                                for(let i=0; i<targetCount; i++) {
                                    if(candidates.length === 0) break;
                                    const idx = Math.floor(Math.random() * candidates.length);
                                    targets.push(candidates[idx]);
                                    candidates.splice(idx, 1);
                                }
                                targets.forEach(t => applyDamage(t, rawDmg, false));
                            }
                        }
                    }
                }
                
                // æ­»äº¡åˆ¤å®šæ›´æ–°
                nextPlayers.forEach(p => {
                    if (p.currentHp <= 0) {
                        p.currentHp = 0;
                        if(!p.isDead) {
                            p.isDead = true;
                            newLog.push({ text: `${p.name} ã¯åŠ›å°½ããŸ...`, type: 'death' });
                        }
                    }
                });

                setBossHP(Math.max(0, currentBossHP)); setPlayers(nextPlayers);
                setBossBattleLog(prev => [...newLog, ...prev]); setBattleState(currentState);
                setRoundDamageReport(currentRoundDamage);
                setPhase('BOSS_RESULT');
            };

            const nextBossRound = () => {
                if (bossHP <= 0) { setWinner('HERO'); setPhase('RESULT'); }
                else if (!players.some(p => !p.isDead)) { setWinner('DEMON'); setPhase('RESULT'); }
                else if (bossTurnCount >= 3) { setWinner('DEMON'); setPhase('RESULT'); }
                else { setBossTurnCount(c => c + 1); startBossBattleRound(); }
            };

            const activePlayer = players.find(p => p.id === activePlayerId) || players[0];
            const activePlayerName = activePlayer 
                ? (['STRATEGY','QUEST_RESULT','VOTE_DISCUSS','BOSS_INTRO','BOSS_RESULT', 'EXILE_READY', 'EXILE_RESULT', 'BOSS_ACTION_ANNOUNCE'].includes(phase) ? 'å…¨å“¡' : activePlayer.name)
                : '';

            if (phase === 'INTRO') return (
                <div className="h-screen w-screen flex flex-col items-center justify-center p-4 bg-slate-950 text-white text-center overflow-hidden">
                    <div className="w-full max-w-4xl mb-4 flex-none">
                        <img src="ãƒ˜ãƒƒãƒ€ãƒ¼.png" alt={GAME_TEXTS.TITLE} className="w-full object-contain" onError={(e) => e.target.style.display = 'none'} />
                    </div>
                    
                    <div className="w-full max-w-6xl bg-slate-900/90 p-6 rounded-xl border border-slate-700 shadow-2xl mb-4 text-left space-y-4 overflow-y-auto flex-grow max-h-[50vh]">
                        <div className="space-y-2 text-slate-300 leading-relaxed">
                            {GAME_TEXTS.STORY.map((line, i) => <p key={i}>{line}</p>)}
                        </div>

                        <div className="border-t border-slate-700 pt-4">
                            <h3 className="text-xl font-bold text-yellow-400 mb-2">ã‚²ãƒ¼ãƒ æ¦‚è¦</h3>
                            <p className="text-sm md:text-base text-slate-300 whitespace-pre-wrap leading-relaxed">
                                ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ä»²é–“ã¨ã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã€è£åˆ‡è€…ã«é‚ªé­”ã•ã‚Œã‚‹ã“ã¨ãªãé­”ç‹ã‚’è¨ä¼ã™ã‚‹ã“ã¨ãŒç›®çš„ã®ã‚²ãƒ¼ãƒ ã§ã™ã€‚<br/>
                                æ§˜ã€…ãªã‚¹ã‚­ãƒ«ã‚„è·æ¥­ã”ã¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ´»ç”¨ã—ã€<span className="text-blue-400 font-bold">å‹‡è€…é™£å–¶</span>ã¯é­”ç‹è¨ä¼ã‚’ç›®æŒ‡ã—<span className="text-red-500 font-bold">é­”ç‹é™£å–¶</span>ã¯é­”ç‹è¨ä¼ã‚’é˜»æ­¢ã—ã¾ã—ã‚‡ã†ã€‚
                            </p>
                        </div>
                        
                        {/* ã‚²ãƒ¼ãƒ ã®æµã‚Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å‰Šé™¤ */}
                        <p className="text-xs text-slate-400 mt-2 border-t border-slate-800 pt-2">{GAME_TEXTS.NOTE}</p>
                    </div>

                    {/* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */}
                    <div className="flex flex-col md:flex-row gap-4 items-center justify-center flex-none">
                        <button onClick={() => setPhase('SETUP')} className="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white px-12 py-4 rounded-full text-2xl font-bold shadow-lg transform transition hover:scale-105">
                            å†’é™ºã‚’å§‹ã‚ã‚‹
                        </button>
                        <a href="guide.html" target="_blank" className="bg-slate-700 hover:bg-slate-600 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg border border-slate-500 transition flex items-center gap-2">
                            <span>ğŸ“–</span> å…¬å¼ã‚¬ã‚¤ãƒ‰ã‚’è¦‹ã‚‹
                        </a>
                    </div>
                </div>
            );

            if (phase === 'SETUP') return (
                <div className="h-screen w-screen flex flex-col items-center justify-center p-4 bg-slate-900 text-white overflow-hidden">
                    <h2 className="text-3xl font-bold mb-8">ãƒ—ãƒ¬ã‚¤äººæ•°ã‚’é¸æŠ</h2>
                    <div className="grid grid-cols-3 gap-6 w-full max-w-md">
                        {[3,4,5,6].map(n => (
                            <button key={n} onClick={()=>selectPlayerCount(n)} className="aspect-square bg-slate-800 hover:bg-blue-900 border-2 border-slate-600 hover:border-blue-400 rounded-2xl font-bold text-4xl shadow-lg transition">
                                {n}<span className="text-base block mt-1 text-slate-400">äºº</span>
                            </button>
                        ))}
                    </div>
                </div>
            );

            if (phase === 'NAME_ENTRY') return (
                <div className="h-screen w-screen flex flex-col items-center justify-center p-4 bg-slate-900 text-white overflow-hidden">
                    <div className="bg-slate-800 p-6 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-lg flex flex-col max-h-[90vh]">
                        <h2 className="text-2xl font-bold mb-4 text-center text-yellow-400 flex-none">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åå…¥åŠ›</h2>
                        <div className="space-y-3 overflow-y-auto flex-grow pr-2 mb-4">
                            {playerNames.map((name, i) => (
                                <div key={i} className="flex flex-col">
                                    <label className="text-sm text-slate-400 mb-1">Player {i+1}</label>
                                    <input type="text" value={name} onChange={(e) => { const newNames = [...playerNames]; newNames[i] = e.target.value; setPlayerNames(newNames); }}
                                        className="bg-slate-700 text-white p-3 rounded border border-slate-600 focus:border-blue-500 outline-none text-lg" />
                                </div>
                            ))}
                        </div>
                        <button onClick={startGame} className="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold text-xl shadow-lg flex-none">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                    </div>
                </div>
            );

            if (phase === 'ORDER_ANNOUNCE') return (
                <div className="h-screen w-screen flex flex-col items-center justify-center p-4 bg-slate-950 text-white overflow-hidden">
                    <div className="bg-slate-800 p-8 rounded-xl shadow-2xl border border-slate-700 w-full max-w-xl">
                        <h2 className="text-3xl font-bold mb-8 text-center text-yellow-400">è¡Œå‹•é †åºæ±ºå®š</h2>
                        <div className="space-y-4">
                            {turnOrder.map((pid, idx) => {
                                const p = players.find(pl => pl.id === pid);
                                return (
                                    <div key={pid} className="flex items-center bg-slate-700 p-4 rounded-lg border border-slate-600">
                                        <span className="text-2xl font-black text-blue-400 w-12 text-center mr-4">{idx + 1}</span>
                                        <span className="text-xl font-bold">{p.name}</span>
                                    </div>
                                );
                            })}
                        </div>
                        <button onClick={startRoleConfirm} className="w-full mt-8 bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold text-xl shadow-lg">
                            æ¬¡ã¸
                        </button>
                    </div>
                </div>
            );

            if (phase === 'RESULT') return (
                <div className="h-screen w-screen flex flex-col items-center justify-center p-4 bg-slate-950 text-white overflow-hidden">
                    <h1 className={`text-5xl font-black mb-6 ${winner === 'HERO' ? 'text-yellow-400' : 'text-purple-500'}`}>
                        {winner === 'HERO' ? 'å‹‡è€…å‹åˆ©ï¼' : 'é­”ç‹å‹åˆ©...'}
                    </h1>
                    <div className="bg-slate-800 p-6 rounded-xl max-w-xl w-full shadow-2xl border border-slate-700 flex flex-col max-h-[70vh]">
                        <h2 className="text-xl mb-4 border-b border-slate-600 pb-2 flex-none">æœ€çµ‚çµæœ</h2>
                        <div className="overflow-y-auto flex-grow pr-2">
                            {players.map(p => (
                                <div key={p.id} className="flex justify-between items-center bg-slate-700/50 p-3 rounded mb-2">
                                    <div>
                                        <span className="font-bold mr-2 text-lg">{p.name}</span>
                                        <span className="text-base text-slate-300">({p.roleName} Lv.{p.level})</span>
                                        {p.isDead && <span className="text-red-500 font-bold ml-2 text-sm">DEATH</span>}
                                    </div>
                                    <div className="text-right">
                                        <span className={`font-bold text-lg block ${p.realTeam==='HERO'?'text-blue-400':'text-red-500'}`}>{p.realTeam==='HERO'?'å‹‡è€…':'é­”ç‹'}</span>
                                        <span className="text-xs text-yellow-200 block">ä¸ãƒ€ãƒ¡: {p.totalDamageDealt}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <button onClick={handleBackToTitleForce} className="mt-8 w-full max-w-md bg-green-600 py-4 rounded-xl font-bold text-xl shadow-lg">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
                </div>
            );

            if (isHandover && activePlayer) return <HandoverScreen nextPlayerName={activePlayer.name} onOpen={() => setIsHandover(false)} />;

            return (
                <div className="h-screen w-screen bg-slate-900 text-slate-200 flex flex-col overflow-hidden">
                    <GameStatusHUD bossHP={bossHP} bossMaxHP={bossMaxHP} players={players} turnOrder={turnOrder} turn={turn} maxTurn={maxTurn} phase={phase} activePlayerName={activePlayerName} onOpenRoleList={()=>setShowRoleList(true)} bossTurnCount={bossTurnCount} onBackToTitle={handleBackToTitle} />
                    {popup && <Popup {...popup} />}
                    {choicePopup && <ChoicePopup {...choicePopup} />}
                    <RoleListModal isOpen={showRoleList} onClose={()=>setShowRoleList(false)} />

                    <main className="flex-grow overflow-y-auto p-2 flex flex-col pt-24 md:pt-28">
                        {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»é™£å–¶ãƒ»ã‚¹ã‚­ãƒ«å¸¸æ™‚è¡¨ç¤º (å€‹åˆ¥è¡Œå‹•æ™‚ã®ã¿) */}
                        {['ROLE_CONFIRM', 'ACTION_SELECT', 'VOTE_SELECT', 'BOSS_SELECT'].includes(phase) && activePlayer && (
                            <section className={`flex-none bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl border border-slate-700 shadow-xl mb-4 relative overflow-hidden ${phase === 'BOSS_SELECT' ? 'p-6' : 'p-3'}`}>
                                <div className="absolute top-0 right-0 bg-yellow-600 text-xs px-3 py-1 rounded-bl text-white font-bold z-20">STATUS</div>
                                
                                {/* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒèƒŒæ™¯ */}
                                <div className="absolute right-0 bottom-0 w-1/2 h-full opacity-20 pointer-events-none z-0">
                                    <img src={ROLES[activePlayer.roleKey].img} className="w-full h-full object-contain object-right-bottom" onError={(e) => e.target.style.display = 'none'} />
                                </div>

                                <div className="relative z-10">
                                    {phase === 'ROLE_CONFIRM' ? (
                                        <div className={`mb-4 p-4 rounded-xl text-center font-black text-4xl border-4 shadow-xl ${activePlayer.realTeam === 'HERO' ? 'bg-blue-900/90 border-blue-400 text-blue-200' : 'bg-red-900/90 border-red-500 text-red-200'}`}>
                                            {activePlayer.realTeam === 'HERO' ? 'å‹‡è€…é™£å–¶' : 'é­”ç‹é™£å–¶'}
                                        </div>
                                    ) : (
                                        // é€šå¸¸æ™‚ã¯ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« (ã‚¢ã‚¤ã‚³ãƒ³è¿½åŠ )
                                        <div className="flex items-center gap-2 mb-2">
                                            <div className={`${phase === 'BOSS_SELECT' ? 'w-32 h-32' : 'w-12 h-12'} rounded-full border-2 border-yellow-500 bg-slate-800 overflow-hidden flex-none relative z-10 shadow-md transition-all`}>
                                                <img src={ROLES[activePlayer.roleKey].img} className="w-full h-full object-cover" onError={(e) => e.target.style.display = 'none'} />
                                            </div>
                                            <div>
                                                <div className="flex items-baseline gap-2">
                                                    <h2 className={`${phase === 'BOSS_SELECT' ? 'text-3xl' : 'text-2xl'} font-black text-yellow-500 drop-shadow-md leading-none transition-all`}>{activePlayer.roleName}</h2>
                                                    <span className={`${phase === 'BOSS_SELECT' ? 'text-3xl' : 'text-sm'} font-bold text-white bg-slate-700 px-2 rounded shadow transition-all`}>Lv.{activePlayer.level}</span>
                                                </div>
                                                <div className={`self-start mt-1 px-2 py-0.5 rounded font-bold border shadow inline-block ${activePlayer.realTeam === 'HERO' ? 'bg-blue-900/50 border-blue-500 text-blue-300' : 'bg-red-900/50 border-red-500 text-red-400'} ${phase === 'BOSS_SELECT' ? 'text-sm' : 'text-xs'} transition-all`}>
                                                    {activePlayer.realTeam === 'HERO' ? 'å‹‡è€…é™£å–¶' : 'é­”ç‹é™£å–¶'}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {phase === 'ROLE_CONFIRM' && (
                                        <>
                                            <div className="text-center mb-3">
                                                <div className="w-24 h-24 mx-auto bg-slate-800 rounded-full border-4 border-yellow-500 overflow-hidden mb-2 shadow-lg">
                                                    <img src={ROLES[activePlayer.roleKey].img} className="w-full h-full object-cover" onError={(e) => e.target.style.display = 'none'} />
                                                </div>
                                                <h2 className="text-3xl font-black text-yellow-500 drop-shadow-md">{activePlayer.roleName}</h2>
                                            </div>
                                            {/* ä¸¦ã³é †å¤‰æ›´: HP -> ATK -> DEF */}
                                            <div className="grid grid-cols-3 gap-3 text-center text-white mb-3">
                                                <div className="bg-slate-800/80 p-2 rounded border border-slate-600 backdrop-blur-sm">
                                                    <span className="text-xs text-slate-400 block">HP(ä½“åŠ›)</span>
                                                    <span className="text-xl font-bold">{activePlayer.maxHp}</span>
                                                </div>
                                                <div className="bg-slate-800/80 p-2 rounded border border-slate-600 backdrop-blur-sm">
                                                    <span className="text-xs text-slate-400 block">ATK(æ”»æ’ƒ)</span>
                                                    <span className="text-xl font-bold">{activePlayer.level * ROLES[activePlayer.roleKey].atk + (activePlayer.atkBonus||0)}</span>
                                                </div>
                                                <div className="bg-slate-800/80 p-2 rounded border border-slate-600 backdrop-blur-sm">
                                                    <span className="text-xs text-slate-400 block">DEF(é˜²å¾¡)</span>
                                                    <span className="text-xl font-bold">{activePlayer.level * ROLES[activePlayer.roleKey].def + (activePlayer.defBonus||0)}</span>
                                                </div>
                                            </div>
                                            <p className="text-sm text-slate-200 mb-3 italic text-center bg-slate-900/50 p-2 rounded">{ROLES[activePlayer.roleKey].desc}</p>
                                        </>
                                    )}
                                    
                                    {/* ç°¡æ˜“è¡¨ç¤º: HPã‚’ä¸Šã«ã€ATK/DEFã‚’ä¸‹ã«å¤‰æ›´ */}
                                    {phase !== 'ROLE_CONFIRM' && (
                                        <div className="mt-2">
                                            <div className="flex justify-between items-end mb-1">
                                                <span className="text-[10px] text-slate-400">HP</span>
                                                <span className="text-sm font-bold text-white">{activePlayer.currentHp} / {activePlayer.maxHp}</span>
                                            </div>
                                            <div className="mb-2">
                                                <HPBar current={activePlayer.currentHp} max={activePlayer.maxHp} showText={false} label={null} />
                                            </div>
                                            
                                            <div className={`flex gap-3 text-xs text-slate-300 mb-1 ${phase === 'BOSS_SELECT' ? 'ml-1 text-3xl' : 'ml-1 text-xs'} transition-all`}>
                                                <span>ATK: <b className="text-white">{activePlayer.level * ROLES[activePlayer.roleKey].atk + (activePlayer.atkBonus||0)}</b></span>
                                                <span>DEF: <b className="text-white">{activePlayer.level * ROLES[activePlayer.roleKey].def + (activePlayer.defBonus||0)}</b></span>
                                            </div>
                                        </div>
                                    )}

                                    {/* ã‚¹ã‚­ãƒ«æƒ…å ±è¡¨ç¤º (2ã¤) */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        <div className={`p-2 rounded border border-slate-600 backdrop-blur-sm ${activePlayer.uniqueSkillUsed ? 'bg-slate-800/50 opacity-60' : 'bg-slate-800/80'} h-full`}>
                                            <div className="flex justify-between items-center mb-1">
                                                <span className={`font-bold text-yellow-400 ${phase === 'BOSS_SELECT' ? 'text-lg' : 'text-xs'}`}>å›ºæœ‰: {ROLES[activePlayer.roleKey].uniqueSkill.name}</span>
                                                <span className={`font-bold px-2 py-0.5 rounded ${activePlayer.uniqueSkillUsed ? 'bg-red-900 text-red-300' : 'bg-green-900 text-green-300'} text-[10px]`}>
                                                    {ROLES[activePlayer.roleKey].uniqueSkill.type === 'PASSIVE' ? 'è‡ªå‹•' : activePlayer.uniqueSkillUsed ? 'ä½¿ç”¨æ¸ˆ' : 'æœªä½¿ç”¨'}
                                                </span>
                                            </div>
                                            <p className="text-[10px] text-slate-300 whitespace-pre-wrap break-words leading-tight">{formatSkillDesc(ROLES[activePlayer.roleKey].uniqueSkill.desc)}</p>
                                        </div>
                                        
                                        <div className={`p-2 rounded border border-slate-600 backdrop-blur-sm ${activePlayer.ultimateSkillUsed ? 'bg-slate-800/50 opacity-60' : 'bg-slate-800/80'} h-full`}>
                                            <div className="flex justify-between items-center mb-1">
                                                <span className={`font-bold text-red-400 ${phase === 'BOSS_SELECT' ? 'text-lg' : 'text-xs'}`}>å¿…æ®º: {ROLES[activePlayer.roleKey].ultimateSkill.name}</span>
                                                <span className={`font-bold px-2 py-0.5 rounded ${activePlayer.ultimateSkillUsed ? 'bg-red-900 text-red-300' : 'bg-green-900 text-green-300'} text-[10px]`}>
                                                    {activePlayer.ultimateSkillUsed ? 'ä½¿ç”¨æ¸ˆ' : 'æœªä½¿ç”¨'}
                                                </span>
                                            </div>
                                            <p className="text-[10px] text-slate-300 whitespace-pre-wrap break-words leading-tight">{formatSkillDesc(ROLES[activePlayer.roleKey].ultimateSkill.desc)}</p>
                                        </div>
                                    </div>

                                    {/* ã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚ºã®ã‚¹ã‚­ãƒ«ãƒœã‚¿ãƒ³ */}
                                    {phase === 'ACTION_SELECT' && !activePlayer.uniqueSkillUsed && ROLES[activePlayer.roleKey].uniqueSkill.type === 'QUEST_ACTIVE' && (
                                        <button onClick={handleUniqueSkill} className="mt-2 w-full bg-purple-600 text-white py-2 rounded font-bold text-base shadow animate-pulse hover:scale-105 transition">
                                            å›ºæœ‰ã‚¹ã‚­ãƒ«ç™ºå‹•
                                        </button>
                                    )}
                                </div>
                            </section>
                        )}

                        {/* ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
                        <div className="flex-grow flex flex-col justify-start overflow-y-auto"> {/* justify-startã«å¤‰æ›´ã—ã€overflow-y-autoã‚’è¿½åŠ  */}
                            {phase === 'ROLE_CONFIRM' && (
                                <div className="text-center py-4 pb-20"> {/* ä¸‹éƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */}
                                    {/* ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤: ãƒœã‚¿ãƒ³ã®ã¿é…ç½® */}
                                    <button onClick={finishRoleConfirm} className="w-full bg-slate-700 hover:bg-slate-600 text-white py-5 rounded-2xl font-bold shadow-lg text-2xl transition transform hover:scale-105">ç¢ºèªå®Œäº†</button>
                                </div>
                            )}

                            {phase === 'STRATEGY' && (
                                <div className="text-center h-full flex flex-col justify-start">
                                    <div className="text-6xl font-mono font-bold text-yellow-500 mb-2 flex-none">
                                        {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}
                                    </div>
                                    <p className="mb-4 text-lg text-slate-400 flex-none">ä½œæˆ¦ä¼šè­°ä¸­...</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4 text-left overflow-y-auto flex-grow content-start">
                                        {quests.map(q => (
                                            <div key={q.id} className={`bg-slate-800 p-3 rounded-xl border-2 ${q.borderColor} relative shadow-md`}>
                                                <div className="flex justify-between items-center mb-2">
                                                    <div className={`font-black text-lg ${q.color}`}>{q.title} <span className="text-base text-slate-400">({q.rank})</span></div>
                                                    <div className="flex items-center gap-2">
                                                         <span className="text-red-400 font-bold text-sm bg-red-900/30 px-2 py-1 rounded border border-red-500/30 whitespace-nowrap">
                                                            HP -{q.damageVal}
                                                         </span>
                                                         <div className="bg-slate-900/80 px-3 py-1 rounded border border-slate-600 text-center">
                                                            <span className="text-[10px] text-slate-400 block leading-none">å¿…è¦</span>
                                                            <span className="text-lg font-black text-white leading-none">{q.req}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <div className="text-base text-white font-bold">å ±é…¬: Lv +{q.rewardVal}</div>
                                                    <div className="text-sm font-bold text-yellow-200 bg-slate-700/50 px-2 py-1 rounded">è¨ä¼: {q.monsterName}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={() => { setTimeLeft(0); startActionPhase(); }} className="bg-green-600 text-white w-full py-4 rounded-xl font-bold shadow flex-none text-xl hover:bg-green-500 transition">ä¼šè­°çµ‚äº†</button>
                                </div>
                            )}

                            {phase === 'ACTION_SELECT' && (
                                <div className="flex-grow flex flex-col h-full overflow-hidden">
                                    <h3 className="text-center mb-3 text-lg text-slate-400 flex-none font-bold">è¡Œå‹•ã‚’é¸æŠ</h3>
                                    <div className="flex-grow overflow-y-auto pr-1 pb-4">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            {quests.map(q => (
                                                <div key={q.id} onClick={() => handleQuestClick(q)} className={`bg-slate-800 p-3 rounded-xl border-2 ${q.borderColor} active:bg-slate-700 cursor-pointer relative shadow-md hover:scale-[1.01] transition overflow-hidden`}>
                                                    {/* ä¿®æ­£: ãƒ€ãƒ¡ãƒ¼ã‚¸ã¨å¿…è¦äººæ•°ã‚’å³ä¸Šã«ä¸¦ã¹ã¦é…ç½® */}
                                                    <div className="absolute top-0 right-0 flex">
                                                        {/* ãƒ€ãƒ¡ãƒ¼ã‚¸ */}
                                                        <div className="bg-red-900/80 px-2 py-1 border-b border-l border-red-700 z-10 flex items-center">
                                                            <span className="text-xs text-red-200 font-bold">-{q.damageVal} HP</span>
                                                        </div>
                                                        {/* å¿…è¦äººæ•° */}
                                                        <div className="bg-slate-900/90 px-2 py-1 rounded-bl-xl border-b border-l border-slate-600 z-10 flex items-center">
                                                            <span className="text-[10px] text-slate-400 mr-1">å¿…è¦</span>
                                                            <span className="text-lg font-black text-white">{q.req}</span>
                                                            <span className="text-xs text-slate-400 ml-0.5">äºº</span>
                                                        </div>
                                                    </div>

                                                    <div className="mt-1">
                                                        <div className={`font-black text-lg ${q.color} mb-1`}>{q.title}</div>
                                                        <div className="text-base text-yellow-400 font-bold">å ±é…¬ Lv+{q.rewardVal} <span className="text-slate-400 text-sm ml-2">({q.monsterName})</span></div>
                                                    </div>
                                                    <div className="absolute bottom-2 right-2 px-2 py-0.5 text-sm text-blue-400 font-bold bg-slate-900 rounded border border-blue-900">ã‚¿ãƒƒãƒ—ã§å‚åŠ </div>
                                                </div>
                                            ))}
                                            
                                            <div onClick={() => handleTrainingClick()} className="bg-slate-800 p-5 rounded-xl border-2 border-yellow-500/50 active:bg-yellow-900/20 cursor-pointer flex flex-col justify-center items-center text-center hover:bg-slate-750 transition">
                                                <span className="text-4xl mb-2"> </span>
                                                <div className="font-bold text-yellow-300 text-xl">å€‹äººä¿®è¡Œ</div>
                                                <div className="text-sm text-slate-400">Lv+1 / HPå¤‰å‹•ãªã—</div>
                                            </div>
                                            <div onClick={() => handleRestClick()} className="bg-slate-800 p-5 rounded-xl border-2 border-green-500/50 active:bg-green-900/20 cursor-pointer flex flex-col justify-center items-center text-center hover:bg-slate-750 transition">
                                                <span className="text-4xl mb-2"> </span>
                                                <div className="font-bold text-green-300 text-xl">ä¼‘æ¯</div>
                                                <div className="text-sm text-slate-400">Lvå¤‰å‹•ãªã— / HPå…¨å›å¾©</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {phase === 'QUEST_RESULT' && (
                                <div className="text-center h-full flex flex-col">
                                    <h3 className="text-3xl font-bold text-white mb-6 flex-none">ã‚¯ã‚¨ã‚¹ãƒˆçµæœ</h3>
                                    <div className="space-y-3 mb-4 overflow-y-auto flex-grow">
                                        {questResults.map((res, idx) => (
                                            <div key={idx} className={`p-4 rounded-xl border-l-8 text-left bg-slate-800 shadow-md ${res.isSuccess?'border-green-500':'border-red-500'}`}>
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className={`font-black text-xl ${res.quest.color}`}>{res.quest.title}</span>
                                                    <span className={`px-4 py-1 rounded text-base font-black ${res.isSuccess?'bg-green-900 text-green-300':'bg-red-900 text-red-300'}`}>{res.isSuccess?'æˆåŠŸ':'å¤±æ•—'}</span>
                                                </div>
                                                <div className="text-lg text-slate-300">
                                                    å‚åŠ äººæ•°: <span className="font-bold text-white text-2xl">{res.participantsCount}</span> / {res.quest.req}
                                                    {res.heroSkill && <span className="text-yellow-400 ml-3 text-base font-bold">â˜…å‹‡è€…ã‚¹ã‚­ãƒ«ç™ºå‹•</span>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    {/* ä¿®æ­£: 1ã‚¿ãƒ¼ãƒ³ç›®ã¯è¿½æ”¾ä¼šè­°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ */}
                                    {turn === 1 ? (
                                        <button onClick={() => startNewTurn(window.tempClearedIds || [])} className="bg-green-600 w-full py-5 rounded-xl font-bold shadow flex-none text-2xl hover:bg-green-500 transition">æ¬¡ã®æ—¥ã¸</button>
                                    ) : (
                                        <button onClick={startVoteDiscussion} className="bg-blue-600 w-full py-5 rounded-xl font-bold shadow flex-none text-2xl hover:bg-blue-500 transition">è¿½æ”¾ä¼šè­°ã¸</button>
                                    )}
                                </div>
                            )}

                            {phase === 'VOTE_DISCUSS' && (
                                <div className="text-center h-full flex flex-col justify-center">
                                    <div className="text-7xl font-mono font-bold text-red-500 mb-8">{Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}</div>
                                    <p className="mb-10 text-2xl font-bold">è¿½æ”¾ä¼šè­°ä¸­...</p>
                                    <button onClick={() => { setTimeLeft(0); startVoteSelect(); }} className="bg-red-600 w-full py-6 rounded-2xl font-bold shadow-lg text-3xl hover:bg-red-500 transition">æŠ•ç¥¨ã¸</button>
                                </div>
                            )}

                            {phase === 'VOTE_SELECT' && (
                                <div className="flex-grow flex flex-col h-full">
                                    <h3 className="text-center text-red-400 mb-6 font-bold text-2xl flex-none">è¿½æ”¾ã™ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ</h3>
                                    <div className="grid grid-cols-2 gap-4 overflow-y-auto flex-grow mb-4 pr-1">
                                        {players.filter(p => !p.isDead && p.id !== activePlayerId).map(p => (
                                            <button key={p.id} onClick={()=>handleVote(p.id)} className="bg-slate-800 border-4 border-slate-600 active:bg-red-900/50 p-4 rounded-2xl font-bold text-2xl h-36 flex items-center justify-center shadow-lg hover:border-red-500 transition overflow-hidden relative">
                                                {/* èƒŒæ™¯ç”»åƒ */}
                                                {/* <div className="absolute inset-0 opacity-30">
                                                    <img src={ROLES[p.roleKey].img} className="w-full h-full object-cover grayscale" onError={(e) => e.target.style.display = 'none'} />
                                                </div> */}
                                                <span className="relative z-10 drop-shadow-lg">{p.name}</span>
                                            </button>
                                        ))}
                                    </div>
                                    <button onClick={()=>handleVote(null)} className="w-full bg-slate-700 py-5 rounded-xl font-bold text-slate-300 flex-none text-xl hover:bg-slate-600 transition">ã‚¹ã‚­ãƒƒãƒ—</button>
                                </div>
                            )}

                            {/* è¿½åŠ : æŠ•ç¥¨å®Œäº†å¾Œã®å¾…æ©Ÿç”»é¢ */}
                            {phase === 'EXILE_READY' && (
                                <div className="h-full flex flex-col justify-center items-center text-center p-4">
                                    <h2 className="text-3xl font-bold mb-8 text-white">æŠ•ç¥¨ãŒçµ‚äº†ã—ã¾ã—ãŸ</h2>
                                    <p className="text-xl text-slate-300 mb-10">ä¼šè­°ã®çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                                    <button onClick={() => setPhase('EXILE_RESULT')} className="bg-blue-600 hover:bg-blue-500 text-white px-12 py-6 rounded-2xl font-bold text-2xl shadow-lg animate-pulse">
                                        ä¼šè­°çµæœã‚’è¦‹ã‚‹
                                    </button>
                                </div>
                            )}

                            {/* è¿½åŠ : è¿½æ”¾çµæœç”»é¢ */}
                            {phase === 'EXILE_RESULT' && exileResult && (
                                <div className="h-full flex flex-col justify-center items-center text-center p-4">
                                    <h2 className="text-3xl font-black mb-6 text-red-500 border-b-4 border-red-900 pb-2">è¿½æ”¾çµæœ</h2>
                                    
                                    {exileResult.banished ? (
                                        <div className="bg-slate-800 p-4 rounded-2xl border-2 border-red-600 shadow-2xl w-full max-w-md mb-4 animate-fadeIn">
                                            <p className="text-xl text-slate-300 mb-4">è¿½æ”¾ã•ã‚ŒãŸã®ã¯...</p>
                                            <div className="w-32 h-32 mx-auto rounded-full overflow-hidden border-4 border-red-500 mb-4 shadow-lg relative">
                                                <img src={ROLES[exileResult.banished.roleKey].img} className="w-full h-full object-cover" />
                                                <div className="absolute inset-0 bg-red-900/30 mix-blend-multiply"></div>
                                            </div>
                                            <h3 className="text-3xl font-black text-white mb-2">{exileResult.banished.name}</h3>
                                            <div className="space-y-2 bg-slate-900/50 p-3 rounded-xl mt-4">
                                                <div className="flex justify-between border-b border-slate-700 pb-1">
                                                    <span className="text-slate-400">è·æ¥­</span>
                                                    <span className="font-bold text-yellow-400 text-xl">{exileResult.banished.roleName}</span>
                                                </div>
                                                <div className="flex justify-between pt-1">
                                                    <span className="text-slate-400">æ­£ä½“</span>
                                                    <span className={`font-black text-2xl ${exileResult.banished.realTeam === 'HERO' ? 'text-blue-400' : 'text-red-500'}`}>
                                                        {exileResult.banished.realTeam === 'HERO' ? 'å‹‡è€…é™£å–¶' : 'é­”ç‹é™£å–¶'}
                                                    </span>
                                                </div>
                                            </div>
                                            <p className="mt-4 text-red-300 font-bold text-lg">è¿½æ”¾ã•ã‚Œã¾ã—ãŸã€‚</p>
                                        </div>
                                    ) : (
                                        <div className="bg-slate-800 p-8 rounded-2xl border-2 border-slate-600 shadow-xl w-full max-w-md mb-8">
                                            <div className="text-6xl mb-4">ğŸ•Šï¸</div>
                                            <h3 className="text-2xl font-bold text-white mb-4">è¿½æ”¾è€…ãªã—</h3>
                                            <p className="text-slate-300 text-lg">{exileResult.message}</p>
                                        </div>
                                    )}

                                    <button onClick={() => startNewTurn(window.tempClearedIds || [])} className="bg-green-600 hover:bg-green-500 text-white px-16 py-5 rounded-xl font-bold text-2xl shadow-lg transition">
                                        æ¬¡ã®æ—¥ã¸
                                    </button>
                                </div>
                            )}

                            {phase === 'BOSS_INTRO' && (
                                <div className="text-center py-10 flex flex-col items-center justify-center h-full">
                                    <div className="w-48 h-48 mb-6 animate-pulse">
                                        <img src={IMAGES.BOSS} className="w-full h-full object-contain drop-shadow-2xl" onError={(e) => e.target.style.display = 'none'} />
                                    </div>
                                    <h2 className="text-6xl font-black text-purple-500 mb-6 animate-bounce">é­”ç‹æˆ¦ é–‹å§‹</h2>
                                    <p className="mb-10 text-xl text-slate-300 font-bold">3ãƒ©ã‚¦ãƒ³ãƒ‰è€ãˆã‚ã€‚<br/>è£åˆ‡ã‚Šè€…ã¯å‘³æ–¹ã‚’æ”»æ’ƒå¯èƒ½ã€‚</p>
                                    <button onClick={startBossBattleRound} className="bg-purple-600 text-white px-16 py-6 rounded-full text-3xl font-bold shadow-lg hover:bg-purple-500 transition transform hover:scale-105">æˆ¦é—˜é–‹å§‹ï¼</button>
                                </div>
                            )}

                            {phase === 'BOSS_ACTION_ANNOUNCE' && (
                                <div className="text-center py-10 flex flex-col items-center justify-center h-full">
                                    {/* å¤‰æ›´ç‚¹: é™æ­¢ç”»ã§ã¯ãªãã€è¡Œå‹•ã«å¿œã˜ãŸç”»åƒã‚’è¡¨ç¤º */}
                                    <div className="w-64 h-64 mb-6"> {/* ã‚µã‚¤ã‚ºã‚’å°‘ã—å¤§ããèª¿æ•´ */}
                                        <img src={IMAGES[bossNextAction?.imgKey]} alt={bossNextAction?.name} className="w-full h-full object-contain drop-shadow-2xl animate-bounce" onError={(e) => e.target.style.display = 'none'} />
                                    </div>
                                    <h2 className="text-4xl font-black text-red-500 mb-4">é­”ç‹ã®è¡Œå‹•</h2>
                                    
                                    <div className="bg-slate-800/90 border-4 border-red-600 p-8 rounded-2xl mb-10 text-center shadow-red-900/50 shadow-lg w-full max-w-lg">
                                        <div className="text-xl text-red-400 font-bold mb-2">äºˆå…†</div>
                                        <div className="text-5xl font-black text-white mb-4">{bossNextAction?.name}</div>
                                        <div className="text-2xl text-slate-300">{bossNextAction?.desc}</div>
                                        <div className="text-xl text-orange-400 font-bold mt-4 bg-slate-900/50 p-2 rounded">
                                            {getBossActionDetail(bossNextAction, bossInitialPlayerCount)}
                                        </div>
                                    </div>

                                    <p className="text-slate-400 mb-6 text-lg">å…¨å“¡ã§ç¢ºèªã—ã¦ãã ã•ã„</p>
                                    <button onClick={proceedToBossPlayerSelect} className="bg-blue-600 text-white px-16 py-5 rounded-full text-3xl font-bold shadow-lg hover:bg-blue-500 transition transform hover:scale-105">
                                        è¡Œå‹•é–‹å§‹
                                    </button>
                                </div>
                            )}

                            {phase === 'BOSS_SELECT' && (
                                <div className="h-full flex flex-col justify-center items-center relative">
                                    {/* é­”ç‹ç”»åƒèƒŒæ™¯ (å‰Šé™¤) */}
                                    {/* <div className="absolute top-0 left-1/2 transform -translate-x-1/2 w-64 h-64 opacity-10 pointer-events-none">
                                        <img src={IMAGES.BOSS} className="w-full h-full object-contain" />
                                    </div> */}

                                    <h3 className="text-3xl font-bold text-center text-red-500 mb-12 relative z-10">è¡Œå‹•ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
                                    <button onClick={handleBossTurnStart} className="bg-blue-600 text-white w-full py-8 rounded-3xl font-bold text-4xl shadow-xl animate-pulse hover:bg-blue-500 transition relative z-10">
                                        è¡Œå‹•ã‚’é¸æŠã™ã‚‹
                                    </button>
                                </div>
                            )}

                            {phase === 'BOSS_RESULT' && (
                                <div className="h-full flex flex-col bg-slate-800 rounded-xl border border-slate-600 overflow-hidden shadow-2xl relative">
                                    {/* é­”ç‹ç”»åƒèƒŒæ™¯ */}
                                    <div className="absolute right-0 top-0 w-32 h-32 opacity-10 pointer-events-none">
                                        <img src={IMAGES.BOSS} className="w-full h-full object-contain" />
                                    </div>
                                    <h3 className="text-2xl font-bold text-center py-4 border-b border-slate-600 bg-slate-800 flex-none">ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ</h3>
                                    <div className="flex-grow overflow-y-auto p-6 text-lg space-y-3 bg-slate-900/50 relative z-10">
                                        {bossBattleLog.map((log, i) => (
                                            <div key={i} className={`border-b border-slate-700/30 pb-2 ${log.type === 'info' ? 'text-blue-300 font-bold mt-4 pt-2 border-t border-slate-600 text-xl' : log.type === 'success' ? 'text-green-400 font-bold' : ''}`}>
                                                {log.type === 'damage' ? (
                                                    <span>{log.text.split(/(\d+)/).map((part, idx) => /\d+/.test(part) ? <span key={idx} className="text-orange-400 font-black text-2xl">{part}</span> : part)}</span>
                                                ) : log.type === 'death' ? (
                                                    <span className="text-red-500 font-black text-xl">{log.text}</span>
                                                ) : (
                                                    <span>{log.text}</span>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                    
                                    {/* ãƒ€ãƒ¡ãƒ¼ã‚¸é›†è¨ˆè¡¨ç¤º */}
                                    <div className="bg-slate-900/80 p-4 relative z-10 border-t border-slate-600">
                                        <h4 className="text-center text-yellow-400 font-bold mb-2 text-sm">--- ä»Šãƒ©ã‚¦ãƒ³ãƒ‰ã®é­”ç‹ã¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ ---</h4>
                                        <div className="grid grid-cols-2 gap-2 text-xs">
                                            {Object.entries(roundDamageReport).length > 0 ? (
                                                Object.entries(roundDamageReport)
                                                    .sort(([, a], [, b]) => b - a)
                                                    .map(([pid, dmg]) => {
                                                        const p = players.find(pl => pl.id === parseInt(pid));
                                                        return (
                                                            <div key={pid} className="flex justify-between items-center bg-slate-800 p-1.5 rounded border border-slate-700">
                                                                <span className="font-bold text-white truncate">{p?.name}</span>
                                                                <span className="font-black text-orange-400 text-base">{dmg}</span>
                                                            </div>
                                                        );
                                                    })
                                            ) : (
                                                <div className="col-span-2 text-center text-slate-500">ãƒ€ãƒ¡ãƒ¼ã‚¸ãªã—</div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="p-6 border-t border-slate-600 bg-slate-800 flex-none relative z-10">
                                        <button onClick={nextBossRound} className="w-full bg-blue-600 text-white py-5 rounded-xl font-bold shadow-lg text-2xl hover:bg-blue-500 transition">
                                            æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
