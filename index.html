<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>È≠îÁéã„ÇíÂÄí„ÅôÂâç„Å´„ÄÅ„Åæ„Åö„ÅäÂâç„ÇíËøΩÊîæ„Åô„Çã</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap');
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-anim { animation: fadeIn 0.3s ease-out forwards; }
        
        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .scan-line { 
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.05) 50%, rgba(255,255,255,0));
            background-size: 100% 4px;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 9999;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-screen overflow-hidden"></div>
    <div class="scan-line"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- „ÉÜ„Ç≠„Çπ„Éà„Éá„Éº„Çø ---
        const GAME_TEXTS = {
            TITLE: "È≠îÁéã„ÇíÂÄí„ÅôÂâç„Å´„ÄÅ„Åæ„Åö„ÅäÂâç„ÇíËøΩÊîæ„Åô„Çã",
            STORY: [
                "ÈÅ•„ÅãÊòî„ÄÅÂπ≥Âíå„Å†„Å£„ÅüÁéãÂõΩ„Å´È≠îÁéã„ÅÆÂΩ±„ÅåÂøç„Å≥ÂØÑ„Å£„Åü„ÄÇ",
                "ÂõΩÁéã„ÅØÂêÑÂú∞„Åã„ÇâÂãáÁåõ„Å™Êà¶Â£´„Åü„Å°„ÇíÊãõÈõÜ„Åó„ÄÅÈ≠îÁéãË®é‰ºêÈöä„ÇíÁµêÊàê„Åô„Çã„ÄÇ",
                "„Åó„Åã„Åó„ÄÅ„Åù„ÅÆ‰∏≠„Å´„ÅØÈ≠îÁéã„Å´È≠Ç„ÇíÂ£≤„Å£„Åü„ÄåË£èÂàá„ÇäËÄÖ„Äç„ÅåÁ¥õ„ÇåËæº„Çì„Åß„ÅÑ„Çã„Å®„ÅÆ„ÅÜ„Çè„Åï„Åå....",
                "Ë£èÂàáËÄÖ„ÇíËøΩÊîæ„Åó„ÄÅ„ÇØ„Ç®„Çπ„Éà„Çí„ÇØ„É™„Ç¢„Åó„Å¶„É¨„Éô„É´„Çí‰∏ä„ÅíÈ≠îÁéã„ÇíË®é‰ºê„Åó„Çà„ÅÜÔºÅ"
            ],
            NOTE: "‚ÄªËÅ∑Ê•≠„Åî„Å®„Å´„Çπ„Ç≠„É´„ÅåÂ≠òÂú®„Åó„ÄÅË£èÂàáËÄÖ„ÇíÁô∫Ë¶ã„Åô„Çã„Çπ„Ç≠„É´„ÇÑÈ≠îÁéãË®é‰ºê„ÅÆÈöõ„Å´ÊúâÂäπ„Å™„Çπ„Ç≠„É´„Å™„Å©Êßò„ÄÖ„Å™„ÇÇ„ÅÆ„ÅåÂ≠òÂú®„Åæ„Åô„ÄÇ"
        };

        // --- ÁîªÂÉè„Ç¢„Çª„ÉÉ„Éà ---
        const IMAGES = {
            BOSS: 'È≠îÁéã.png',
            BOSS_NORMAL: 'È≠îÁéã-ÈÄöÂ∏∏ÊîªÊíÉ.jpg',
            BOSS_MAGIC: 'È≠îÁéã-È≠îÊ≥ïÊîªÊíÉ.jpg',
            BOSS_HELLFIRE: 'È≠îÁéã-Èóá„ÅÆÁçÑÁÇé.jpg',
            BOSS_ROAR: 'È≠îÁéã-È≠îÁéã„ÅÆÂíÜÂìÆ.jpg',
            HEADER: '„Éò„ÉÉ„ÉÄ„Éº.png' 
        };

        // S„É©„É≥„ÇØ‰ª•‰∏ä„ÅÆ„É¢„É≥„Çπ„Çø„ÉºÁîªÂÉè„Éû„ÉÉ„Éî„É≥„Ç∞
        const MONSTER_IMAGES = {
            '‰∏çÊ≠ªÈ≥•„Éï„Çß„Éã„ÉÉ„ÇØ„Çπ': '‰∏çÊ≠ªÈ≥•„Éï„Çß„Éã„ÉÉ„ÇØ„Çπ.png',
            'Ê≠ªÁ´úÁéã„Éê„É´„ÉÄ„Ç∞': 'Ê≠ªÁ´úÁéã„Éê„É´„ÉÄ„Ç∞.png',
            '„É¨„Ç¢„Çπ„É©„Ç§„É†': '„É¨„Ç¢„Çπ„É©„Ç§„É†.png'
        };

        // --- „É¢„É≥„Çπ„Çø„Éº„Éá„Éº„Çø ---
        const MONSTERS = {
            C: ['„Çπ„É©„Ç§„É†', '„Ç¥„Éñ„É™„É≥', '„Ç≥„Éú„É´„Éà', '„Ç™„Éº„ÇØ', '„Ç¥„Éº„Çπ„Éà', '„Å°„Å≥„Éâ„É©„Ç¥„É≥', '„Ç¶„É´„Éï', '„É¨„ÉÉ„Éâ„É©„Éì„ÉÉ„Éà', '„Éõ„Éº„Éç„ÉÉ„Éà', '„Çπ„Ç±„É´„Éà„É≥', '„Ç≠„É©„Éº„Ç¢„É≥„Éà'],
            B: ['„Ç™„Éº„Ç¨', '„ÉØ„Ç§„Éà', '„É™„Ç∂„Éº„Éâ', '„Ç¥„Éñ„É™„É≥„ÇΩ„É´„Ç∏„É£„Éº', '„Ç¢„É≥„Éá„ÉÉ„Éà„Éõ„Éº„Çπ', '„Éà„É≠„Éº„É´', '„Ç¥„Éº„É¨„É†'],
            A: ['„ÉØ„Ç§„Éê„Éº„É≥', '„Ç¥„Éñ„É™„É≥„Ç≠„É≥„Ç∞', '„É¥„Ç°„É≥„Éë„Ç§„Ç¢', '„Éñ„É©„ÉÉ„ÇØ„Çπ„Ç≥„Éº„Éî„Ç™„É≥'],
            S: ['Ê≠ªÁ´úÁéã„Éê„É´„ÉÄ„Ç∞', '‰∏çÊ≠ªÈ≥•„Éï„Çß„Éã„ÉÉ„ÇØ„Çπ']
        };

        // --- ËÅ∑Ê•≠„Éá„Éº„ÇøÂÆöÁæ© ---
        const ROLES = {
            HERO: { 
                name: 'ÂãáËÄÖ', atk: 3, hp: 4, def: 3, img: 'ÂãáËÄÖ.png',
                desc: 'ÊîªÂÆà„Å®„ÇÇ„Å´Á©¥„ÅÆ„Å™„ÅÑ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅåÁâπÂæ¥',
                uniqueSkill: { name: 'ÂãáËÄÖ„ÅÆË©¶Á∑¥', type: 'QUEST_ACTIVE', desc: '„Äê„É¶„Éã„Éº„ÇØ„ÄëÊ¨°„Å´ÈÅ∏Êäû„Åô„ÇãS„É©„É≥„ÇØ‰ª•‰∏ã„ÅÆ‰ªªÊÑè„ÅÆ„ÇØ„Ç®„Çπ„Éà„ÇíÂøÖË¶Å‰∫∫Êï∞„Å´Èñ¢‰øÇ„Å™„Åè‰∏Ä‰∫∫„Åß„ÇØ„É™„Ç¢„Åß„Åç„Çã' },
                ultimateSkill: { name: 'ËÅñ„Å™„ÇãÊñ¨ÊíÉ', type: 'BOSS_ACTIVE', desc: 'Áîü„ÅçÊÆã„Å£„Å¶„ÅÑ„ÇãÂë≥ÊñπÈô£Âñ∂„ÅÆÂêàË®àATK√ó1.5„ÅÆ„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã' }
            },
            WARRIOR: { 
                name: 'Êà¶Â£´', atk: 4, hp: 3, def: 2, img: 'Êà¶Â£´.png',
                desc: '„Éê„É©„É≥„Çπ„ÅÆ„ÅÑ„ÅÑ„Ç¢„Çø„ÉÉ„Ç´„Éº',
                uniqueSkill: { name: 'Êà¶Â£´„ÅÆË®º', type: 'PASSIVE', desc: '„Äê„Éë„ÉÉ„Ç∑„Éñ„Äë„ÇØ„Ç®„Çπ„Éà„ÇíÊàêÂäü„Åô„Çã„Åü„Å≥„Å´ATK„Åå+1„Åï„Çå„Çã' },
                ultimateSkill: { name: 'Ê∏æË∫´Êñ¨„Çä', type: 'BOSS_ACTIVE', desc: 'È≠îÁéã„ÇÇ„Åó„Åè„ÅØ„Éó„É¨„Ç§„É§„Éº„Å´ÁèæÂú®„ÅÆATK√ó2.5„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã' }
            },
            MAGE: { 
                name: 'È≠îÊ≥ï‰Ωø„ÅÑ', atk: 4, hp: 3, def: 1, img: 'È≠îÊ≥ï‰Ωø„ÅÑ.png',
                desc: 'ÁÅ´Âäõ„ÅåÈ´ò„ÅÑÈ≠îÊ≥ï„Ç¢„Çø„ÉÉ„Ç´„Éº',
                uniqueSkill: { name: 'È≠îÊ≥ïÊÑüÁü•', type: 'QUEST_ACTIVE', desc: '„Äê„É¶„Éã„Éº„ÇØ„ÄëÈÅ∏Êäû„Åó„Åü„Éó„É¨„Ç§„É§„Éº„ÅÆËÅ∑Ê•≠„Å®Èô£Âñ∂„ÇíÁõó„ÅøË¶ã„Çã„Åì„Å®„Åå„Åß„Åç„Çã' },
                ultimateSkill: { name: 'Âº∑ÂåñÈ≠îÊ≥ï', type: 'BOSS_ACTIVE', desc: 'ÈÅ∏Êäû„Åó„Åü„Éó„É¨„Ç§„É§„Éº„ÅÆATK+10 DEF+5 „Åô„Çã' }
            },
            CLERIC: { 
                name: 'ÂÉß‰æ∂', atk: 1, hp: 5, def: 2, img: 'ÂÉß‰æ∂.png',
                desc: 'ÂõûÂæ©„ÅåÂæóÊÑè„Å™„Çµ„Éù„Éº„Çø„Éº',
                uniqueSkill: { name: 'ÊÖàÊÑõ„ÅÆÊÇü„Çä', type: 'QUEST_ACTIVE', desc: '„Äê„É¶„Éã„Éº„ÇØ„ÄëÈÅ∏Êäû„Åó„Åü„Éó„É¨„Ç§„É§„Éº„ÇíÂº∑Âà∂ÁöÑ„Å´ÂãáËÄÖÈô£Âñ∂„Å∏„Å®Â§âÊõ¥„Åï„Åõ„Çã' },
                ultimateSkill: { name: 'ÂõûÂæ©È≠îÊ≥ï', type: 'BOSS_ACTIVE', desc: '„Éó„É¨„Ç§„É§„ÉºÂÖ®Âì°„ÅÆHP„Çí„Éó„É¨„Ç§„É§„ÉºÊï∞√ó4ÂõûÂæ©„Åï„Åõ„Çã' }
            },
            KNIGHT: { 
                name: 'È®éÂ£´', atk: 2, hp: 4, def: 4, img: 'È®éÂ£´.png',
                desc: 'ËÄê‰πÖÂäõ„ÅåÈ≠ÖÂäõ„ÅÆ„Éá„Ç£„Éï„Çß„É≥„ÉÄ„Éº',
                uniqueSkill: { name: 'Â±àÂº∑„Å™ËÇâ‰Ωì', type: 'PASSIVE', desc: '„Äê„Éë„ÉÉ„Ç∑„Éñ„Äë„ÇØ„Ç®„Çπ„Éà„Å´ÂèÇÂä†ÊôÇËá™Ë∫´„ÅåÂèó„Åë„Çã„ÉÄ„É°„Éº„Ç∏„Çí1ËªΩÊ∏õ„Åï„Åõ„Çã' },
                ultimateSkill: { name: '„Åã„Å∞„ÅÜ', type: 'BOSS_ACTIVE', desc: 'È≠îÁéã„Åã„Çâ„ÅÆÊîªÊíÉ„Åã„ÄÅ„Éó„É¨„Ç§„É§„Éº„Åã„Çâ„ÅÆÊîªÊíÉ„ÇíÈÅ∏Êäû„Åó„Å¶Ëá™ÂàÜ„Å´ÈõÜ‰∏≠„Åï„Åõ„Çã' }
            },
            MONK: { 
                name: 'Ê†ºÈóòÂÆ∂', atk: 5, hp: 3, def: 0, img: 'Ê≠¶ÈóòÂÆ∂.png',
                desc: 'È´òÁÅ´Âäõ„Ç¢„Çø„ÉÉ„Ç´„Éº„ÄÇËÄê‰πÖÂäõ„ÅåË™≤È°å',
                uniqueSkill: { name: 'Â≠§Áã¨„ÅÆ‰øÆË°å', type: 'PASSIVE', desc: '„Äê„Éë„ÉÉ„Ç∑„Éñ„Äë„ÇØ„Ç®„Çπ„Éà„ÇíËá™ÂàÜ‰∏Ä‰∫∫„Åß„ÇØ„É™„Ç¢„Åó„Åü„Å®„Åç„ÄÅ‰∏ä„Åå„Çã„É¨„Éô„É´„Å´+1„Åï„Çå„Çã' },
                ultimateSkill: { name: 'Ê≠£Êã≥Á™Å„Åç', type: 'BOSS_ACTIVE', desc: '1„Çø„Éº„É≥„ÅÆ„Åü„ÇÅ„ÅåÂøÖË¶Å„Å†„ÅåÊ¨°„ÅÆ„Çø„Éº„É≥È≠îÁéã„ÇÇ„Åó„Åè„ÅØ„Éó„É¨„Ç§„É§„Éº„Å´ÁèæÂú®„ÅÆATK√ó3.5„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„ÇãÊîªÊíÉ„ÇíË°å„ÅÜ' }
            },
            THIEF: { 
                name: 'ÁõóË≥ä', atk: 3, hp: 3, def: 2, img: 'ÁõóË≥ä.png', 
                desc: '„Éà„É™„ÉÉ„Ç≠„Éº„Å™Âãï„Åç„ÅßÂ†¥„ÇíÊî™‰π±„Åô„Çã',
                uniqueSkill: { name: 'ÁõóË≥ä„ÅÆÊ•µÊÑè', type: 'QUEST_ACTIVE', desc: '„Äê„É¶„Éã„Éº„ÇØ„ÄëÊåáÂÆö„Åó„Åü„Éó„É¨„Ç§„É§„Éº„Å®Èô£Âñ∂„ÇíÂÖ•„ÇåÊõø„Åà„Çã„Åì„Å®„Åå„Åß„Åç„Çã' },
                ultimateSkill: { name: 'ÊÄ•ÊâÄ‰∏ÄÈñÉ', type: 'BOSS_ACTIVE', desc: 'È≠îÁéã„ÅÆÊúÄÂ§ßHP„ÅÆ1/5„ÅÆ„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã„ÄÇ„Éó„É¨„Ç§„É§„Éº„ÇíÈÅ∏Êäû„Åó„ÅüÂ†¥Âêà„ÅØATK√ó5„ÉÄ„É°„Éº„Ç∏' }
            },
            SPIRIT: {
                name: 'Á≤æÈúä‰Ωø„ÅÑ', atk: 2, hp: 5, def: 2, img: 'Á≤æÈúä‰Ωø„ÅÑ.png',
                desc: 'Âπ≥ÂùáÁöÑ„Å™„Çπ„ÉÜ„Éº„Çø„Çπ„ÄÇ„Çπ„Ç≠„É´„ÅßÂ†¥„ÇíÂà∂Âæ°',
                uniqueSkill: { name: 'Á≤æÈúä„ÅÆË™ì„ÅÑ', type: 'QUEST_ACTIVE', desc: '„Äê„É¶„Éã„Éº„ÇØ„Äë„Å©„ÅÆËÅ∑Ê•≠„Åå‰ªäÂõû„ÅÆ„Ç≤„Éº„É†„ÅßÂèÇÂä†„Åó„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Çã(Ë™∞„Åå„Å©„ÅÆËÅ∑Ê•≠„Åã„ÅØ‰∏çÊòé)' },
                ultimateSkill: { name: 'Á≤æÈúä„ÅÆÂä†Ë≠∑', type: 'BOSS_ACTIVE', desc: '„Åì„ÅÆ„Çø„Éº„É≥„ÅÆÈ≠îÁéã„ÅÆÊîªÊíÉ„ÇíÈÄöÂ∏∏ÊîªÊíÉ„Å∏„Å®Âº∑Âà∂ÁöÑ„Å´Â§âÊõ¥„Åï„Åõ„Çã' }
            },
            BARRIER_MASTER: {
                name: 'ÁµêÁïåÂ∏´', atk: 2, hp: 3, def: 3, img: 'ÁµêÁïåÂ∏´.png',
                desc: 'ÈâÑÂ£Å„ÅÆÂÆà„Çä„ÇíÊåÅ„Å§„ÅåÊîªÊíÉ„ÅØËã¶Êâã',
                uniqueSkill: { name: 'ÁµêÁïåÂ±ïÈñã', type: 'QUEST_ACTIVE', desc: '„Äê„É¶„Éã„Éº„ÇØ„ÄëÈ≠îÁéãÈô£Âñ∂„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆ‰∫∫Êï∞„ÇíÁü•„Çã„Åì„Å®„Åå„Åß„Åç„Çã' },
                ultimateSkill: { name: 'ÁµêÁïåË°ì', type: 'BOSS_ACTIVE', desc: 'È≠îÁéã„ÇÇ„Åó„Åè„ÅØ„Éó„É¨„Ç§„É§„Éº1Âêç„ÅÆË°åÂãï„Çí1„Çø„Éº„É≥Â∞Å„Åò„Çã' }
            },
            PLAYBOY: {
                name: 'ÈÅä„Å≥‰∫∫', atk: 2, hp: 3, def: 1, img: 'ÈÅä„Å≥‰∫∫.png',
                desc: '‰∫àÊ∏¨‰∏çËÉΩ„Å™Âãï„Åç„ÅßÂ†¥„Çí„Åã„Åç‰π±„Åô',
                uniqueSkill: { name: 'Áßò„ÇÅ„Åü„Çã„Å°„Åã„Çâ', type: 'PASSIVE', desc: '„Äê„Éë„ÉÉ„Ç∑„Éñ„ÄëÁâπÂÆö„ÅÆ„É¨„Éô„É´„ÇíË∂Ö„Åà„ÅüÂ†¥ÂêàËÅ∑Ê•≠„Åå„ÄåË≥¢ËÄÖ„Äç„Å´ÈÄ≤Âåñ(„Éó„É¨„Ç§‰∫∫Êï∞√ó2+2„É¨„Éô„É´„ÅßÈÄ≤Âåñ)' },
                ultimateSkill: { name: '„ÅÇ„Åù„Å∂', type: 'BOSS_ACTIVE', desc: '„Å™„Å´„ÇÇËµ∑„Åì„Çâ„Å™„ÅÑ„ÄÇ' }
            },
            SAGE: {
                name: 'Ë≥¢ËÄÖ', atk: 4, hp: 4, def: 2, img: 'Ë≥¢ËÄÖ.png',
                desc: 'ÂúßÂÄíÁöÑ„Å™Áü•Ë≠ò„Å®È≠îÂäõ„ÇíÊåÅ„Å§‰∏äÁ¥öËÅ∑',
                uniqueSkill: { name: 'Âè°Êô∫„ÅÆÂÆöÂºè', type: 'PASSIVE', desc: '„Äê„Éë„ÉÉ„Ç∑„Éñ„Äë„ÇØ„Ç®„Çπ„Éà„ÇíÊàêÂäü„Åô„Çã„Åü„Å≥„Å´HP„Å®ATK„Åå+1„Åï„Çå„Çã' },
                ultimateSkill: { name: 'ÊòüËæ∞„ÅÆÂØ©Âà§', type: 'BOSS_ACTIVE', desc: 'È≠îÁéã„ÇÇ„Åó„Åè„ÅØ„Éó„É¨„Ç§„É§„Éº„Å´Âõ∫ÂÆö100„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„ÅàËá™Ë∫´„ÅÆHP„Çí20ÂõûÂæ©' }
            }
        };

        // --- „Éò„É´„Éë„ÉºÈñ¢Êï∞ ---
        const formatSkillDesc = (text) => {
            if (!text) return "";
            // 30ÊñáÂ≠óÂà∂Èôê„ÅØÊí§ÂªÉ„Åó„ÄÅCSS„ÅÆbreak-words„Å´‰ªª„Åõ„Çã„Åü„ÇÅ„ÄÅ„Åù„ÅÆ„Åæ„ÅæËøî„Åô
            return text;
        };

        // --- „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà ---
        const RoleListModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-2" onClick={onClose}>
                    <div className="bg-slate-800 rounded-xl p-4 w-full max-w-5xl max-h-[95vh] overflow-y-auto border border-slate-600 modal-anim flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-2 flex-none">
                            <h2 className="text-xl font-bold text-yellow-400">ËÅ∑Ê•≠‰∏ÄË¶ß</h2>
                            <button onClick={onClose} className="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-white font-bold">Èñâ„Åò„Çã</button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2 overflow-y-auto flex-grow">
                            {Object.values(ROLES).map((role, idx) => (
                                <div key={idx} className="bg-slate-700 p-3 rounded flex gap-3 border border-slate-600 items-start">
                                    <div className="w-20 h-20 flex-none bg-slate-800 rounded overflow-hidden border border-slate-500">
                                        <img src={role.img} alt={role.name} className="w-full h-full object-cover pixel-art" onError={(e) => e.target.style.display = 'none'} />
                                    </div>
                                    <div className="flex-grow">
                                        <div className="flex justify-between font-bold text-white border-b border-slate-500 pb-1 mb-1">
                                            <span className="text-lg">{role.name}</span>
                                            <span className="text-sm text-blue-300 self-end">ÂãáËÄÖÈô£Âñ∂</span>
                                        </div>
                                        <div className="grid grid-cols-3 text-center text-base mb-1">
                                            <div><span className="text-xs text-slate-400 block">HP</span>Lv√ó{role.hp}</div>
                                            <div><span className="text-xs text-slate-400 block">ATK</span>Lv√ó{role.atk}</div>
                                            <div><span className="text-xs text-slate-400 block">DEF</span>Lv√ó{role.def}</div>
                                        </div>
                                        <div className="text-sm text-slate-300 mb-2">{role.desc}</div>
                                        <div className="grid grid-cols-1 gap-1">
                                            <div className="bg-slate-800 p-2 rounded text-xs">
                                                <span className="text-yellow-400 font-bold block">Âõ∫Êúâ: {role.uniqueSkill.name}</span>
                                                <span className="block whitespace-pre-wrap break-words">{formatSkillDesc(role.uniqueSkill.desc)}</span>
                                            </div>
                                            <div className="bg-slate-800 p-2 rounded text-xs">
                                                <span className="text-red-400 font-bold block">ÂøÖÊÆ∫: {role.ultimateSkill.name}</span>
                                                <span className="block whitespace-pre-wrap break-words">{formatSkillDesc(role.ultimateSkill.desc)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const Popup = ({ title, message, type = 'info', onClose }) => (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                <div className={`bg-slate-800 border-2 rounded-xl p-6 max-w-md w-full text-center shadow-2xl modal-anim ${
                    type === 'danger' ? 'border-red-500' : type === 'success' ? 'border-green-500' : 'border-blue-500'
                }`}>
                    <h2 className={`text-2xl font-bold mb-4 ${
                        type === 'danger' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-300'
                    }`}>{title}</h2>
                    <p className="text-lg mb-6 whitespace-pre-wrap leading-relaxed">{message}</p>
                    <button onClick={onClose} className="bg-slate-600 hover:bg-slate-500 text-white px-8 py-3 rounded font-bold text-lg">
                        Á¢∫Ë™ç
                    </button>
                </div>
            </div>
        );

        const ChoicePopup = ({ title, message, choices, onClose }) => (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 border-2 border-yellow-500 rounded-xl p-6 max-w-md w-full text-center shadow-2xl modal-anim">
                    <h2 className="text-2xl font-bold mb-4 text-yellow-400">{title}</h2>
                    <p className="text-lg mb-6 whitespace-pre-wrap text-slate-200">{formatSkillDesc(message)}</p>
                    <div className="flex flex-col gap-3">
                        {choices.map((choice, idx) => (
                            <button 
                                key={idx} 
                                onClick={() => onClose(choice.value)}
                                className={`py-3 rounded-xl font-bold text-lg shadow-lg ${choice.className || 'bg-slate-600 text-white'}`}
                            >
                                {choice.label}
                            </button>
                        ))}
                        <button onClick={() => onClose(null)} className="mt-2 text-slate-400 hover:text-white underline text-lg">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </div>
            </div>
        );

        const HandoverScreen = ({ nextPlayerName, message = "ÁîªÈù¢„ÇíÊ∏°„Åó„Å¶„Åè„Å†„Åï„ÅÑ", onOpen }) => (
            <div className="fixed inset-0 bg-slate-950 flex flex-col items-center justify-center z-40 text-center p-8">
                <div className="text-6xl mb-8 animate-bounce">üõë</div>
                <h2 className="text-4xl font-bold text-yellow-500 mb-6">{message}</h2>
                <p className="text-2xl text-slate-300 mb-10">Ê¨°„ÅØ <span className="font-bold text-white text-3xl">{nextPlayerName}</span> „Åï„Çì„ÅÆÁï™„Åß„Åô</p>
                <button onClick={onOpen} className="bg-blue-600 hover:bg-blue-500 text-white px-16 py-6 rounded-full text-2xl font-bold shadow-lg border-2 border-blue-400">
                    Êú¨‰∫∫„ÅåÁ¢∫Ë™ç„Åó„Åü„ÇâÊäº„Åô
                </button>
            </div>
        );

        const HPBar = ({ current, max, label = "HP", color = "green" }) => {
            const percentage = Math.max(0, Math.min(100, (current / max) * 100));
            const barColor = color === "red" ? "from-red-700 to-red-500" : "from-green-600 to-green-400";
            return (
                <div className="w-full">
                    {label && <div className="text-[10px] text-slate-400 mb-0.5">{label}</div>}
                    <div className="w-full bg-slate-900/50 rounded-full h-2 md:h-3 overflow-hidden border border-slate-600 relative">
                        <div 
                            className={`h-full bg-gradient-to-r ${barColor} transition-all duration-500 ease-out`}
                            style={{ width: `${percentage}%` }}
                        ></div>
                    </div>
                </div>
            );
        };

        const GameStatusHUD = ({ bossHP, bossMaxHP, players, turnOrder, turn, maxTurn, phase, activePlayerName, bossTurnCount, onOpenRoleList, onBackToTitle }) => {
            const orderedPlayers = turnOrder.length > 0 ? turnOrder.map(id => players.find(p => p.id === id)).filter(Boolean) : players;

            return (
                <div className="fixed top-0 left-0 w-full bg-slate-900/95 border-b border-slate-700 z-30 shadow-lg backdrop-blur-sm transition-all pb-1">
                    <div className="max-w-7xl mx-auto px-2 pt-1">
                        <div className="flex justify-between items-center mb-1 gap-2 h-8">
                            <div className="flex items-center gap-2 flex-grow max-w-md">
                                <span className="text-red-500 font-black text-xs whitespace-nowrap">È≠îÁéã</span>
                                <div className="flex-grow h-3 bg-slate-800 rounded-full overflow-hidden border border-slate-600 relative">
                                    <div 
                                        className="h-full bg-gradient-to-r from-red-700 to-red-500 transition-all duration-500 ease-out" 
                                        style={{ width: `${bossMaxHP > 0 ? Math.max(0, Math.min(100, (bossHP / bossMaxHP) * 100)) : 0}%` }}
                                    ></div>
                                    <div className="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white drop-shadow leading-none">
                                        {bossHP}/{bossMaxHP}
                                    </div>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-1 text-[10px] text-slate-300">
                                <span className="bg-slate-800 px-1.5 py-0.5 rounded border border-slate-600">
                                    T {turn}/{maxTurn}
                                </span>
                                <span className="bg-slate-800 px-1.5 py-0.5 rounded border border-slate-600 font-bold text-blue-300">
                                    {phase.includes('BOSS') ? `È≠îÁéãÊà¶ R${bossTurnCount}` : phase === 'ACTION_SELECT' ? 'Ë°åÂãïÈÅ∏Êäû' : phase.replace('_', ' ')}
                                </span>
                                <span className="font-bold text-white bg-blue-900/80 px-2 py-0.5 rounded border border-blue-500 truncate max-w-[80px] text-center">
                                    {activePlayerName}
                                </span>
                            </div>
                        </div>
                        
                        <div className="flex items-stretch gap-1 overflow-x-auto pb-1 scrollbar-hide h-12">
                            {orderedPlayers.map((p) => (
                                <div key={p.id} className={`flex-none w-20 bg-slate-800 rounded border ${p.isDead ? 'border-red-900 opacity-60' : 'border-slate-600'} p-1 flex flex-col justify-center gap-0.5 relative`}>
                                    <div className="flex justify-between items-center leading-none px-0.5 relative z-10">
                                        {/* ÁîªÂÉè„ÇíÂâäÈô§ */}
                                        <span className={`font-bold text-xs truncate flex-grow ${p.isDead ? 'text-red-500' : 'text-white'}`}>{p.name}</span>
                                        {p.isDead && <span className="text-[9px] text-red-500 font-black ml-0.5">‚Ä†</span>}
                                    </div>
                                    <div className="relative z-10">
                                        <HPBar current={p.currentHp} max={p.maxHp} showText={false} label={null} />
                                    </div>
                                </div>
                            ))}
                            
                            <div className="ml-auto flex gap-1">
                                <button onClick={onOpenRoleList} className="bg-slate-700 hover:bg-slate-600 text-yellow-400 px-2 py-1 rounded text-[10px] font-bold border border-yellow-600 shadow-md h-full flex flex-col items-center justify-center w-10 leading-tight">
                                    <span className="text-sm">üìñ</span>
                                    <span>ËÅ∑</span>
                                </button>
                                <button onClick={onBackToTitle} className="bg-slate-800 hover:bg-red-900 text-slate-400 hover:text-white px-2 py-1 rounded text-[10px] font-bold border border-slate-600 shadow-md h-full flex flex-col items-center justify-center w-10 transition leading-tight">
                                    <span className="text-sm">üè†</span>
                                    <span>TOP</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- „É°„Ç§„É≥„Ç¢„Éó„É™ ---
        const App = () => {
            const [phase, setPhase] = useState('INTRO'); 
            const [turn, setTurn] = useState(1);
            const [maxTurn, setMaxTurn] = useState(8);
            const [playerCount, setPlayerCount] = useState(4);
            const [playerNames, setPlayerNames] = useState([]);
            const [players, setPlayers] = useState([]);
            const [turnOrder, setTurnOrder] = useState([]); 
            
            const [quests, setQuests] = useState([]);
            const [questResults, setQuestResults] = useState([]); 
            const [actionQueue, setActionQueue] = useState([]); 
            const [activePlayerId, setActivePlayerId] = useState(0);
            const [isHandover, setIsHandover] = useState(false);
            
            const [playerActions, setPlayerActions] = useState({});
            const [votes, setVotes] = useState({});
            const [exileResult, setExileResult] = useState(null);
            
            const [bossBattleActions, setBossBattleActions] = useState({});
            const [bossBattleLog, setBossBattleLog] = useState([]);
            const [bossInitialPlayerCount, setBossInitialPlayerCount] = useState(0); // „Åì„ÇåÂ§âÊï∞„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑ„Åå‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„Åô
            const [bossHP, setBossHP] = useState(0);
            const [bossMaxHP, setBossMaxHP] = useState(0);
            const [winner, setWinner] = useState(null);
            const [bossTurnCount, setBossTurnCount] = useState(1);
            const [bossNextAction, setBossNextAction] = useState(null); 
            const [roundDamageReport, setRoundDamageReport] = useState({});
            
            const [battleState, setBattleState] = useState({}); 

            const [popup, setPopup] = useState(null);
            const [choicePopup, setChoicePopup] = useState(null);
            const [timeLeft, setTimeLeft] = useState(180); 
            const [showRoleList, setShowRoleList] = useState(false);
            
            useEffect(() => {
                let timer;
                if ((phase === 'STRATEGY' || phase === 'VOTE_DISCUSS') && timeLeft > 0) {
                    timer = setInterval(() => setTimeLeft(t => t - 1), 1000);
                }
                return () => clearInterval(timer);
            }, [phase, timeLeft]);

            const selectPlayerCount = (count) => {
                setPlayerCount(count);
                setPlayerNames(prev => {
                    const newNames = Array(count).fill('');
                    for (let i = 0; i < count; i++) {
                        newNames[i] = prev[i] || `Player ${i + 1}`;
                    }
                    return newNames;
                });
                setPhase('NAME_ENTRY');
            };

            const handleBackToTitle = () => {
                setChoicePopup({
                    title: 'Á¢∫Ë™ç',
                    message: '„Çø„Ç§„Éà„É´„Å´Êàª„Çä„Åæ„Åô„ÅãÔºü\nÁèæÂú®„ÅÆ„Ç≤„Éº„É†„Éá„Éº„Çø„ÅØÂ§±„Çè„Çå„Åæ„Åô„ÄÇ',
                    choices: [
                        { label: 'Êàª„Çã', value: 'yes', className: 'bg-red-600 text-white' }
                    ],
                    onClose: (val) => {
                        setChoicePopup(null);
                        if(val === 'yes') {
                            setPhase('SETUP');
                            setTurn(1);
                            setBossHP(0);
                            setBossMaxHP(0);
                            setWinner(null);
                            setBossBattleLog([]);
                            setTurnOrder([]);
                            setPlayers([]);
                        }
                    }
                });
            };
            
            const handleBackToTitleForce = () => {
                setPhase('SETUP');
                setTurn(1);
                setBossHP(0);
                setBossMaxHP(0);
                setWinner(null);
                setBossBattleLog([]);
                setTurnOrder([]);
                setPlayers([]);
            };

            const startGame = () => {
                const availableRoles = Object.keys(ROLES).filter(key => key !== 'SAGE');
                let roleKeys = [...availableRoles];
                while(roleKeys.length < playerCount) roleKeys = roleKeys.concat(availableRoles);
                roleKeys = roleKeys.sort(() => Math.random() - 0.5).slice(0, playerCount);

                let demonCount = 0;
                if (playerCount === 3) demonCount = Math.random() < 0.5 ? 0 : 1;
                else if (playerCount === 4) demonCount = Math.random() < 0.2 ? 0 : 1;
                else if (playerCount === 5) demonCount = Math.random() < 0.7 ? 1 : 2;
                else if (playerCount === 6) demonCount = 2;

                let teamAssignment = Array(playerCount).fill('HERO');
                for(let i=0; i<demonCount; i++) teamAssignment[i] = 'DEMON';
                teamAssignment.sort(() => Math.random() - 0.5);

                const newPlayers = roleKeys.map((roleKey, index) => ({
                    id: index,
                    name: playerNames[index] || `Player ${index + 1}`,
                    roleKey: roleKey,
                    roleName: ROLES[roleKey].name,
                    realTeam: teamAssignment[index],
                    level: 1,
                    maxHp: ROLES[roleKey].hp, 
                    currentHp: ROLES[roleKey].hp, 
                    isDead: false,
                    uniqueSkillUsed: false,
                    ultimateSkillUsed: false,
                    trainingBonus: false,
                    totalDamageDealt: 0,
                    atkBonus: 0,
                    defBonus: 0,
                    charge: false,
                    counterStance: false,
                    shield: false,
                    hpBonus: 0
                }));

                const order = newPlayers.map(p => p.id).sort(() => Math.random() - 0.5);
                setTurnOrder(order);
                setPlayers(newPlayers);
                setMaxTurn(playerCount); 
                
                // È≠îÁéãHP‰øÆÊ≠£
                let hp = 350;
                if (playerCount === 3) hp = 200;
                else if (playerCount === 4) hp = 300;
                else if (playerCount === 5) hp = 450;
                else if (playerCount === 6) hp = 600;

                setBossMaxHP(hp); 
                setBossHP(hp);
                
                setTurn(1);
                generateQuests([], 4, newPlayers); 
                
                setPhase('ORDER_ANNOUNCE');
            };

            const startRoleConfirm = () => {
                const queue = [...turnOrder]; 
                setActionQueue(queue.slice(1));
                setActivePlayerId(queue[0]);
                setPhase('ROLE_CONFIRM');
                setIsHandover(true);
            };

            const generateQuests = (existingQuests = [], targetCount = 4, currentPlayers = players) => {
                const currentCount = existingQuests.length;
                const needed = targetCount - currentCount;
                if (needed <= 0) { setQuests(existingQuests); return; }

                const ranks = [
                    { id: 'S', label: 'S: Â•≥Áéã„ÅÆ‰æùÈ†º', reqDiff: 0, rewardVal: 4, damageVal: 6, color: 'text-red-600', borderColor: 'border-red-600' },
                    { id: 'A', label: 'A: ÁéãÂõΩÈò≤Ë°õ', reqDiff: -1, rewardVal: 3, damageVal: 4, color: 'text-red-400', borderColor: 'border-red-400' },
                    { id: 'B', label: 'B: Á†¶Â•™ÈÇÑ', reqDiff: -2, rewardVal: 2, damageVal: 2, color: 'text-orange-400', borderColor: 'border-orange-400' },
                    { id: 'C', label: 'C: „É¢„É≥„Çπ„Çø„ÉºË®é‰ºê', reqDiff: -3, rewardVal: 1, damageVal: 1, color: 'text-yellow-300', borderColor: 'border-yellow-300' }
                ];

                const newQuests = [...existingQuests];
                const usedMonsters = new Set(existingQuests.map(q => q.monsterName));

                const aliveCount = currentPlayers.length > 0 ? currentPlayers.filter(p => !p.isDead).length : 4;

                for (let i = 0; i < needed; i++) {
                    const r = Math.random();
                    let rank = r > 0.9 ? ranks[0] : r > 0.7 ? ranks[1] : r > 0.4 ? ranks[2] : ranks[3];
                    
                    const monsterList = MONSTERS[rank.id];
                    let monsterName = "";
                    let attempts = 0;
                    do {
                        monsterName = monsterList[Math.floor(Math.random() * monsterList.length)];
                        attempts++;
                    } while (usedMonsters.has(monsterName) && attempts < 20);
                    usedMonsters.add(monsterName);
                    
                    let req = Math.max(1, aliveCount + rank.reqDiff); 
                    
                    // S„É©„É≥„ÇØ‰ª•‰∏ä„Å™„ÇâÁîªÂÉè„ÇíË®≠ÂÆö
                    let img = null;
                    if (rank.id === 'S') {
                             img = MONSTER_IMAGES[monsterName];
                    }

                    newQuests.push({
                        id: Date.now() + i + Math.random(), 
                        title: rank.label,
                        req: req,
                        rewardVal: rank.rewardVal,
                        damageVal: rank.damageVal,
                        color: rank.color,
                        borderColor: rank.borderColor,
                        rank: rank.id,
                        monsterName: monsterName,
                        img: img
                    });
                }
                
                // ÊúÄÁµÇ„Çø„Éº„É≥Áî®„Å´SS„É©„É≥„ÇØ„ÇíÂº∑Âà∂‰∏äÊõ∏„Åç„Åô„Çã„É≠„Ç∏„ÉÉ„ÇØ
                const isFinalTurnNext = (turn === maxTurn - 1);
                if (isFinalTurnNext) {
                     // SS„É©„É≥„ÇØ„Åå„Å™„Åë„Çå„Å∞1„Å§ÁΩÆ„ÅçÊèõ„Åà„ÇãÔºà„ÅÇ„Çã„ÅÑ„ÅØËøΩÂä†„Åô„ÇãÔºâ
                     const hasSS = newQuests.some(q => q.rank === 'SS');
                     if (!hasSS && newQuests.length > 0) {
                         // „É©„É≥„ÉÄ„É†„Å™‰ΩçÁΩÆ„ÅÆ„ÇØ„Ç®„Çπ„Éà„ÇíSS„Å´ÁΩÆ„ÅçÊèõ„Åà„Çã
                         const replaceIdx = Math.floor(Math.random() * newQuests.length);
                         newQuests[replaceIdx] = {
                            id: Date.now() + 999, 
                            title: 'SS: „É¨„Ç¢„É¢„É≥„Çπ„Çø„ÉºË•≤Êù•',
                            req: 1, // ‰øÆÊ≠£: ÊúÄ‰ΩéÂøÖË¶Å‰∫∫Êï∞„ÅØ1
                            rewardVal: 5,
                            damageVal: 0,
                            color: 'text-yellow-500',
                            borderColor: 'border-yellow-500',
                            rank: 'SS',
                            monsterName: '„É¨„Ç¢„Çπ„É©„Ç§„É†',
                            img: MONSTER_IMAGES['„É¨„Ç¢„Çπ„É©„Ç§„É†'],
                            bgColor: 'bg-yellow-900/40' // ËÉåÊôØËâ≤ËøΩÂä†
                        };
                     }
                }

                setQuests(newQuests);
            };

            const startNewTurn = (clearedQuestIds = []) => {
                if (turn >= maxTurn) {
                    startBossPhase();
                    return;
                }
                
                // „ÇØ„Ç®„Çπ„Éà„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
                // ÊúÄÁµÇ„Çø„Éº„É≥Áõ¥Ââç„Å™„ÇâÂÖ®„Å¶‰Ωú„ÇäÁõ¥„Åó„Å¶SS„ÇíÂÖ•„Çå„Çã
                let nextTurnQuests = [];
                if (turn === maxTurn - 1) {
                     nextTurnQuests = []; // generateQuests„Åß4„Å§ÁîüÊàê„Åï„Çå„ÄÅ„Åù„ÅÆ„ÅÜ„Å°1„Å§„ÅåSS„Å´„Å™„Çã
                } else {
                    // ÈÄöÂ∏∏„Çø„Éº„É≥„ÅØ„ÇØ„É™„Ç¢„Åï„Çå„Åü„ÇÇ„ÅÆ„ÇíÈô§Â§ñ„Åó„Å¶Ë£úÂÖÖ
                    nextTurnQuests = quests.filter(q => !clearedQuestIds.includes(q.id));
                }
                
                generateQuests(nextTurnQuests, 4, players);
                setTurn(t => t + 1);
                setTimeLeft(180);
                setPhase('STRATEGY');
                setPlayerActions({});
                setVotes({});
            };

            const nextPlayer = (nextPhaseIfDone) => {
                if (actionQueue.length === 0) {
                    setPhase(nextPhaseIfDone);
                    return;
                }
                const nextId = actionQueue[0];
                setActionQueue(prev => prev.slice(1));
                setActivePlayerId(nextId);
                setIsHandover(true);
            };

            const finishRoleConfirm = () => nextPlayer('STRATEGY');
            
            const startActionPhase = () => {
                const living = turnOrder.filter(id => {
                    const p = players.find(pl => pl.id === id);
                    return !p.isDead;
                });
                setActionQueue(living.slice(1));
                setActivePlayerId(living[0]);
                setPlayerActions({});
                setPhase('ACTION_SELECT');
                setIsHandover(true);
            };

            // --- Âõ∫Êúâ„Çπ„Ç≠„É´Áô∫Âãï„É≠„Ç∏„ÉÉ„ÇØ ---
            const handleUniqueSkill = () => {
                const activePlayer = players.find(p => p.id === activePlayerId);
                const role = ROLES[activePlayer.roleKey];

                if (role.uniqueSkill.type === 'QUEST_ACTIVE') {
                    if (activePlayer.roleKey === 'MAGE') handleMageSkill();
                    else if (activePlayer.roleKey === 'THIEF') handleThiefSkill();
                    else if (activePlayer.roleKey === 'SPIRIT') handleSpiritSkill();
                    else if (activePlayer.roleKey === 'CLERIC') handleClericUniqueSkill();
                    else if (activePlayer.roleKey === 'SAGE') handleSageUniqueSkill();
                    else if (activePlayer.roleKey === 'BARRIER_MASTER') handleBarrierMasterUniqueSkill();
                }
            };

            const handleMageSkill = () => {
                const targets = players.filter(p => p.id !== activePlayerId);
                setChoicePopup({
                    title: 'È≠îÊ≥ïÊÑüÁü•',
                    message: 'Ë™∞„ÅÆÊ≠£‰Ωì„ÇíÂç†„ÅÑ„Åæ„Åô„ÅãÔºü',
                    choices: targets.map(p => ({ label: p.name, value: p.id, className: 'bg-purple-600 text-white' })),
                    onClose: (targetId) => {
                        setChoicePopup(null);
                        if (targetId !== null) {
                            const target = players.find(p => p.id === targetId);
                            setPlayers(prev => prev.map(p => p.id === activePlayerId ? {...p, uniqueSkillUsed: true} : p));
                            setPopup({
                                title: 'Âç†„ÅÑ„ÅÆÁµêÊûú',
                                message: `${target.name} „ÅØ... \n\n„Äê${target.roleName}„Äë\nÈô£Âñ∂Ôºö${target.realTeam === 'HERO' ? 'ÂãáËÄÖÈô£Âñ∂' : 'È≠îÁéãÈô£Âñ∂'}`,
                                type: 'success',
                                onClose: () => setPopup(null)
                            });
                        }
                    }
                });
            };

            const handleThiefSkill = () => {
                const targets = players.filter(p => p.id !== activePlayerId);
                setChoicePopup({
                    title: 'ÁõóË≥ä„ÅÆÊ•µÊÑè',
                    message: 'Ë™∞„Å®Èô£Âñ∂„ÇíÂÖ•„ÇåÊõø„Åà„Åæ„Åô„ÅãÔºü\n(Ëá™ÂàÜ„Å®ÂØæË±°„ÅÆÈô£Âñ∂„Åå‰∫§Êèõ„Åï„Çå„Åæ„Åô)',
                    choices: targets.map(p => ({ label: p.name, value: p.id, className: 'bg-slate-600 text-white' })),
                    onClose: (targetId) => {
                        setChoicePopup(null);
                        if (targetId !== null) {
                            const target = players.find(p => p.id === targetId);
                            const me = players.find(p => p.id === activePlayerId);
                            const myTeam = me.realTeam;
                            const targetTeam = target.realTeam;
                            setPlayers(prev => prev.map(p => {
                                if (p.id === activePlayerId) return { ...p, realTeam: targetTeam, uniqueSkillUsed: true };
                                if (p.id === targetId) return { ...p, realTeam: myTeam };
                                return p;
                            }));
                            setPopup({
                                title: 'ÂÖ•ÊõøÂÆå‰∫Ü',
                                message: `${target.name} „Å®Èô£Âñ∂„ÇíÂÖ•„ÇåÊõø„Åà„Åæ„Åó„Åü„ÄÇ\n\n„ÅÇ„Å™„Åü„ÅØ‰ªä„Äê${targetTeam === 'HERO' ? 'ÂãáËÄÖÈô£Âñ∂' : 'È≠îÁéãÈô£Âñ∂'}„Äë„Åß„Åô„ÄÇ\n(‚ÄªÁõ∏Êâã„Å´„ÅØÈÄöÁü•„Åï„Çå„Åæ„Åõ„Çì)`,
                                type: 'success',
                                onClose: () => setPopup(null)
                            });
                        }
                    }
                });
            };

            const handleSpiritSkill = () => {
                const roleNames = players.map(p => p.roleName).sort(() => Math.random() - 0.5);
                const roleCounts = {};
                roleNames.forEach(name => roleCounts[name] = (roleCounts[name] || 0) + 1);
                const displayList = Object.entries(roleCounts).map(([name, count]) => `${name}${count > 1 ? ' x'+count : ''}`).join('\n');
                setPlayers(prev => prev.map(p => p.id === activePlayerId ? {...p, uniqueSkillUsed: true} : p));
                setPopup({
                    title: 'Á≤æÈúä„ÅÆË™ì„ÅÑ',
                    message: `‰ªäÂõû„ÅÆ„Ç≤„Éº„É†„Å´ÂèÇÂä†„Åó„Å¶„ÅÑ„ÇãËÅ∑Ê•≠:\n\n${displayList}\n\n(‚ÄªË™∞„Åå„Å©„ÅÆËÅ∑Ê•≠„Åã„ÅØ‰∏çÊòé)`,
                    type: 'info',
                    onClose: () => setPopup(null)
                });
            };

            const handleClericUniqueSkill = () => {
                 const targets = players.filter(p => p.id !== activePlayerId);
                 setChoicePopup({
                    title: 'ÊÖàÊÑõ„ÅÆÊÇü„Çä',
                    message: 'Ë™∞„ÇíÂº∑Âà∂ÁöÑ„Å´ÂãáËÄÖÈô£Âñ∂„Å´„Åó„Åæ„Åô„ÅãÔºü',
                    choices: targets.map(p => ({ label: p.name, value: p.id, className: 'bg-green-600 text-white' })),
                    onClose: (targetId) => {
                        setChoicePopup(null);
                        if (targetId !== null) {
                            setPlayers(prev => prev.map(p => {
                                if (p.id === activePlayerId) return { ...p, uniqueSkillUsed: true };
                                if (p.id === targetId) return { ...p, realTeam: 'HERO' }; // Âº∑Âà∂Â§âÊõ¥
                                return p;
                            }));
                            setPopup({
                                title: 'ÊµÑÂåñÂÆå‰∫Ü',
                                message: `ÂØæË±°„ÇíÂãáËÄÖÈô£Âñ∂„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü„ÄÇ(ÂØæË±°„Å´„ÅØÈÄöÁü•„Åï„Çå„Åæ„Åõ„Çì)`,
                                type: 'success',
                                onClose: () => setPopup(null)
                            });
                        }
                    }
                });
            };

            const handleSageUniqueSkill = () => {
                const targets = players.filter(p => p.id !== activePlayerId);
                setChoicePopup({
                    title: 'Âè°Êô∫„ÅÆÂÖâ',
                    message: 'Ë™∞„ÅÆÊ≠£‰Ωì„ÇíÁúãÁ†¥„Åó„ÄÅÂõûÂæ©„Åï„Åõ„Åæ„Åô„ÅãÔºü',
                    choices: targets.map(p => ({ label: p.name, value: p.id, className: 'bg-purple-600 text-white' })),
                    onClose: (targetId) => {
                        setChoicePopup(null);
                        if (targetId !== null) {
                            const target = players.find(p => p.id === targetId);
                            setPlayers(prev => prev.map(p => {
                                if (p.id === activePlayerId) return { ...p, uniqueSkillUsed: true };
                                if (p.id === targetId) return { ...p, currentHp: p.maxHp }; // ÂÖ®ÂõûÂæ©
                                return p;
                            }));
                            setPopup({
                                title: 'ÁúãÁ†¥ÁµêÊûú',
                                message: `${target.name} „ÅØ... \n„Äê${target.roleName}„Äë\nÈô£Âñ∂Ôºö${target.realTeam === 'HERO' ? 'ÂãáËÄÖÈô£Âñ∂' : 'È≠îÁéãÈô£Âñ∂'}\n\nÂØæË±°„ÅÆHP„ÇíÂÖ®ÂõûÂæ©„Åó„Åæ„Åó„Åü„ÄÇ`,
                                type: 'success',
                                onClose: () => setPopup(null)
                            });
                        }
                    }
                });
            };

            const handleBarrierMasterUniqueSkill = () => {
                const demonCount = players.filter(p => p.realTeam === 'DEMON').length;
                setPlayers(prev => prev.map(p => p.id === activePlayerId ? { ...p, uniqueSkillUsed: true } : p));
                setPopup({
                    title: 'ÁµêÁïåÂ±ïÈñã',
                    message: `„Åì„ÅÆ„Ç≤„Éº„É†„Å´ÂèÇÂä†„Åó„Å¶„ÅÑ„ÇãÈ≠îÁéãÈô£Âñ∂„ÅÆ„Éó„É¨„Ç§„É§„ÉºÊï∞„ÅØ... \n\n„Äê ${demonCount} ‰∫∫ „Äë\n\n„Åß„Åô„ÄÇ`,
                    type: 'info',
                    onClose: () => setPopup(null)
                });
            };

            // --- „ÇØ„Ç®„Çπ„ÉàÂá¶ÁêÜ„É≠„Ç∏„ÉÉ„ÇØ ---

            const handleQuestClick = (quest) => {
                const activePlayer = players.find(p => p.id === activePlayerId);
                // ÂãáËÄÖ„ÅÆË©¶Á∑¥ (Âõ∫Êúâ„Çπ„Ç≠„É´) - SS„É©„É≥„ÇØ„ÅØÂØæË±°Â§ñ
                if (activePlayer.roleKey === 'HERO' && !activePlayer.uniqueSkillUsed && quest.rank !== 'SS') {
                    setChoicePopup({
                        title: 'Ë°åÂãïÈÅ∏Êäû',
                        message: `„Äå${quest.title}„Äç„Å´ÂØæ„Åó„Å¶„Å©„ÅÜË°åÂãï„Åó„Åæ„Åô„ÅãÔºü`,
                        choices: [
                            { label: 'ÊôÆÈÄö„Å´ÂèÇÂä†„Åô„Çã', value: 'join', className: 'bg-blue-600 text-white' },
                            { label: 'Âõ∫Êúâ„Çπ„Ç≠„É´: ÂãáËÄÖ„ÅÆË©¶Á∑¥ (ÂøÖÂãù)', value: 'skill', className: 'bg-yellow-600 text-white font-bold' }
                        ],
                        onClose: (val) => {
                            setChoicePopup(null);
                            if (val === 'join') handleActionSelect({ type: 'QUEST', targetId: quest.id, sabotage: false });
                            else if (val === 'skill') {
                                setPlayers(prev => prev.map(p => p.id === activePlayerId ? {...p, uniqueSkillUsed: true} : p));
                                handleActionSelect({ type: 'QUEST', targetId: quest.id, sabotage: false, useSkill: true });
                            }
                        }
                    });
                    return;
                }
                setChoicePopup({
                    title: '„ÇØ„Ç®„Çπ„ÉàÂèÇÂä†Á¢∫Ë™ç',
                    message: `„Äå${quest.title}„Äç„Å´ÂèÇÂä†„Åó„Åæ„Åô„ÅãÔºü\n(ÂøÖË¶Å‰∫∫Êï∞: ${quest.req === 0 ? 'Âà∂Èôê„Å™„Åó' : quest.req + '‰∫∫'})\n\n‚ÄªÂèÇÂä†„Åô„Çã„Å® ${quest.damageVal} „ÉÄ„É°„Éº„Ç∏Âèó„Åë„Åæ„Åô`,
                    choices: [{ label: 'ÂèÇÂä†„Åô„Çã', value: 'join', className: 'bg-blue-600 text-white' }],
                    onClose: (value) => {
                        setChoicePopup(null);
                        if (value === 'join') handleActionSelect({ type: 'QUEST', targetId: quest.id, sabotage: false });
                    }
                });
            };

            const handleTrainingClick = () => {
                setChoicePopup({
                    title: 'ÂÄã‰∫∫‰øÆË°å„ÅÆÁ¢∫Ë™ç',
                    message: `„ÇØ„Ç®„Çπ„Éà„Å´„ÅØÂèÇÂä†„Åõ„Åö„ÄÅ‰øÆË°å„Çí„Åó„Å¶\nËá™ÂàÜ„Å†„Åë„É¨„Éô„É´„Ç¢„ÉÉ„Éó„Åó„Åæ„Åô„ÅãÔºü`,
                    choices: [{ label: '‰øÆË°å„Åô„Çã (‰∏çÂèÇÂä†)', value: 'train', className: 'bg-yellow-600 text-white' }],
                    onClose: (value) => {
                        setChoicePopup(null);
                        if (value === 'train') handleActionSelect({ type: 'TRAIN' });
                    }
                });
            };

            const handleRestClick = () => {
                setChoicePopup({
                    title: '‰ºëÊÅØ„ÅÆÁ¢∫Ë™ç',
                    message: `„ÇØ„Ç®„Çπ„Éà„Å´„ÅØÂèÇÂä†„Åõ„Åö„ÄÅ‰ºëÊÅØ„ÇíÂèñ„Çä„Åæ„Åô„ÅãÔºü\nHP„ÅåÂÖ®ÂõûÂæ©„Åó„Åæ„Åô„ÄÇ`,
                    choices: [{ label: '‰ºëÊÅØ„Åô„Çã (‰∏çÂèÇÂä†)', value: 'rest', className: 'bg-green-600 text-white' }],
                    onClose: (value) => {
                        setChoicePopup(null);
                        if (value === 'rest') handleActionSelect({ type: 'REST' });
                    }
                });
            };

            const handleActionSelect = (action) => {
                setPlayerActions(prev => ({ ...prev, [activePlayerId]: action }));
                if (actionQueue.length === 0) calculateQuestResults({ ...playerActions, [activePlayerId]: action });
                else nextPlayer('QUEST_RESULT');
            };

            const calculateQuestResults = (actions) => {
                const clearedIds = [];
                let evolvedPlayers = [];

                const results = quests.map(q => {
                    const participantsActs = Object.entries(actions).filter(([pid, act]) => act.type === 'QUEST' && act.targetId === q.id);
                    const participantIds = participantsActs.map(([pid]) => parseInt(pid));
                    const heroSkillUsed = participantsActs.some(([pid, act]) => act.useSkill); // ÂãáËÄÖ„Çπ„Ç≠„É´
                    const effectivePower = participantIds.length; 
                    
                    let isSuccess = false;
                    if (heroSkillUsed) isSuccess = true;
                    else if (q.rank === 'SS') {
                        // SS„É©„É≥„ÇØÁâπÊÆäÂà§ÂÆö: 20%
                        isSuccess = Math.random() < 0.2;
                    } else {
                        // ÈÄöÂ∏∏Âà§ÂÆö
                        isSuccess = effectivePower >= q.req;
                    }
                    
                    setPlayers(prev => prev.map(p => {
                        // ÂãáËÄÖ„Çπ„Ç≠„É´„ÅÆ‰ΩøÁî®„Éï„É©„Ç∞„ÇíÁ¢∫ÂÆü„Å´Êõ¥Êñ∞ (ÊúÄÂæå„ÅÆ‰∫∫„ÅåÂãáËÄÖ„ÅÆÂ†¥Âêà„Å´‰∏äÊõ∏„Åç„Åï„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´)
                        if (p.roleKey === 'HERO' && heroSkillUsed && participantIds.includes(p.id)) {
                            const myAction = actions[p.id];
                            if(myAction && myAction.useSkill) return { ...p, uniqueSkillUsed: true };
                        }

                        if (participantIds.includes(p.id)) {
                            // „ÉÄ„É°„Éº„Ç∏Ë®àÁÆó
                            let dmg = q.damageVal;
                            // È®éÂ£´„Éë„ÉÉ„Ç∑„Éñ: Â±àÂº∑„Å™ËÇâ‰Ωì
                            if (p.roleKey === 'KNIGHT') dmg = Math.max(0, dmg - 1);
                            // ÁµêÁïåÂ∏´„ÅØ„Éë„ÉÉ„Ç∑„Éñ„Åß„ÅØ„Å™„ÅÑ„ÅÆ„ÅßÂâäÈô§ (ÊåáÁ§∫Êõ∏„Å´„Éë„ÉÉ„Ç∑„Éñ„ÅÆË®òËø∞„Å™„Åó)
                            
                            let newHp = p.currentHp - dmg;
                            let isDead = p.isDead;
                            if (newHp <= 0) { newHp = 0; isDead = true; }

                            if (isSuccess) {
                                let rise = q.rewardVal;
                                if (p.trainingBonus) rise += 3;

                                // ‰øÆÊ≠£ÔºöÈÅä„Å≥‰∫∫„ÅÆÁµåÈ®ìÂÄ§2ÂÄç„Éë„ÉÉ„Ç∑„Éñ„ÇíÂâäÈô§
                                // (‰ª•Ââç„ÅÆ„Ç≥„Éº„Éâ„Å´„ÅÇ„Å£„Åü„Äåif (p.roleKey === 'PLAYBOY' && Math.random() < 0.5) rise *= 2;„Äç„ÇíÂâäÈô§)

                                // Ê†ºÈóòÂÆ∂„Éë„ÉÉ„Ç∑„Éñ: Â≠§Áã¨„ÅÆ‰øÆË°å (1‰∫∫„Åß„ÇØ„É™„Ç¢ÊôÇLv+1)
                                if (p.roleKey === 'MONK' && participantIds.length === 1) {
                                    rise += 1;
                                }

                                const newLevel = p.level + rise;
                                const hpGrowth = ROLES[p.roleKey].hp * rise;

                                // Êà¶Â£´„Éë„ÉÉ„Ç∑„Éñ: Êà¶Â£´„ÅÆË®º
                                let addedAtk = 0;
                                if (p.roleKey === 'WARRIOR') addedAtk = 1;

                                // Ë≥¢ËÄÖ„Éë„ÉÉ„Ç∑„Éñ: Âè°Êô∫„ÅÆÂÆöÂºè (HP+1, ATK+1)
                                let addedHpBonus = 0;
                                if (p.roleKey === 'SAGE') {
                                    addedHpBonus = 1;
                                    addedAtk += 1;
                                }

                                let roleKey = p.roleKey;
                                let roleName = p.roleName;
                                let currentHp = newHp + hpGrowth + addedHpBonus;
                                let maxHp = p.maxHp + hpGrowth + addedHpBonus;

                                // ÈÅä„Å≥‰∫∫ÈÄ≤Âåñ„É≠„Ç∏„ÉÉ„ÇØ
                                if (p.roleKey === 'PLAYBOY' && newLevel >= (playerCount * 2 + 2)) {
                                    roleKey = 'SAGE';
                                    roleName = ROLES['SAGE'].name;
                                    evolvedPlayers.push(p.name);
                                }

                                return { ...p, roleKey, roleName, level: newLevel, maxHp: maxHp, currentHp: currentHp, atkBonus: (p.atkBonus||0) + addedAtk, hpBonus: (p.hpBonus||0) + addedHpBonus, trainingBonus: false, isDead };
                            } else {
                                return { ...p, currentHp: newHp, isDead };
                            }
                        }
                        return p;
                    }));

                    if (isSuccess) clearedIds.push(q.id);
                    return { quest: q, participantsCount: participantIds.length, isSuccess, heroSkill: heroSkillUsed };
                });

                Object.entries(actions).forEach(([pid, act]) => {
                    if (act.type === 'TRAIN') {
                        setPlayers(prev => prev.map(p => {
                            if (p.id === parseInt(pid)) {
                                return { ...p, level: p.level + 1, maxHp: p.maxHp + ROLES[p.roleKey].hp, currentHp: p.currentHp + ROLES[p.roleKey].hp };
                            }
                            return p;
                        }));
                    } else if (act.type === 'REST') {
                        setPlayers(prev => prev.map(p => {
                            if (p.id === parseInt(pid)) {
                                return { ...p, currentHp: p.maxHp };
                            }
                            return p;
                        }));
                    }
                });
                
                // ÂÖ®Âì°Ê≠ª‰∫°Âà§ÂÆö
                const survivors = players.filter(p => !p.isDead).length;
                if (survivors === 0) {
                    setWinner('DEMON');
                    setPhase('RESULT');
                    return;
                }
                
                if (evolvedPlayers.length > 0) {
                    setPopup({
                        title: 'ÈÄ≤ÂåñÁô∫ÁîüÔºÅ',
                        message: evolvedPlayers.map(name => `${name} „ÅØ„ÄåÈÅä„Å≥‰∫∫„Äç„Åã„Çâ„ÄåË≥¢ËÄÖ„Äç„Å´ÈÄ≤Âåñ„Åó„ÅüÔºÅ`).join('\n'),
                        type: 'success',
                        onClose: () => setPopup(null)
                    });
                }

                setQuestResults(results);
                setPhase('QUEST_RESULT');
                window.tempClearedIds = clearedIds; 
            };

            const startVoteDiscussion = () => {
                setTimeLeft(180);
                setPhase('VOTE_DISCUSS');
            };

            const startVoteSelect = () => {
                const living = turnOrder.filter(id => {
                    const p = players.find(pl => pl.id === id);
                    return !p.isDead;
                });
                setActionQueue(living.slice(1));
                setActivePlayerId(living[0]);
                setVotes({});
                setPhase('VOTE_SELECT');
                setIsHandover(true);
            };

            const handleVote = (targetId) => {
                setVotes(prev => ({ ...prev, [activePlayerId]: targetId }));
                if (actionQueue.length === 0) calculateExile({ ...votes, [activePlayerId]: targetId });
                else nextPlayer('EXILE_PRE_RESULT');
            };

            const calculateExile = (allVotes) => {
                const counts = {};
                let skipCount = 0;
                Object.values(allVotes).forEach(tid => {
                    if (tid === null) skipCount++;
                    else counts[tid] = (counts[tid] || 0) + 1;
                });
                let maxVotes = 0;
                let banishedId = -1;
                Object.entries(counts).forEach(([id, c]) => {
                    if (c > maxVotes) {
                        maxVotes = c;
                        banishedId = parseInt(id);
                    } else if (c === maxVotes) banishedId = -1;
                });
                if (skipCount >= maxVotes) banishedId = -1;
                
                let result = { banished: null, message: 'Á•®„ÅåÂâ≤„Çå„Åü„ÄÅ„Åæ„Åü„ÅØ„Çπ„Ç≠„ÉÉ„Éó„ÅåÂ§öÊï∞„Å†„Å£„Åü„Åü„ÇÅ„ÄÅË™∞„ÇÇËøΩÊîæ„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ' };

                if (banishedId !== -1) {
                    const banishedPlayer = players.find(p => p.id === banishedId);
                    setPlayers(prev => prev.map(p => p.id === banishedId ? { ...p, isDead: true } : p));
                    result = { banished: banishedPlayer, message: 'ÊäïÁ•®„ÅÆÁµêÊûú„ÄÅËøΩÊîæËÄÖ„ÅåÊ±∫ÂÆö„Åó„Åæ„Åó„Åü„ÄÇ' };
                }
                
                setExileResult(result);
                setPhase('EXILE_READY');
            };

            // --- È≠îÁéãÊà¶ ---
            
            const decideBossAction = () => {
                const r = Math.random() * 100;
                // Á¢∫ÁéáÂ§âÊõ¥: ÈÄöÂ∏∏50, È≠îÊ≥ï25, ÁçÑÁÇé20, ÂíÜÂìÆ5
                if (r < 5) return { type: 'ROAR', name: 'È≠îÁéã„ÅÆÂíÜÂìÆ', desc: 'ÁîüÂ≠òËÄÖ„ÅÆ‰∏≠„Åã„Çâ„É©„É≥„ÉÄ„É†„Åß1Âêç„ÇíÂç≥Ê≠ª„Åï„Åõ„Çã', imgKey: 'BOSS_ROAR' };
                if (r < 25) return { type: 'HELLFIRE', name: 'Èóá„ÅÆÁçÑÁÇé', desc: 'ÂÖ®Âì°„Å´ÁâπÂ§ß„ÉÄ„É°„Éº„Ç∏', imgKey: 'BOSS_HELLFIRE' };
                if (r < 50) return { type: 'MAGIC', name: 'È≠îÊ≥ïÊîªÊíÉ', desc: 'Èò≤Âæ°ÁÑ°Ë¶ñ„ÅÆÂÖ®‰ΩìÊîªÊíÉ', imgKey: 'BOSS_MAGIC' };
                return { type: 'NORMAL', name: 'ÈÄöÂ∏∏ÊîªÊíÉ', desc: '„É©„É≥„ÉÄ„É†„Å™ÂØæË±°„Å´Â§ß„ÉÄ„É°„Éº„Ç∏', imgKey: 'BOSS_NORMAL' };
            };
            
            // ‰øÆÊ≠£: ÂºïÊï∞„Çí bossInitialPlayerCount „Åã„Çâ playerCount „Å´Â§âÊõ¥
            const getBossActionDetail = (action, playerCount) => {
                if (!action) return "";
                const baseDmg = playerCount * 3; // ‰øÆÊ≠£: ÂàùÊúü‰∫∫Êï∞„Éô„Éº„Çπ
                if (action.type === 'ROAR') return `ÁîüÂ≠òËÄÖ„Åã„Çâ„É©„É≥„ÉÄ„É†1Âêç Âç≥Ê≠ª`;
                if (action.type === 'HELLFIRE') return `ÂÖ®Âì°„Å´ ${baseDmg * 1.5} Áâ©ÁêÜ„ÉÄ„É°„Éº„Ç∏`;
                if (action.type === 'MAGIC') return `ÂÖ®Âì°„Å´ ${baseDmg * 1} È≠îÊ≥ï„ÉÄ„É°„Éº„Ç∏ (Èò≤Âæ°ÁÑ°Ë¶ñ)`;
                const targetCount = Math.max(1, playerCount - 2); // ‰øÆÊ≠£: ÂàùÊúü‰∫∫Êï∞„Éô„Éº„Çπ
                return `„É©„É≥„ÉÄ„É†${targetCount}Âêç„Å´ ${baseDmg * 2} Áâ©ÁêÜ„ÉÄ„É°„Éº„Ç∏`;
            };

            const startBossPhase = () => {
                const aliveCount = players.filter(p => !p.isDead).length;
                // ‰øÆÊ≠£: uniqueSkillUsed„ÅÆ„É™„Çª„ÉÉ„Éà„ÇíÂâäÈô§
                setPlayers(prev => prev.map(p => ({ ...p, ultimateSkillUsed: false, charge: false, counterStance: false, shield: false, stunned: false })));

                setBossTurnCount(1);
                setBossBattleLog([]);
                setBattleState({}); 
                setPhase('BOSS_INTRO');
            };

            const startBossBattleRound = () => {
                setBossBattleActions({});
                setBattleState(prev => ({ ...prev, knightTarget: null, forceBossNormal: false, bossStunned: false, knightGuard: null })); // ‰øÆÊ≠£: knightGuardËøΩÂä†
                setRoundDamageReport({}); // „É©„Ç¶„É≥„Éâ„Åî„Å®„ÅÆ„ÉÄ„É°„Éº„Ç∏„É¨„Éù„Éº„Éà„É™„Çª„ÉÉ„Éà
                
                // „Çø„Éº„É≥ÈñãÂßãÊôÇ„Å´‰∏ÄÊôÇÁöÑ„Å™ÂäπÊûú„Çí„É™„Çª„ÉÉ„Éà
                setPlayers(prev => prev.map(p => ({ ...p, counterStance: false, shield: false, stunned: false })));

                const nextAction = decideBossAction();
                setBossNextAction(nextAction);

                setPhase('BOSS_ACTION_ANNOUNCE');
            };

            const proceedToBossPlayerSelect = () => {
                const living = turnOrder.filter(id => {
                    const p = players.find(pl => pl.id === id);
                    return !p.isDead;
                });
                if (living.length === 0) { setWinner('DEMON'); setPhase('RESULT'); return; }
                setActionQueue(living.slice(1));
                setActivePlayerId(living[0]);
                setPhase('BOSS_SELECT');
                setIsHandover(true);
            };

            const handleBossTurnStart = () => {
                const activePlayer = players.find(p => p.id === activePlayerId);
                const role = ROLES[activePlayer.roleKey];

                if (activePlayer.charge) {
                     setChoicePopup({
                        title: 'Ê≠£Êã≥Á™Å„Åç',
                        message: 'Âäõ„ÇíÊ∫ú„ÇÅ„Åü‰∏ÄÊíÉ„ÇíÊîæ„Å°„Åæ„ÅôÔºÅ',
                        choices: [{ label: 'ÊîªÊíÉÂØæË±°„ÇíÈÅ∏Êäû', value: 'attack', className: 'bg-red-600 text-white font-bold' }],
                        onClose: (val) => {
                            setChoicePopup(null);
                            if (val === 'attack') showAttackTargetSelect();
                        }
                    });
                    return;
                }

                if (!activePlayer.ultimateSkillUsed && role.ultimateSkill.type !== 'NONE') {
                    setChoicePopup({
                        title: 'Ë°åÂãïÈÅ∏Êäû',
                        message: `Ë°åÂãï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\nÂøÖÊÆ∫„Çπ„Ç≠„É´: ${role.ultimateSkill.name}\n(${role.ultimateSkill.desc})`,
                        choices: [
                            { label: 'ÈÄöÂ∏∏Ë°åÂãï (ÊîªÊíÉ)', value: 'attack', className: 'bg-red-600 text-white' },
                            { label: `ÂøÖÊÆ∫„Çπ„Ç≠„É´Áô∫Âãï`, value: 'skill', className: 'bg-yellow-500 text-white font-bold' }
                        ],
                        onClose: (val) => {
                            setChoicePopup(null);
                            if (val === 'attack') showAttackTargetSelect();
                            else if (val === 'skill') {
                                // „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏Êäû‰∏çË¶Å„Å™„Çπ„Ç≠„É´
                                if (['CLERIC', 'MONK', 'SPIRIT', 'PLAYBOY'].includes(activePlayer.roleKey)) {
                                    handleBossAction({ type: 'SKILL' });
                                } else if (activePlayer.roleKey === 'SAGE') {
                                    // SAGE„ÅØÂØæË±°ÈÅ∏Êäû„ÅåÂøÖË¶Å
                                    showAttackTargetSelect(true);
                                } else if (activePlayer.roleKey === 'THIEF') {
                                     // THIEF„ÅØÂØæË±°ÈÅ∏Êäû„ÅåÂøÖË¶Å
                                    showAttackTargetSelect(true);
                                } else if (activePlayer.roleKey === 'MAGE') {
                                    // MAGE„ÅØ„Éó„É¨„Ç§„É§„ÉºÈôêÂÆöÈÅ∏Êäû
                                    showAttackTargetSelect(true, 'PLAYER_ONLY');
                                } else if (activePlayer.roleKey === 'KNIGHT') {
                                    // È®éÂ£´„ÅÆÂ†¥Âêà„ÄÅÁâπÊÆä„Å™ÈÅ∏ÊäûËÇ¢„ÇíË°®Á§∫
                                    showAttackTargetSelect(true, 'KNIGHT_GUARD');
                                } else {
                                    // „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏Êäû„ÅåÂøÖË¶Å„Å™„Çπ„Ç≠„É´ (HERO, WARRIOR, BARRIER_MASTER)
                                    showAttackTargetSelect(true); 
                                }
                            }
                        }
                    });
                } else {
                    showAttackTargetSelect();
                }
            };

            const showAttackTargetSelect = (isSkill = false, filterType = 'ALL') => {
                const activePlayer = players.find(p => p.id === activePlayerId);
                
                let choices = [];
                let message = 'Ë™∞„ÇíÂØæË±°„Å´„Åó„Åæ„Åô„ÅãÔºü';
                
                // È≠îÊ≥ï‰Ωø„ÅÑ„ÅÆÂº∑ÂåñÈ≠îÊ≥ï„Å™„Å©„ÅØ„Éó„É¨„Ç§„É§„ÉºÈôêÂÆö
                if (filterType === 'PLAYER_ONLY') {
                    // ‰øÆÊ≠£: Ëá™ÂàÜ„ÇÇÂê´„ÇÅ„Çã (p.id !== activePlayerId„ÇíÂâäÈô§)
                    choices = players.filter(p => !p.isDead).map(p => ({ 
                        label: `${p.name} (Âº∑Âåñ)`, 
                        value: p.id, 
                        className: 'bg-green-600 text-white' 
                    }));
                } else if (filterType === 'KNIGHT_GUARD') {
                    // È®éÂ£´„ÅÆ„Åã„Å∞„ÅÜÈÅ∏Êäû
                    message = 'Ë™∞„Åã„Çâ„ÅÆÊîªÊíÉ„Çí„Åã„Å∞„ÅÑ„Åæ„Åô„ÅãÔºü';
                    choices = [
                        { label: '„Éó„É¨„Ç§„É§„Éº„Çí„Åã„Å∞„ÅÜ', value: 'GUARD_PLAYERS', className: 'bg-blue-600 text-white' },
                        { label: 'È≠îÁéã„Çí„Åã„Å∞„ÅÜ', value: 'GUARD_BOSS', className: 'bg-red-600 text-white' }
                    ];
                } else {
                    // ÈÄöÂ∏∏„ÅØÈ≠îÁéã + ‰ªñ„Éó„É¨„Ç§„É§„Éº
                    choices = [
                        { label: 'È≠îÁéã', value: 'BOSS', className: 'bg-purple-600 text-white font-bold text-xl' },
                        ...players.filter(p => !p.isDead && p.id !== activePlayerId).map(p => ({ label: `${p.name} (Ë£èÂàá„Çä)`, value: p.id, className: 'bg-slate-600 text-white' }))
                    ];
                }

                setChoicePopup({
                    title: isSkill ? '„Çπ„Ç≠„É´ÂØæË±°ÈÅ∏Êäû' : 'ÊîªÊíÉÂØæË±°ÈÅ∏Êäû',
                    message: message,
                    choices: choices,
                    onClose: (val) => {
                        setChoicePopup(null);
                        // ‰øÆÊ≠£: val„Åånull„ÇÑundefined„Åß„Å™„ÅÑ„Åì„Å®„ÇíÂé≥ÂØÜ„Å´„ÉÅ„Çß„ÉÉ„ÇØ (0„ÅÆÂ†¥Âêà„ÇÇËÄÉÊÖÆ)
                        if (val !== null && val !== undefined) handleBossAction({ type: isSkill ? 'SKILL' : 'ATTACK', targetId: val });
                    }
                });
            };

            const handleBossAction = (action) => {
                setBossBattleActions(prev => ({ ...prev, [activePlayerId]: action }));
                if (action.type === 'SKILL') setPlayers(prev => prev.map(p => p.id === activePlayerId ? {...p, ultimateSkillUsed: true} : p));
                if (actionQueue.length === 0) calculateBossBattleResult({ ...bossBattleActions, [activePlayerId]: action });
                else nextPlayer('BOSS_RESULT');
            };

            const calculateBossBattleResult = (actions) => {
                let newLog = []; 
                newLog.push({ text: `--- Round ${bossTurnCount} ---`, type: 'info' });
                let currentBossHP = bossHP;
                let nextPlayers = [...players];
                let currentState = { ...battleState };
                let currentRoundDamage = {}; // „É©„Ç¶„É≥„Éâ„ÉÄ„É°„Éº„Ç∏ÈõÜË®à

                // 0. „Çπ„Ç≠„É´‰ΩøÁî®Ê∏à„Åø„Éï„É©„Ç∞„ÅÆÁ¢∫ÂÆü„Å™Êõ¥Êñ∞
                Object.entries(actions).forEach(([pid, act]) => {
                    const index = nextPlayers.findIndex(p => p.id === parseInt(pid));
                    if (index !== -1 && act.type === 'SKILL') {
                        nextPlayers[index] = { ...nextPlayers[index], ultimateSkillUsed: true };
                    }
                });

                // 1. „Çπ„Ç≠„É´Áô∫ÂãïÂá¶ÁêÜ (Áä∂ÊÖãÂ§âÂåñÁ≥ª)
                Object.entries(actions).forEach(([attId, action]) => {
                    if (action.type !== 'SKILL') return;
                    const actor = nextPlayers.find(p => p.id === parseInt(attId));
                    const role = ROLES[actor.roleKey];
                    newLog.push({ text: `${actor.name} „ÅÆÂøÖÊÆ∫„Çπ„Ç≠„É´ÔºÅ„Äå${role.ultimateSkill.name}„Äç`, type: 'info' });

                    if (actor.roleKey === 'KNIGHT') { 
                        // È®éÂ£´„ÅÆ„Ç¨„Éº„Éâ„É¢„Éº„ÉâË®≠ÂÆö
                        if (action.targetId === 'GUARD_PLAYERS') {
                            currentState.knightGuard = { mode: 'GUARD_PLAYERS', knightId: actor.id };
                            newLog.push({ text: `>> „Éó„É¨„Ç§„É§„Éº„Å∏„ÅÆÊîªÊíÉ„Çí„Åã„Å∞„ÅÜÊßã„ÅàÔºÅ`, type: 'info' });
                        } else if (action.targetId === 'GUARD_BOSS') {
                            currentState.knightGuard = { mode: 'GUARD_BOSS', knightId: actor.id };
                            newLog.push({ text: `>> È≠îÁéã„Å∏„ÅÆÊîªÊíÉ„Çí„Åã„Å∞„ÅÜÊßã„ÅàÔºÅ`, type: 'info' });
                        }
                    }
                    else if (actor.roleKey === 'MONK') { 
                        const pIdx = nextPlayers.findIndex(p => p.id === actor.id);
                        nextPlayers[pIdx] = { ...nextPlayers[pIdx], charge: true };
                        newLog.push({ text: `>> Âäõ„ÇíÊ∫ú„ÇÅ„Å¶„ÅÑ„Çã...`, type: 'info' }); 
                    }
                    else if (actor.roleKey === 'THIEF') {
                         const pIdx = nextPlayers.findIndex(p => p.id === actor.id);
                         nextPlayers[pIdx] = { ...nextPlayers[pIdx], counterStance: true };
                         newLog.push({ text: `>> ÂèçÊíÉ„ÅÆÊßã„Åà„Çí„Å®„Å£„ÅüÔºÅ`, type: 'info' });
                    }
                    else if (actor.roleKey === 'SPIRIT') {
                        currentState.forceBossNormal = true;
                        newLog.push({ text: `>> È≠îÁéã„ÅÆÊîªÊíÉ„ÇíÈÄöÂ∏∏ÊîªÊíÉ„Å´Âº∑Âà∂Â§âÊõ¥ÔºÅ`, type: 'success' });
                    }
                    else if (actor.roleKey === 'BARRIER_MASTER') {
                        if (action.targetId === 'BOSS') {
                            currentState.bossStunned = true;
                            newLog.push({ text: `>> ÁµêÁïåË°ìÔºÅ È≠îÁéã„ÅÆË°åÂãï„ÇíÂ∞Å„Åò„ÅüÔºÅ`, type: 'success' });
                        } else {
                            const tIdx = nextPlayers.findIndex(p => p.id === parseInt(action.targetId));
                            if (tIdx !== -1) {
                                nextPlayers[tIdx] = { ...nextPlayers[tIdx], stunned: true };
                                newLog.push({ text: `>> ÁµêÁïåË°ìÔºÅ ${nextPlayers[tIdx].name} „ÅÆË°åÂãï„ÇíÂ∞Å„Åò„ÅüÔºÅ`, type: 'success' });
                            }
                        }
                    }
                    else if (actor.roleKey === 'CLERIC') {
                        const healAmount = nextPlayers.length * 4;
                        nextPlayers = nextPlayers.map(p => !p.isDead ? { ...p, currentHp: Math.min(p.maxHp, p.currentHp + healAmount) } : p);
                         newLog.push({ text: `>> ÂÖ®Âì°„ÅÆHP„Åå ${healAmount} ÂõûÂæ©ÔºÅ`, type: 'success' });
                    }
                    else if (actor.roleKey === 'MAGE') {
                         const target = nextPlayers.find(p => p.id === parseInt(action.targetId));
                         if(target) {
                             const pIdx = nextPlayers.findIndex(p => p.id === target.id);
                             // „Éê„Éï„ÅØÊ∞∏Á∂ö (nextPlayers„ÇíÊõ¥Êñ∞„Åó„Å¶state„Å´‰øùÂ≠ò„Åô„Çã„Åü„ÇÅ)
                             // Â§âÊõ¥: HPÂõûÂæ©„Å™„Åó„ÄÅATK+10, DEF+5
                             nextPlayers[pIdx] = { ...target, atkBonus: (target.atkBonus||0) + 10, defBonus: (target.defBonus||0) + 5 };
                             newLog.push({ text: `>> ${target.name} „ÇíÂº∑ÂåñÔºÅ(ATK+10, DEF+5)`, type: 'success' });
                         }
                    }
                     else if (actor.roleKey === 'PLAYBOY') {
                        newLog.push({ text: `>> „Åó„Åã„Åó „Å™„Å´„ÇÇ„Åä„Åì„Çâ„Å™„Åã„Å£„ÅüÔºÅ`, type: 'info' });
                    }
                });

                // 2. „Éó„É¨„Ç§„É§„ÉºÊîªÊíÉ„Éª„ÉÄ„É°„Éº„Ç∏Á≥ª„Çπ„Ç≠„É´
                Object.entries(actions).forEach(([attId, action]) => {
                    const actor = nextPlayers.find(p => p.id === parseInt(attId));
                    if (actor.isDead) return; 
                    if (actor.stunned) {
                        newLog.push({ text: `${actor.name} „ÅØË°åÂãï„ÇíÂ∞Å„Åò„Çâ„Çå„Å¶„ÅÑ„Å¶Âãï„Åë„Å™„ÅÑÔºÅ`, type: 'info' });
                        return;
                    }

                    let currentDmg = 0;
                    let isSkillAttack = (action.type === 'SKILL');
                    let skillName = "";

                    // „ÉÄ„É°„Éº„Ç∏ÁÆóÂá∫
                    if (actor.charge && action.type === 'ATTACK') {
                        // Ê≠£Êã≥Á™Å„ÅçÁô∫Âãï: ATK*3.5 (Âàá„ÇäÊç®„Å¶)
                        currentDmg = Math.floor((actor.level * ROLES[actor.roleKey].atk + (actor.atkBonus||0)) * 3.5); 
                        actor.charge = false;
                        skillName = "Ê≠£Êã≥Á™Å„Åç(Ëß£Êîæ)";
                    } else if (isSkillAttack) {
                        if (actor.roleKey === 'WARRIOR') {
                            // Ê∏æË∫´Êñ¨„Çä: ATK*2.5 (Âàá„ÇäÊç®„Å¶)
                            currentDmg = Math.floor((actor.level * ROLES[actor.roleKey].atk + (actor.atkBonus||0)) * 2.5);
                            skillName = "Ê∏æË∫´Êñ¨„Çä";
                        } else if (actor.roleKey === 'HERO') {
                            // ËÅñ„Å™„ÇãÊñ¨ÊíÉ: Âë≥ÊñπATKÂêàË®à*1.5 (Âàá„ÇäÊç®„Å¶)
                            const heroTotalAtk = nextPlayers.filter(p => !p.isDead && p.realTeam === 'HERO')
                                .reduce((sum, p) => sum + (p.level * ROLES[p.roleKey].atk + (p.atkBonus||0)), 0);
                            currentDmg = Math.floor(heroTotalAtk * 1.5);
                             skillName = "ËÅñ„Å™„ÇãÊñ¨ÊíÉ";
                        } else if (actor.roleKey === 'SAGE') {
                             if(action.targetId === 'BOSS') {
                                 currentDmg = 100; 
                             } else {
                                 currentDmg = 100;
                             }
                             // Ëá™Â∑±ÂõûÂæ©„ÅÆ„ÅøË°å„ÅÜ (‰∏äÈôê„ÉÅ„Çß„ÉÉ„ÇØÊ∏à„Åø)
                             const pIdx = nextPlayers.findIndex(p => p.id === actor.id);
                             if (pIdx !== -1) {
                                nextPlayers[pIdx] = { 
                                    ...nextPlayers[pIdx], 
                                    currentHp: Math.min(nextPlayers[pIdx].maxHp, nextPlayers[pIdx].currentHp + 20)
                                };
                                newLog.push({ text: `>> Ëá™Ë∫´„ÅÆHP„Çí20ÂõûÂæ©ÔºÅ`, type: 'success' });
                             }
                             skillName = "ÊòüËæ∞„ÅÆÂØ©Âà§";
                        } else if (actor.roleKey === 'THIEF') {
                            if (action.targetId === 'BOSS') {
                                // È≠îÁéãÊúÄÂ§ßHP„ÅÆ1/5 (Âàá„ÇäÊç®„Å¶)
                                currentDmg = Math.floor(bossMaxHP / 5);
                            } else {
                                currentDmg = (actor.level * ROLES[actor.roleKey].atk + (actor.atkBonus||0)) * 5;
                            }
                            skillName = "ÊÄ•ÊâÄ‰∏ÄÈñÉ";
                        }
                    } else {
                        // ÈÄöÂ∏∏ÊîªÊíÉ
                        currentDmg = actor.level * ROLES[actor.roleKey].atk + (actor.atkBonus||0);
                    }

                    if (currentDmg > 0) {
                        // Â§âÊõ¥: Ë°åÂãï„É≠„Ç∞„ÇíÁµ±‰∏ÄÁöÑ„Å´Âá∫„Åô
                        if (skillName) {
                             newLog.push({ text: `${actor.name} „ÅÆ ${skillName}ÔºÅ`, type: 'info' });
                        } else {
                             newLog.push({ text: `${actor.name} „ÅÆ ÈÄöÂ∏∏ÊîªÊíÉ`, type: 'info' });
                        }

                        if (action.targetId === 'BOSS') {
                            // È®éÂ£´„ÅÆÈ≠îÁéã„Åã„Å∞„ÅÜ„ÉÅ„Çß„ÉÉ„ÇØ
                            if (currentState.knightGuard && currentState.knightGuard.mode === 'GUARD_BOSS') {
                                const knight = nextPlayers.find(p => p.id === currentState.knightGuard.knightId);
                                if (knight && !knight.isDead) {
                                    newLog.push({ text: `${knight.name} „ÅåÈ≠îÁéã„Å∏„ÅÆÊîªÊíÉ„Çí„Åã„Å∞„Å£„ÅüÔºÅ`, type: 'info' });
                                    // DEFË®àÁÆó„Å™„Åó„Åß„ÉÄ„É°„Éº„Ç∏
                                    knight.currentHp -= currentDmg;
                                    newLog.push({ text: `${knight.name} „Å´ ${currentDmg} „ÉÄ„É°„Éº„Ç∏ÔºÅ(„Åã„Å∞„ÅÜ)`, type: 'damage' });
                                    if (knight.currentHp <= 0) {
                                         knight.currentHp = 0;
                                         knight.isDead = true;
                                         newLog.push({ text: `${knight.name} „ÅØ„Åã„Å∞„Å£„Å¶ÂäõÂ∞Ω„Åç„Åü...`, type: 'death' });
                                    }
                                    return; // „ÉÄ„É°„Éº„Ç∏Âá¶ÁêÜÁµÇ‰∫Ü
                                }
                            }

                            currentBossHP -= currentDmg;
                            newLog.push({ text: `È≠îÁéã„Å´ ${currentDmg} „ÉÄ„É°„Éº„Ç∏ÔºÅ`, type: 'damage' });
                            
                            // „ÉÄ„É°„Éº„Ç∏ÈõÜË®à
                            currentRoundDamage[actor.id] = (currentRoundDamage[actor.id] || 0) + currentDmg;
                            
                            // ‰∏é„ÉÄ„É°„Éº„Ç∏Ë®òÈå≤
                            const pIdx = nextPlayers.findIndex(p => p.id === actor.id);
                            nextPlayers[pIdx].totalDamageDealt += currentDmg;
                        } else {
                            // ÂØæ„Éó„É¨„Ç§„É§„Éº
                            const tIdx = nextPlayers.findIndex(p => p.id === parseInt(action.targetId));
                            if (tIdx !== -1 && !nextPlayers[tIdx].isDead) {
                                let target = nextPlayers[tIdx];
                                const def = (target.level * ROLES[target.roleKey].def) + (target.defBonus||0);
                                const realDmg = Math.max(1, currentDmg - def);
                                target.currentHp -= realDmg;
                                newLog.push({ text: `${target.name} „Å´ ${realDmg} „ÉÄ„É°„Éº„Ç∏ÔºÅ`, type: 'damage' });
                            }
                        }
                    }
                });

                // 3. È≠îÁéã„ÅÆÂèçÊíÉ
                if (currentBossHP > 0) {
                    if (currentState.bossStunned) {
                        newLog.push({ text: `È≠îÁéã„ÅØÁµêÁïå„Å´Êçï„Çâ„Çè„Çå„Å¶Âãï„Åë„Å™„ÅÑÔºÅ`, type: 'success' });
                    } else {
                        const livingHeroes = nextPlayers.filter(p => !p.isDead);
                        if (livingHeroes.length > 0) {
                            // ‰øÆÊ≠£: Âü∫Êú¨ÊîªÊíÉÂäõ = ÂàùÊúü‰∫∫Êï∞ * 3
                            const baseDmgVal = playerCount * 3;
                            let action = bossNextAction;
                            
                            // Á≤æÈúä‰Ωø„ÅÑ„Çπ„Ç≠„É´„Å´„Çà„ÇãÂº∑Âà∂Â§âÊõ¥
                            if (currentState.forceBossNormal) {
                                action = { type: 'NORMAL', name: 'ÈÄöÂ∏∏ÊîªÊíÉ (Âº∑Âà∂)', desc: '„É©„É≥„ÉÄ„É†„Å™ÂØæË±°„Å´Â§ß„ÉÄ„É°„Éº„Ç∏' };
                            }

                            const applyDamage = (target, rawDmg, ignoreDef = false) => {
                                if (target.isDead) return;
                                
                                // È®éÂ£´„ÅÆ„Éó„É¨„Ç§„É§„Éº„Åã„Å∞„ÅÜ„ÉÅ„Çß„ÉÉ„ÇØ
                                if (currentState.knightGuard && currentState.knightGuard.mode === 'GUARD_PLAYERS' && currentState.knightGuard.knightId !== target.id) {
                                     const knight = nextPlayers.find(p => p.id === currentState.knightGuard.knightId);
                                     if (knight && !knight.isDead) {
                                         // „Åã„Å∞„ÅÜÁô∫ÂãïÔºà„Çø„Éº„Ç≤„ÉÉ„ÉàÂ§âÊõ¥Ôºâ
                                         // „É°„ÉÉ„Çª„Éº„Ç∏„ÅØÂÖ®‰ΩìÊîªÊíÉ„Å™„Å©„Åß‰ΩïÂ∫¶„ÇÇÂá∫„Çã„ÅÆ„ÇíÈò≤„Åê„Åü„ÇÅ„ÄÅ„É≠„Ç∞„Å´„ÅØ‰∏ÄÂ∫¶„Å†„ÅëÂá∫„Åô„ÅÆ„ÅåÁêÜÊÉ≥„Å†„Åå
                                         // „Åì„Åì„Åß„ÅØ„Ç∑„É≥„Éó„É´„Å´ÁΩÆÊèõ„ÅÆ„ÅøË°å„ÅÜÔºàÂÖ®‰ΩìÊîªÊíÉ„ÅÆÂ†¥Âêà„ÅØÈ®éÂ£´„ÅåË§áÊï∞ÂõûÂèó„Åë„ÇãÔºâ
                                         target = knight; 
                                     }
                                }

                                const def = ignoreDef ? 0 : (target.level * ROLES[target.roleKey].def + (target.defBonus||0));
                                // Âàá„ÇäÊç®„Å¶Ë®àÁÆóÈÅ©Áî®
                                const realDmg = Math.floor(Math.max(1, rawDmg - def));
                                target.currentHp -= realDmg;
                                
                                // „Åã„Å∞„Å£„ÅüÂ†¥Âêà„ÅÆ„É≠„Ç∞Ë™øÊï¥Á≠â„ÅØË§áÈõë„Å´„Å™„Çã„Åü„ÇÅ„ÄÅ„Ç∑„É≥„Éó„É´„Å´Ë™∞„ÅåÂèó„Åë„Åü„Åã„ÇíË°®Á§∫
                                if (currentState.knightGuard && currentState.knightGuard.mode === 'GUARD_PLAYERS' && target.id === currentState.knightGuard.knightId) {
                                     newLog.push({ text: `${target.name} „Åå„Åã„Å∞„Å£„Å¶ ${realDmg} „ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„ÅüÔºÅ`, type: 'damage' });
                                } else {
                                     newLog.push({ text: `${target.name} „Å´ ${realDmg} „ÉÄ„É°„Éº„Ç∏ÔºÅ`, type: 'damage' });
                                }
                            };

                            if (action.type === 'ROAR') {
                                const targetIdx = Math.floor(Math.random() * livingHeroes.length);
                                let target = livingHeroes[targetIdx];
                                newLog.push({ text: `È≠îÁéã„ÅÆÂíÜÂìÆÔºÅÔºÅ`, type: 'death' });
                                target.currentHp = 0;
                                target.isDead = true;
                                newLog.push({ text: `${target.name} „ÅØÈ≠Ç„ÇíÊäú„Åã„Çå„Å¶Âç≥Ê≠ª„Åó„ÅüÔºÅ`, type: 'death' });
                                
                            } else if (action.type === 'HELLFIRE') {
                                // ÁçÑÁÇé: Âü∫Êú¨ÊîªÊíÉÂäõ * 1.5 (Èò≤Âæ°ÁÑ°Ë¶ñ)
                                const rawDmg = baseDmgVal * 1.5;
                                newLog.push({ text: `Èóá„ÅÆÁçÑÁÇéÔºÅ ÂÖ®Âì°„Å´ ${rawDmg} Èò≤Âæ°ÁÑ°Ë¶ñ„ÉÄ„É°„Éº„Ç∏ÔºÅ`, type: 'damage' });
                                livingHeroes.forEach(h => applyDamage(h, rawDmg, true));
                            } else if (action.type === 'MAGIC') {
                                // È≠îÊ≥ï: Âü∫Êú¨ÊîªÊíÉÂäõ * 1 (Èò≤Âæ°ÁÑ°Ë¶ñ)
                                const dmg = baseDmgVal * 1;
                                newLog.push({ text: `È≠îÊ≥ïÊîªÊíÉÔºÅ ÂÖ®Âì°„Å´ ${dmg} „ÉÄ„É°„Éº„Ç∏ÔºÅ(Èò≤Âæ°ÁÑ°Ë¶ñ)`, type: 'damage' });
                                livingHeroes.forEach(h => applyDamage(h, dmg, true));
                            } else {
                                // ÈÄöÂ∏∏: Âü∫Êú¨ÊîªÊíÉÂäõ * 2 (Áâ©ÁêÜ)
                                const rawDmg = baseDmgVal * 2;
                                // „Çø„Éº„Ç≤„ÉÉ„ÉàÊï∞: ÂàùÊúü‰∫∫Êï∞ - 2
                                const targetCount = Math.max(1, playerCount - 2);
                                newLog.push({ text: `È≠îÁéã„ÅÆÈÄöÂ∏∏ÊîªÊíÉÔºÅ „É©„É≥„ÉÄ„É†${targetCount}Âêç„Å´ ${rawDmg} Áâ©ÁêÜ„ÉÄ„É°„Éº„Ç∏ÔºÅ`, type: 'damage' });
                                
                                let targets = [];
                                const candidates = [...livingHeroes];
                                for(let i=0; i<targetCount; i++) {
                                    if(candidates.length === 0) break;
                                    const idx = Math.floor(Math.random() * candidates.length);
                                    targets.push(candidates[idx]);
                                    candidates.splice(idx, 1);
                                }
                                targets.forEach(t => applyDamage(t, rawDmg, false));
                            }
                        }
                    }
                }
                
                // Ê≠ª‰∫°Âà§ÂÆöÊõ¥Êñ∞
                nextPlayers.forEach(p => {
                    if (p.currentHp <= 0) {
                        p.currentHp = 0;
                        if(!p.isDead) {
                            p.isDead = true;
                            newLog.push({ text: `${p.name} „ÅØÂäõÂ∞Ω„Åç„Åü...`, type: 'death' });
                        }
                    }
                });

                setBossHP(Math.max(0, currentBossHP)); setPlayers(nextPlayers);
                setBossBattleLog(prev => [...newLog, ...prev]); setBattleState(currentState);
                setRoundDamageReport(currentRoundDamage);
                setPhase('BOSS_RESULT');
            };

            const nextBossRound = () => {
                if (bossHP <= 0) { setWinner('HERO'); setPhase('RESULT'); }
                else if (!players.some(p => !p.isDead)) { setWinner('DEMON'); setPhase('RESULT'); }
                else if (bossTurnCount >= 3) { setWinner('DEMON'); setPhase('RESULT'); }
                else { setBossTurnCount(c => c + 1); startBossBattleRound(); }
            };

            const activePlayer = players.find(p => p.id === activePlayerId) || players[0];
            const activePlayerName = activePlayer 
                ? (['STRATEGY','QUEST_RESULT','VOTE_DISCUSS','BOSS_INTRO','BOSS_RESULT', 'EXILE_READY', 'EXILE_RESULT', 'BOSS_ACTION_ANNOUNCE'].includes(phase) ? 'ÂÖ®Âì°' : activePlayer.name)
                : '';

            if (phase === 'INTRO') return (
                <div className="h-screen w-screen flex flex-col items-center justify-center p-4 bg-slate-950 text-white text-center overflow-hidden">
                    <div className="w-full max-w-4xl mb-4 flex-none">
                        <img src="„Éò„ÉÉ„ÉÄ„Éº.png" alt={GAME_TEXTS.TITLE} className="w-full object-contain" onError={(e) => e.target.style.display = 'none'} />
                    </div>
                    
                    <div className="w-full max-w-6xl bg-slate-900/90 p-6 rounded-xl border border-slate-700 shadow-2xl mb-4 text-left space-y-4 overflow-y-auto flex-grow max-h-[50vh]">
                        <div className="space-y-2 text-slate-300 leading-relaxed">
                            {GAME_TEXTS.STORY.map((line, i) => <p key={i}>{line}</p>)}
                        </div>

                        <div className="border-t border-slate-700 pt-4">
                            <h3 className="text-xl font-bold text-yellow-400 mb-2">„Ç≤„Éº„É†Ê¶ÇË¶Å</h3>
                            <p className="text-sm md:text-base text-slate-300 whitespace-pre-wrap leading-relaxed">
                                „Åì„ÅÆ„Ç≤„Éº„É†„Åß„ÅØ‰ª≤Èñì„Å®„ÇØ„Ç®„Çπ„Éà„Çí„ÇØ„É™„Ç¢„Åó„Å¶„É¨„Éô„É´„Çí‰∏ä„Åí„ÄÅË£èÂàáËÄÖ„Å´ÈÇ™È≠î„Åï„Çå„Çã„Åì„Å®„Å™„ÅèÈ≠îÁéã„ÇíË®é‰ºê„Åô„Çã„Åì„Å®„ÅåÁõÆÁöÑ„ÅÆ„Ç≤„Éº„É†„Åß„Åô„ÄÇ<br/>
                                Êßò„ÄÖ„Å™„Çπ„Ç≠„É´„ÇÑËÅ∑Ê•≠„Åî„Å®„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊ¥ªÁî®„Åó„ÄÅ<span className="text-blue-400 font-bold">ÂãáËÄÖÈô£Âñ∂</span>„ÅØÈ≠îÁéãË®é‰ºê„ÇíÁõÆÊåá„Åó<span className="text-red-500 font-bold">È≠îÁéãÈô£Âñ∂</span>„ÅØÈ≠îÁéãË®é‰ºê„ÇíÈòªÊ≠¢„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ
                            </p>
                        </div>
                        
                        {/* „Ç≤„Éº„É†„ÅÆÊµÅ„Çå„Çª„ÇØ„Ç∑„Éß„É≥„ÅØÂâäÈô§ */}
                        <p className="text-xs text-slate-400 mt-2 border-t border-slate-800 pt-2">{GAME_TEXTS.NOTE}</p>
                    </div>

                    {/* „Éú„Çø„É≥„Ç®„É™„Ç¢ */}
                    <div className="flex flex-col md:flex-row gap-4 items-center justify-center flex-none">
                        <button onClick={() => setPhase('SETUP')} className="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white px-12 py-4 rounded-full text-2xl font-bold shadow-lg transform transition hover:scale-105">
                            ÂÜíÈô∫„ÇíÂßã„ÇÅ„Çã
                        </button>
                        <a href="guide.html" target="_blank" className="bg-slate-700 hover:bg-slate-600 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg border border-slate-500 transition flex items-center gap-2">
                            <span>üìñ</span> ÂÖ¨Âºè„Ç¨„Ç§„Éâ„ÇíË¶ã„Çã
                        </a>
                    </div>
                </div>
            );

            if (phase === 'SETUP') return (
                <div className="h-screen w-screen flex flex-col items-center justify-center p-4 bg-slate-900 text-white overflow-hidden">
                    {/* „Ç¨„Ç§„Éâ„Éú„Çø„É≥ËøΩÂä† */}
                    <div className="absolute top-4 right-4">
                        <a href="guide.html" target="_blank" className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-bold shadow border border-slate-500 transition flex items-center gap-2 text-sm">
                            <span>üìñ</span> „Ç¨„Ç§„Éâ
                        </a>
                    </div>
                    <h2 className="text-3xl font-bold mb-8">„Éó„É¨„Ç§‰∫∫Êï∞„ÇíÈÅ∏Êäû</h2>
                    <div className="grid grid-cols-3 gap-6 w-full max-w-md">
                        {[3,4,5,6].map(n => (
                            <button key={n} onClick={()=>selectPlayerCount(n)} className="aspect-square bg-slate-800 hover:bg-blue-900 border-2 border-slate-600 hover:border-blue-400 rounded-2xl font-bold text-4xl shadow-lg transition">
                                {n}<span className="text-base block mt-1 text-slate-400">‰∫∫</span>
                            </button>
                        ))}
                    </div>
                </div>
            );

            if (phase === 'NAME_ENTRY') return (
                <div className="h-screen w-screen flex flex-col items-center justify-center p-4 bg-slate-900 text-white overflow-hidden">
                    <div className="bg-slate-800 p-6 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-lg flex flex-col max-h-[90vh]">
                        <h2 className="text-2xl font-bold mb-4 text-center text-yellow-400 flex-none">„Éó„É¨„Ç§„É§„ÉºÂêçÂÖ•Âäõ</h2>
                        <div className="space-y-3 overflow-y-auto flex-grow pr-2 mb-4">
                            {playerNames.map((name, i) => (
                                <div key={i} className="flex flex-col">
                                    <label className="text-sm text-slate-400 mb-1">Player {i+1}</label>
                                    <input type="text" value={name} onChange={(e) => { const newNames = [...playerNames]; newNames[i] = e.target.value; setPlayerNames(newNames); }}
                                        className="bg-slate-700 text-white p-3 rounded border border-slate-600 focus:border-blue-500 outline-none text-lg" />
                                </div>
                            ))}
                        </div>
                        <button onClick={startGame} className="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold text-xl shadow-lg flex-none">„Ç≤„Éº„É†ÈñãÂßã</button>
                    </div>
                </div>
            );

            if (phase === 'ORDER_ANNOUNCE') return (
                <div className="h-screen w-screen flex flex-col items-center justify-center p-4 bg-slate-950 text-white overflow-hidden">
                    <div className="bg-slate-800 p-8 rounded-xl shadow-2xl border border-slate-700 w-full max-w-xl">
                        <h2 className="text-3xl font-bold mb-8 text-center text-yellow-400">Ë°åÂãïÈ†ÜÂ∫èÊ±∫ÂÆö</h2>
                        <div className="space-y-4">
                            {turnOrder.map((pid, idx) => {
                                const p = players.find(pl => pl.id === pid);
                                return (
                                    <div key={pid} className="flex items-center bg-slate-700 p-4 rounded-lg border border-slate-600">
                                        <span className="text-2xl font-black text-blue-400 w-12 text-center mr-4">{idx + 1}</span>
                                        <span className="text-xl font-bold">{p.name}</span>
                                    </div>
                                );
                            })}
                        </div>
                        <button onClick={startRoleConfirm} className="w-full mt-8 bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold text-xl shadow-lg">
                            Ê¨°„Å∏
                        </button>
                    </div>
                </div>
            );

            if (phase === 'RESULT') return (
                <div className="h-screen w-screen flex flex-col items-center justify-center p-4 bg-slate-950 text-white overflow-hidden">
                    <h1 className={`text-5xl font-black mb-6 ${winner === 'HERO' ? 'text-yellow-400' : 'text-purple-500'}`}>
                        {winner === 'HERO' ? 'ÂãáËÄÖÂãùÂà©ÔºÅ' : 'È≠îÁéãÂãùÂà©...'}
                    </h1>
                    <div className="bg-slate-800 p-6 rounded-xl max-w-xl w-full shadow-2xl border border-slate-700 flex flex-col max-h-[70vh]">
                        <h2 className="text-xl mb-4 border-b border-slate-600 pb-2 flex-none">ÊúÄÁµÇÁµêÊûú</h2>
                        <div className="overflow-y-auto flex-grow pr-2">
                            {players.map(p => (
                                <div key={p.id} className="flex justify-between items-center bg-slate-700/50 p-3 rounded mb-2">
                                    <div>
                                        <span className="font-bold mr-2 text-lg">{p.name}</span>
                                        <span className="text-base text-slate-300">({p.roleName} Lv.{p.level})</span>
                                        {p.isDead && <span className="text-red-500 font-bold ml-2 text-sm">DEATH</span>}
                                    </div>
                                    <div className="text-right">
                                        <span className={`font-bold text-lg block ${p.realTeam==='HERO'?'text-blue-400':'text-red-500'}`}>{p.realTeam==='HERO'?'ÂãáËÄÖ':'È≠îÁéã'}</span>
                                        <span className="text-xs text-yellow-200 block">‰∏é„ÉÄ„É°: {p.totalDamageDealt}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <button onClick={handleBackToTitleForce} className="mt-8 w-full max-w-md bg-green-600 py-4 rounded-xl font-bold text-xl shadow-lg">„Çø„Ç§„Éà„É´„Å∏Êàª„Çã</button>
                </div>
            );

            if (isHandover && activePlayer) return <HandoverScreen nextPlayerName={activePlayer.name} onOpen={() => setIsHandover(false)} />;

            return (
                <div className="h-screen w-screen bg-slate-900 text-slate-200 flex flex-col overflow-hidden">
                    <GameStatusHUD bossHP={bossHP} bossMaxHP={bossMaxHP} players={players} turnOrder={turnOrder} turn={turn} maxTurn={maxTurn} phase={phase} activePlayerName={activePlayerName} onOpenRoleList={()=>setShowRoleList(true)} bossTurnCount={bossTurnCount} onBackToTitle={handleBackToTitle} />
                    {popup && <Popup {...popup} />}
                    {choicePopup && <ChoicePopup {...choicePopup} />}
                    <RoleListModal isOpen={showRoleList} onClose={()=>setShowRoleList(false)} />

                    <main className="flex-grow overflow-y-auto p-2 flex flex-col pt-24 md:pt-28">
                        {/* „Çπ„ÉÜ„Éº„Çø„Çπ„ÉªÈô£Âñ∂„Éª„Çπ„Ç≠„É´Â∏∏ÊôÇË°®Á§∫ (ÂÄãÂà•Ë°åÂãïÊôÇ„ÅÆ„Åø) */}
                        {['ROLE_CONFIRM', 'ACTION_SELECT', 'VOTE_SELECT', 'BOSS_SELECT'].includes(phase) && activePlayer && (
                            <section className={`flex-none bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl border border-slate-700 shadow-xl mb-4 relative overflow-hidden ${phase === 'BOSS_SELECT' ? 'p-6' : 'p-3'}`}>
                                <div className="absolute top-0 right-0 bg-yellow-600 text-xs px-3 py-1 rounded-bl text-white font-bold z-20">STATUS</div>
                                
                                {/* „Ç≠„É£„É©„ÇØ„Çø„ÉºÁîªÂÉèËÉåÊôØ */}
                                <div className="absolute right-0 bottom-0 w-1/2 h-full opacity-20 pointer-events-none z-0">
                                    <img src={ROLES[activePlayer.roleKey].img} className="w-full h-full object-contain object-right-bottom" onError={(e) => e.target.style.display = 'none'} />
                                </div>

                                <div className="relative z-10">
                                    {phase === 'ROLE_CONFIRM' ? (
                                        <div className={`mb-4 p-4 rounded-xl text-center font-black text-4xl border-4 shadow-xl ${activePlayer.realTeam === 'HERO' ? 'bg-blue-900/90 border-blue-400 text-blue-200' : 'bg-red-900/90 border-red-500 text-red-200'}`}>
                                            {activePlayer.realTeam === 'HERO' ? 'ÂãáËÄÖÈô£Âñ∂' : 'È≠îÁéãÈô£Âñ∂'}
                                        </div>
                                    ) : (
                                        // ÈÄöÂ∏∏ÊôÇ„ÅØ„Ç≥„É≥„Éë„ÇØ„Éà„Å´ („Ç¢„Ç§„Ç≥„É≥ËøΩÂä†)
                                        <div className="flex items-center gap-2 mb-2">
                                            <div className={`${phase === 'BOSS_SELECT' ? 'w-32 h-32' : 'w-12 h-12'} rounded-full border-2 border-yellow-500 bg-slate-800 overflow-hidden flex-none relative z-10 shadow-md transition-all`}>
                                                <img src={ROLES[activePlayer.roleKey].img} className="w-full h-full object-cover" onError={(e) => e.target.style.display = 'none'} />
                                            </div>
                                            <div>
                                                <div className="flex items-baseline gap-2">
                                                    <h2 className={`${phase === 'BOSS_SELECT' ? 'text-3xl' : 'text-2xl'} font-black text-yellow-500 drop-shadow-md leading-none transition-all`}>{activePlayer.roleName}</h2>
                                                    <span className={`${phase === 'BOSS_SELECT' ? 'text-3xl' : 'text-sm'} font-bold text-white bg-slate-700 px-2 rounded shadow transition-all`}>Lv.{activePlayer.level}</span>
                                                </div>
                                                <div className={`self-start mt-1 px-2 py-0.5 rounded font-bold border shadow inline-block ${activePlayer.realTeam === 'HERO' ? 'bg-blue-900/50 border-blue-500 text-blue-300' : 'bg-red-900/50 border-red-500 text-red-400'} ${phase === 'BOSS_SELECT' ? 'text-sm' : 'text-xs'} transition-all`}>
                                                    {activePlayer.realTeam === 'HERO' ? 'ÂãáËÄÖÈô£Âñ∂' : 'È≠îÁéãÈô£Âñ∂'}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {phase === 'ROLE_CONFIRM' && (
                                        <>
                                            <div className="text-center mb-3">
                                                <div className="w-24 h-24 mx-auto bg-slate-800 rounded-full border-4 border-yellow-500 overflow-hidden mb-2 shadow-lg">
                                                    <img src={ROLES[activePlayer.roleKey].img} className="w-full h-full object-cover" onError={(e) => e.target.style.display = 'none'} />
                                                </div>
                                                <h2 className="text-3xl font-black text-yellow-500 drop-shadow-md">{activePlayer.roleName}</h2>
                                            </div>
                                            {/* ‰∏¶„Å≥È†ÜÂ§âÊõ¥: HP -> ATK -> DEF */}
                                            <div className="grid grid-cols-3 gap-3 text-center text-white mb-3">
                                                <div className="bg-slate-800/80 p-2 rounded border border-slate-600 backdrop-blur-sm">
                                                    <span className="text-xs text-slate-400 block">HP(‰ΩìÂäõ)</span>
                                                    <span className="text-xl font-bold">{activePlayer.maxHp}</span>
                                                </div>
                                                <div className="bg-slate-800/80 p-2 rounded border border-slate-600 backdrop-blur-sm">
                                                    <span className="text-xs text-slate-400 block">ATK(ÊîªÊíÉ)</span>
                                                    <span className="text-xl font-bold">{activePlayer.level * ROLES[activePlayer.roleKey].atk + (activePlayer.atkBonus||0)}</span>
                                                </div>
                                                <div className="bg-slate-800/80 p-2 rounded border border-slate-600 backdrop-blur-sm">
                                                    <span className="text-xs text-slate-400 block">DEF(Èò≤Âæ°)</span>
                                                    <span className="text-xl font-bold">{activePlayer.level * ROLES[activePlayer.roleKey].def + (activePlayer.defBonus||0)}</span>
                                                </div>
                                            </div>
                                            <p className="text-sm text-slate-200 mb-3 italic text-center bg-slate-900/50 p-2 rounded">{ROLES[activePlayer.roleKey].desc}</p>
                                        </>
                                    )}
                                    
                                    {/* Á∞°ÊòìË°®Á§∫: HP„Çí‰∏ä„Å´„ÄÅATK/DEF„Çí‰∏ã„Å´Â§âÊõ¥ */}
                                    {phase !== 'ROLE_CONFIRM' && (
                                        <div className="mt-2">
                                            <div className="flex justify-between items-end mb-1">
                                                <span className="text-[10px] text-slate-400">HP</span>
                                                <span className="text-sm font-bold text-white">{activePlayer.currentHp} / {activePlayer.maxHp}</span>
                                            </div>
                                            <div className="mb-2">
                                                <HPBar current={activePlayer.currentHp} max={activePlayer.maxHp} showText={false} label={null} />
                                            </div>
                                            
                                            <div className={`flex gap-3 text-xs text-slate-300 mb-1 ${phase === 'BOSS_SELECT' ? 'ml-1 text-3xl' : 'ml-1 text-xs'} transition-all`}>
                                                <span>ATK: <b className="text-white">{activePlayer.level * ROLES[activePlayer.roleKey].atk + (activePlayer.atkBonus||0)}</b></span>
                                                <span>DEF: <b className="text-white">{activePlayer.level * ROLES[activePlayer.roleKey].def + (activePlayer.defBonus||0)}</b></span>
                                            </div>
                                        </div>
                                    )}

                                    {/* „Çπ„Ç≠„É´ÊÉÖÂ†±Ë°®Á§∫ (2„Å§) */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        <div className={`p-2 rounded border border-slate-600 backdrop-blur-sm ${activePlayer.uniqueSkillUsed ? 'bg-slate-800/50 opacity-60' : 'bg-slate-800/80'} h-full`}>
                                            <div className="flex justify-between items-center mb-1">
                                                <span className={`font-bold text-yellow-400 ${phase === 'BOSS_SELECT' ? 'text-lg' : 'text-xs'}`}>Âõ∫Êúâ: {ROLES[activePlayer.roleKey].uniqueSkill.name}</span>
                                                <span className={`font-bold px-2 py-0.5 rounded ${activePlayer.uniqueSkillUsed ? 'bg-red-900 text-red-300' : 'bg-green-900 text-green-300'} text-[10px]`}>
                                                    {ROLES[activePlayer.roleKey].uniqueSkill.type === 'PASSIVE' ? 'Ëá™Âãï' : activePlayer.uniqueSkillUsed ? '‰ΩøÁî®Ê∏à' : 'Êú™‰ΩøÁî®'}
                                                </span>
                                            </div>
                                            <p className="text-[10px] text-slate-300 whitespace-pre-wrap break-words leading-tight">{formatSkillDesc(ROLES[activePlayer.roleKey].uniqueSkill.desc)}</p>
                                        </div>
                                        
                                        <div className={`p-2 rounded border border-slate-600 backdrop-blur-sm ${activePlayer.ultimateSkillUsed ? 'bg-slate-800/50 opacity-60' : 'bg-slate-800/80'} h-full`}>
                                            <div className="flex justify-between items-center mb-1">
                                                <span className={`font-bold text-red-400 ${phase === 'BOSS_SELECT' ? 'text-lg' : 'text-xs'}`}>ÂøÖÊÆ∫: {ROLES[activePlayer.roleKey].ultimateSkill.name}</span>
                                                <span className={`font-bold px-2 py-0.5 rounded ${activePlayer.ultimateSkillUsed ? 'bg-red-900 text-red-300' : 'bg-green-900 text-green-300'} text-[10px]`}>
                                                    {activePlayer.ultimateSkillUsed ? '‰ΩøÁî®Ê∏à' : 'Êú™‰ΩøÁî®'}
                                                </span>
                                            </div>
                                            <p className="text-[10px] text-slate-300 whitespace-pre-wrap break-words leading-tight">{formatSkillDesc(ROLES[activePlayer.roleKey].ultimateSkill.desc)}</p>
                                        </div>
                                    </div>

                                    {/* „ÇØ„Ç®„Çπ„Éà„Éï„Çß„Éº„Ç∫„ÅÆ„Çπ„Ç≠„É´„Éú„Çø„É≥ */}
                                    {phase === 'ACTION_SELECT' && !activePlayer.uniqueSkillUsed && ROLES[activePlayer.roleKey].uniqueSkill.type === 'QUEST_ACTIVE' && (
                                        <button onClick={handleUniqueSkill} className="mt-2 w-full bg-purple-600 text-white py-2 rounded font-bold text-base shadow animate-pulse hover:scale-105 transition">
                                            Âõ∫Êúâ„Çπ„Ç≠„É´Áô∫Âãï
                                        </button>
                                    )}
                                </div>
                            </section>
                        )}

                        {/* „Éï„Çß„Éº„Ç∫Âà•„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
                        <div className="flex-grow flex flex-col justify-start overflow-y-auto"> {/* justify-start„Å´Â§âÊõ¥„Åó„ÄÅoverflow-y-auto„ÇíËøΩÂä† */}
                            {phase === 'ROLE_CONFIRM' && (
                                <div className="text-center py-4 pb-20"> {/* ‰∏ãÈÉ®„Å´‰ΩôÁôΩ„ÇíËøΩÂä† */}
                                    {/* „ÉÜ„Ç≠„Çπ„ÉàÂâäÈô§: „Éú„Çø„É≥„ÅÆ„ÅøÈÖçÁΩÆ */}
                                    <button onClick={finishRoleConfirm} className="w-full bg-slate-700 hover:bg-slate-600 text-white py-5 rounded-2xl font-bold shadow-lg text-2xl transition transform hover:scale-105">Á¢∫Ë™çÂÆå‰∫Ü</button>
                                </div>
                            )}

                            {phase === 'STRATEGY' && (
                                <div className="text-center h-full flex flex-col justify-start">
                                    <div className="flex justify-center items-center gap-4 mb-4 flex-none">
                                        <div className="text-5xl font-mono font-bold text-yellow-500">
                                            {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}
                                        </div>
                                        <button onClick={() => { setTimeLeft(0); startActionPhase(); }} className="bg-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg text-lg hover:bg-green-500 transition">
                                            ‰ºöË≠∞ÁµÇ‰∫Ü
                                        </button>
                                    </div>

                                    <p className="mb-4 text-lg text-slate-400 flex-none">‰ΩúÊà¶‰ºöË≠∞‰∏≠...</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4 text-left overflow-y-auto flex-grow content-start">
                                        {quests.map(q => (
                                            <div key={q.id} className={`bg-slate-800 p-2 rounded-xl border-2 ${q.borderColor} relative shadow-md`}>
                                                <div className="flex justify-between items-center mb-1">
                                                    <div className={`font-black text-lg ${q.color}`}>{q.title} <span className="text-base text-slate-400">({q.rank})</span></div>
                                                    <div className="flex items-center gap-2">
                                                         <span className="text-red-400 font-bold text-sm bg-red-900/30 px-2 py-1 rounded border border-red-500/30 whitespace-nowrap">
                                                            HP -{q.damageVal}
                                                         </span>
                                                         <div className="bg-slate-900/80 px-3 py-1 rounded border border-slate-600 text-center">
                                                            <span className="text-[10px] text-slate-400 block leading-none">ÂøÖË¶Å</span>
                                                            <span className="text-lg font-black text-white leading-none">{q.req}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <div className="text-base text-white font-bold">Â†±ÈÖ¨: Lv +{q.rewardVal}</div>
                                                    <div className="text-sm font-bold text-yellow-200 bg-slate-700/50 px-2 py-1 rounded">Ë®é‰ºê: {q.monsterName}</div>
                                                </div>
                                                {/* ÁîªÂÉè„Ç®„É™„Ç¢ËøΩÂä† */}
                                                {q.img && (
                                                    <div className="absolute bottom-1 right-1 w-16 h-16 opacity-80 pointer-events-none">
                                                        <img src={q.img} alt={q.monsterName} className="w-full h-full object-contain" onError={(e) => e.target.style.display = 'none'} />
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {phase === 'ACTION_SELECT' && (
                                <div className="flex-grow flex flex-col h-full overflow-hidden">
                                    <h3 className="text-center mb-3 text-lg text-slate-400 flex-none font-bold">Ë°åÂãï„ÇíÈÅ∏Êäû</h3>
                                    <div className="flex-grow overflow-y-auto pr-1 pb-4">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            {quests.map(q => (
                                                <div key={q.id} onClick={() => handleQuestClick(q)} className={`bg-slate-800 p-2 rounded-xl border-2 ${q.borderColor} active:bg-slate-700 cursor-pointer relative shadow-md hover:scale-[1.01] transition overflow-hidden ${q.bgColor || ''}`}>
                                                    {/* ‰øÆÊ≠£: „ÉÄ„É°„Éº„Ç∏„Å®ÂøÖË¶Å‰∫∫Êï∞„ÇíÂè≥‰∏ä„Å´‰∏¶„Åπ„Å¶ÈÖçÁΩÆ */}
                                                    <div className="absolute top-0 right-0 flex z-20">
                                                        {/* „ÉÄ„É°„Éº„Ç∏ */}
                                                        <div className="bg-red-900/80 px-2 py-1 border-b border-l border-red-700 flex items-center">
                                                            <span className="text-xs text-red-200 font-bold">-{q.damageVal} HP</span>
                                                        </div>
                                                        {/* ÂøÖË¶Å‰∫∫Êï∞ */}
                                                        <div className="bg-slate-900/90 px-2 py-1 rounded-bl-xl border-b border-l border-slate-600 flex items-center">
                                                            <span className="text-[10px] text-slate-400 mr-1">ÂøÖË¶Å</span>
                                                            <span className="text-lg font-black text-white">{q.req === 0 ? '‚àû' : q.req}</span>
                                                            <span className="text-xs text-slate-400 ml-0.5">{q.req === 0 ? '' : '‰∫∫'}</span>
                                                        </div>
                                                    </div>

                                                    <div className="mt-1 relative z-10">
                                                        <div className={`font-black text-lg ${q.color} mb-1`}>{q.title}</div>
                                                        <div className="text-base text-yellow-400 font-bold">Â†±ÈÖ¨ Lv+{q.rewardVal} <span className="text-slate-400 text-sm ml-2">({q.monsterName})</span></div>
                                                    </div>
                                                    
                                                    {/* ÁîªÂÉè„Ç®„É™„Ç¢ËøΩÂä†: S„É©„É≥„ÇØ‰ª•‰∏ä„ÅØËÉåÊôØ„Å®„Åó„Å¶ËñÑ„ÅèË°®Á§∫ */}
                                                    {q.img && (
                                                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                                                            <img src={q.img} alt={q.monsterName} className="w-24 h-24 object-contain opacity-30" onError={(e) => e.target.style.display = 'none'} />
                                                        </div>
                                                    )}
                                                    
                                                    <div className="absolute bottom-2 right-2 px-2 py-0.5 text-sm text-blue-400 font-bold bg-slate-900 rounded border border-blue-900 z-20">„Çø„ÉÉ„Éó„ÅßÂèÇÂä†</div>
                                                </div>
                                            ))}
                                            
                                            <div onClick={() => handleTrainingClick()} className="bg-slate-800 p-2 rounded-xl border-2 border-yellow-500/50 active:bg-yellow-900/20 cursor-pointer flex flex-col justify-center items-center text-center hover:bg-slate-750 transition">
                                                <span className="text-3xl mb-1"> </span>
                                                <div className="font-bold text-yellow-300 text-lg">ÂÄã‰∫∫‰øÆË°å</div>
                                                <div className="text-xs text-slate-400">Lv+1 / HPÂ§âÂãï„Å™„Åó</div>
                                            </div>
                                            <div onClick={() => handleRestClick()} className="bg-slate-800 p-2 rounded-xl border-2 border-green-500/50 active:bg-green-900/20 cursor-pointer flex flex-col justify-center items-center text-center hover:bg-slate-750 transition">
                                                <span className="text-3xl mb-1"> </span>
                                                <div className="font-bold text-green-300 text-lg">‰ºëÊÅØ</div>
                                                <div className="text-xs text-slate-400">LvÂ§âÂãï„Å™„Åó / HPÂÖ®ÂõûÂæ©</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {phase === 'QUEST_RESULT' && (
                                <div className="text-center h-full flex flex-col">
                                    <h3 className="text-3xl font-bold text-white mb-6 flex-none">„ÇØ„Ç®„Çπ„ÉàÁµêÊûú</h3>
                                    <div className="space-y-3 mb-4 overflow-y-auto flex-grow">
                                        {questResults.map((res, idx) => (
                                            <div key={idx} className={`p-4 rounded-xl border-l-8 text-left bg-slate-800 shadow-md ${res.isSuccess?'border-green-500':'border-red-500'}`}>
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className={`font-black text-xl ${res.quest.color}`}>{res.quest.title}</span>
                                                    <span className={`px-4 py-1 rounded text-base font-black ${res.isSuccess?'bg-green-900 text-green-300':'bg-red-900 text-red-300'}`}>{res.isSuccess?'ÊàêÂäü':'Â§±Êïó'}</span>
                                                </div>
                                                <div className="text-lg text-slate-300">
                                                    ÂèÇÂä†‰∫∫Êï∞: <span className="font-bold text-white text-2xl">{res.participantsCount}</span> {res.quest.req > 0 ? `/ ${res.quest.req}` : ''}
                                                    {res.heroSkill && <span className="text-yellow-400 ml-3 text-base font-bold">‚òÖÂãáËÄÖ„Çπ„Ç≠„É´Áô∫Âãï</span>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    {/* ‰øÆÊ≠£: 1„Çø„Éº„É≥ÁõÆ„ÅØËøΩÊîæ‰ºöË≠∞„Çí„Çπ„Ç≠„ÉÉ„Éó„ÄÇÂÖ®ÊªÖÊôÇ„ÅØÈ≠îÁéãÂãùÂà©ÁîªÈù¢„Å∏ */}
                                    {turn === 1 ? (
                                        <button onClick={() => {
                                            const survivors = players.filter(p => !p.isDead).length;
                                            if(survivors === 0) {
                                                setWinner('DEMON');
                                                setPhase('RESULT');
                                            } else {
                                                startNewTurn(window.tempClearedIds || [])
                                            }
                                        }} className="bg-green-600 w-full py-5 rounded-xl font-bold shadow flex-none text-2xl hover:bg-green-500 transition">Ê¨°„ÅÆÊó•„Å∏</button>
                                    ) : (
                                        <div className="flex flex-col gap-3">
                                            <button onClick={() => {
                                                 const survivors = players.filter(p => !p.isDead).length;
                                                 if(survivors === 0) {
                                                     setWinner('DEMON');
                                                     setPhase('RESULT');
                                                 } else {
                                                     startVoteDiscussion();
                                                 }
                                            }} className="bg-blue-600 w-full py-5 rounded-xl font-bold shadow flex-none text-2xl hover:bg-blue-500 transition">ËøΩÊîæ‰ºöË≠∞„Å∏</button>
                                            
                                            {/* ËøΩÊîæ‰ºöË≠∞„Çπ„Ç≠„ÉÉ„Éó„Éú„Çø„É≥: ÁîüÂ≠òËÄÖ2Âêç‰ª•‰∏ã„ÅßË°®Á§∫ */}
                                            {players.filter(p => !p.isDead).length <= 2 && (
                                                <button onClick={() => {
                                                     const survivors = players.filter(p => !p.isDead).length;
                                                     if(survivors === 0) {
                                                         setWinner('DEMON');
                                                         setPhase('RESULT');
                                                     } else {
                                                         startNewTurn(window.tempClearedIds || []);
                                                     }
                                                }} className="bg-slate-600 w-full py-4 rounded-xl font-bold shadow flex-none text-lg hover:bg-slate-500 transition text-slate-300 border-2 border-slate-500">ËøΩÊîæ‰ºöË≠∞„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶Ê¨°„ÅÆÊó•„Å∏</button>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}

                            {phase === 'VOTE_DISCUSS' && (
                                <div className="text-center h-full flex flex-col justify-center">
                                    <div className="text-7xl font-mono font-bold text-red-500 mb-8">{Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}</div>
                                    <p className="mb-10 text-2xl font-bold">ËøΩÊîæ‰ºöË≠∞‰∏≠...</p>
                                    <button onClick={() => { setTimeLeft(0); startVoteSelect(); }} className="bg-red-600 w-full py-6 rounded-2xl font-bold shadow-lg text-3xl hover:bg-red-500 transition">ÊäïÁ•®„Å∏</button>
                                </div>
                            )}

                            {phase === 'VOTE_SELECT' && (
                                <div className="flex-grow flex flex-col h-full">
                                    <h3 className="text-center text-red-400 mb-6 font-bold text-2xl flex-none">ËøΩÊîæ„Åô„Çã„Éó„É¨„Ç§„É§„Éº„ÇíÈÅ∏Êäû</h3>
                                    <div className="grid grid-cols-2 gap-4 overflow-y-auto flex-grow mb-4 pr-1">
                                        {players.filter(p => !p.isDead && p.id !== activePlayerId).map(p => (
                                            <button key={p.id} onClick={()=>handleVote(p.id)} className="bg-slate-800 border-4 border-slate-600 active:bg-red-900/50 p-4 rounded-2xl font-bold text-2xl h-36 flex items-center justify-center shadow-lg hover:border-red-500 transition overflow-hidden relative">
                                                {/* ËÉåÊôØÁîªÂÉè */}
                                                {/* <div className="absolute inset-0 opacity-30">
                                                    <img src={ROLES[p.roleKey].img} className="w-full h-full object-cover grayscale" onError={(e) => e.target.style.display = 'none'} />
                                                </div> */}
                                                <span className="relative z-10 drop-shadow-lg">{p.name}</span>
                                            </button>
                                        ))}
                                    </div>
                                    <button onClick={()=>handleVote(null)} className="w-full bg-slate-700 py-5 rounded-xl font-bold text-slate-300 flex-none text-xl hover:bg-slate-600 transition">„Çπ„Ç≠„ÉÉ„Éó</button>
                                </div>
                            )}

                            {/* ËøΩÂä†: ÊäïÁ•®ÂÆå‰∫ÜÂæå„ÅÆÂæÖÊ©üÁîªÈù¢ */}
                            {phase === 'EXILE_READY' && (
                                <div className="h-full flex flex-col justify-center items-center text-center p-4">
                                    <h2 className="text-3xl font-bold mb-8 text-white">ÊäïÁ•®„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü</h2>
                                    <p className="text-xl text-slate-300 mb-10">‰ºöË≠∞„ÅÆÁµêÊûú„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                                    <button onClick={() => setPhase('EXILE_RESULT')} className="bg-blue-600 hover:bg-blue-500 text-white px-12 py-6 rounded-2xl font-bold text-2xl shadow-lg animate-pulse">
                                        ‰ºöË≠∞ÁµêÊûú„ÇíË¶ã„Çã
                                    </button>
                                </div>
                            )}

                            {/* ËøΩÂä†: ËøΩÊîæÁµêÊûúÁîªÈù¢ */}
                            {phase === 'EXILE_RESULT' && exileResult && (
                                <div className="h-full flex flex-col justify-center items-center text-center p-4">
                                    <h2 className="text-3xl font-black mb-6 text-red-500 border-b-4 border-red-900 pb-2">ËøΩÊîæÁµêÊûú</h2>
                                    
                                    {exileResult.banished ? (
                                        <div className="bg-slate-800 p-4 rounded-2xl border-2 border-red-600 shadow-2xl w-full max-w-md mb-4 animate-fadeIn">
                                            <p className="text-xl text-slate-300 mb-4">ËøΩÊîæ„Åï„Çå„Åü„ÅÆ„ÅØ...</p>
                                            <div className="w-32 h-32 mx-auto rounded-full overflow-hidden border-4 border-red-500 mb-4 shadow-lg relative">
                                                <img src={ROLES[exileResult.banished.roleKey].img} className="w-full h-full object-cover" />
                                                <div className="absolute inset-0 bg-red-900/30 mix-blend-multiply"></div>
                                            </div>
                                            <h3 className="text-3xl font-black text-white mb-2">{exileResult.banished.name}</h3>
                                            <div className="space-y-2 bg-slate-900/50 p-3 rounded-xl mt-4">
                                                <div className="flex justify-between border-b border-slate-700 pb-1">
                                                    <span className="text-slate-400">ËÅ∑Ê•≠</span>
                                                    <span className="font-bold text-yellow-400 text-xl">{exileResult.banished.roleName}</span>
                                                </div>
                                                <div className="flex justify-between pt-1">
                                                    <span className="text-slate-400">Ê≠£‰Ωì</span>
                                                    <span className={`font-black text-2xl ${exileResult.banished.realTeam === 'HERO' ? 'text-blue-400' : 'text-red-500'}`}>
                                                        {exileResult.banished.realTeam === 'HERO' ? 'ÂãáËÄÖÈô£Âñ∂' : 'È≠îÁéãÈô£Âñ∂'}
                                                    </span>
                                                </div>
                                            </div>
                                            <p className="mt-4 text-red-300 font-bold text-lg">ËøΩÊîæ„Åï„Çå„Åæ„Åó„Åü„ÄÇ</p>
                                        </div>
                                    ) : (
                                        <div className="bg-slate-800 p-8 rounded-2xl border-2 border-slate-600 shadow-xl w-full max-w-md mb-8">
                                            <div className="text-6xl mb-4">üïäÔ∏è</div>
                                            <h3 className="text-2xl font-bold text-white mb-4">ËøΩÊîæËÄÖ„Å™„Åó</h3>
                                            <p className="text-slate-300 text-lg">{exileResult.message}</p>
                                        </div>
                                    )}

                                    <button onClick={() => startNewTurn(window.tempClearedIds || [])} className="bg-green-600 hover:bg-green-500 text-white px-16 py-5 rounded-xl font-bold text-2xl shadow-lg transition">
                                        Ê¨°„ÅÆÊó•„Å∏
                                    </button>
                                </div>
                            )}

                            {phase === 'BOSS_INTRO' && (
                                <div className="text-center py-10 flex flex-col items-center justify-center h-full">
                                    <div className="w-48 h-48 mb-6 animate-pulse">
                                        <img src={IMAGES.BOSS} className="w-full h-full object-contain drop-shadow-2xl" onError={(e) => e.target.style.display = 'none'} />
                                    </div>
                                    <h2 className="text-6xl font-black text-purple-500 mb-6 animate-bounce">È≠îÁéãÊà¶ ÈñãÂßã</h2>
                                    <p className="mb-10 text-xl text-slate-300 font-bold">3„É©„Ç¶„É≥„ÉâËÄê„Åà„Çç„ÄÇ<br/>Ë£èÂàá„ÇäËÄÖ„ÅØÂë≥Êñπ„ÇíÊîªÊíÉÂèØËÉΩ„ÄÇ</p>
                                    <button onClick={startBossBattleRound} className="bg-purple-600 text-white px-16 py-6 rounded-full text-3xl font-bold shadow-lg hover:bg-purple-500 transition transform hover:scale-105">Êà¶ÈóòÈñãÂßãÔºÅ</button>
                                </div>
                            )}

                            {phase === 'BOSS_ACTION_ANNOUNCE' && (
                                <div className="text-center py-10 flex flex-col items-center justify-center h-full">
                                    {/* Â§âÊõ¥ÁÇπ: ÈùôÊ≠¢Áîª„Åß„ÅØ„Å™„Åè„ÄÅË°åÂãï„Å´Âøú„Åò„ÅüÁîªÂÉè„ÇíË°®Á§∫ */}
                                    <div className="w-64 h-64 mb-6"> {/* „Çµ„Ç§„Ç∫„ÇíÂ∞ë„ÅóÂ§ß„Åç„ÅèË™øÊï¥ */}
                                        <img src={IMAGES[bossNextAction?.imgKey]} alt={bossNextAction?.name} className="w-full h-full object-contain drop-shadow-2xl animate-bounce" onError={(e) => e.target.style.display = 'none'} />
                                    </div>
                                    <h2 className="text-4xl font-black text-red-500 mb-4">È≠îÁéã„ÅÆË°åÂãï</h2>
                                    
                                    <div className="bg-slate-800/90 border-4 border-red-600 p-8 rounded-2xl mb-10 text-center shadow-red-900/50 shadow-lg w-full max-w-lg">
                                        <div className="text-xl text-red-400 font-bold mb-2">‰∫àÂÖÜ</div>
                                        <div className="text-5xl font-black text-white mb-4">{bossNextAction?.name}</div>
                                        <div className="text-2xl text-slate-300">{bossNextAction?.desc}</div>
                                        <div className="text-xl text-orange-400 font-bold mt-4 bg-slate-900/50 p-2 rounded">
                                            {getBossActionDetail(bossNextAction, bossInitialPlayerCount)}
                                        </div>
                                    </div>

                                    <p className="text-slate-400 mb-6 text-lg">ÂÖ®Âì°„ÅßÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                                    <button onClick={proceedToBossPlayerSelect} className="bg-blue-600 text-white px-16 py-5 rounded-full text-3xl font-bold shadow-lg hover:bg-blue-500 transition transform hover:scale-105">
                                        Ë°åÂãïÈñãÂßã
                                    </button>
                                </div>
                            )}

                            {phase === 'BOSS_SELECT' && (
                                <div className="h-full flex flex-col justify-center items-center relative">
                                    {/* È≠îÁéãÁîªÂÉèËÉåÊôØ (ÂâäÈô§) */}
                                    {/* <div className="absolute top-0 left-1/2 transform -translate-x-1/2 w-64 h-64 opacity-10 pointer-events-none">
                                        <img src={IMAGES.BOSS} className="w-full h-full object-contain" />
                                    </div> */}

                                    <h3 className="text-3xl font-bold text-center text-red-500 mb-12 relative z-10">Ë°åÂãï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
                                    <button onClick={handleBossTurnStart} className="bg-blue-600 text-white w-full py-8 rounded-3xl font-bold text-4xl shadow-xl animate-pulse hover:bg-blue-500 transition relative z-10">
                                        Ë°åÂãï„ÇíÈÅ∏Êäû„Åô„Çã
                                    </button>
                                </div>
                            )}

                            {phase === 'BOSS_RESULT' && (
                                <div className="h-full flex flex-col bg-slate-800 rounded-xl border border-slate-600 overflow-hidden shadow-2xl relative">
                                    {/* È≠îÁéãÁîªÂÉèËÉåÊôØ */}
                                    <div className="absolute right-0 top-0 w-32 h-32 opacity-10 pointer-events-none">
                                        <img src={IMAGES.BOSS} className="w-full h-full object-contain" />
                                    </div>
                                    <h3 className="text-2xl font-bold text-center py-4 border-b border-slate-600 bg-slate-800 flex-none">„É©„Ç¶„É≥„ÉâÁµêÊûú</h3>
                                    <div className="flex-grow overflow-y-auto p-6 text-lg space-y-3 bg-slate-900/50 relative z-10">
                                        {bossBattleLog.map((log, i) => (
                                            <div key={i} className={`border-b border-slate-700/30 pb-2 ${log.type === 'info' ? 'text-blue-300 font-bold mt-4 pt-2 border-t border-slate-600 text-xl' : log.type === 'success' ? 'text-green-400 font-bold' : ''}`}>
                                                {log.type === 'damage' ? (
                                                    <span>{log.text.split(/(\d+)/).map((part, idx) => /\d+/.test(part) ? <span key={idx} className="text-orange-400 font-black text-2xl">{part}</span> : part)}</span>
                                                ) : log.type === 'death' ? (
                                                    <span className="text-red-500 font-black text-xl">{log.text}</span>
                                                ) : (
                                                    <span>{log.text}</span>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                    
                                    {/* „ÉÄ„É°„Éº„Ç∏ÈõÜË®àË°®Á§∫ */}
                                    <div className="bg-slate-900/80 p-4 relative z-10 border-t border-slate-600">
                                        <h4 className="text-center text-yellow-400 font-bold mb-2 text-sm">--- ‰ªä„É©„Ç¶„É≥„Éâ„ÅÆÈ≠îÁéã„Å∏„ÅÆ„ÉÄ„É°„Éº„Ç∏ ---</h4>
                                        <div className="grid grid-cols-2 gap-2 text-xs">
                                            {Object.entries(roundDamageReport).length > 0 ? (
                                                Object.entries(roundDamageReport)
                                                    .sort(([, a], [, b]) => b - a)
                                                    .map(([pid, dmg]) => {
                                                        const p = players.find(pl => pl.id === parseInt(pid));
                                                        return (
                                                            <div key={pid} className="flex justify-between items-center bg-slate-800 p-1.5 rounded border border-slate-700">
                                                                <span className="font-bold text-white truncate">{p?.name}</span>
                                                                <span className="font-black text-orange-400 text-base">{dmg}</span>
                                                            </div>
                                                        );
                                                    })
                                            ) : (
                                                <div className="col-span-2 text-center text-slate-500">„ÉÄ„É°„Éº„Ç∏„Å™„Åó</div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="p-6 border-t border-slate-600 bg-slate-800 flex-none relative z-10">
                                        <button onClick={nextBossRound} className="w-full bg-blue-600 text-white py-5 rounded-xl font-bold shadow-lg text-2xl hover:bg-blue-500 transition">
                                            Ê¨°„ÅÆ„É©„Ç¶„É≥„Éâ„Å∏
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
